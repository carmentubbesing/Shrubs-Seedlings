---
title: "simulations_plot"
author: "Carmen"
date: "2/13/2020"
output: 
  html_document:
    toc: TRUE
---

```{r}
name <- "1_2020-04-07_1000_empirical_empirical_empiricalcoef_empiricalgrowth_empiricalindex"
df_filename <- paste("~/Simulation", name, ".Rdata", sep = "")
load(df_filename)
strt <- Sys.time()
```

```{r}
setwd("~/Shrubs-Seedlings/code/Simulations/")
```

```{r, include = F}
require(tidyverse)
require(gridExtra)
```

# Take out trees with non-finite or NA pred because they had already emerged and things got wacky
```{r}
dfsimallreps %>% 
  filter(!is.finite(pred_exp) | is.na(pred_exp)) %>% 
  group_by(emerged) %>% 
  count()
```

```{r}
dfsimallreps <- dfsimallreps %>% 
  filter(is.finite(pred_exp) & !is.na(pred_exp))
```


# Plot how many trees emerge above the shrub canopy each year

## How many trees are neither emerged nor dead at the end? Should be none.
```{r}
dfsimallreps %>% 
  filter(Years == max(Years)) %>% 
  group_by(emerged, Species) %>% 
  count()
```

# Summarize
```{r}
summary_emerge <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n) %>% 
  mutate(Species = fct_relevel(Species, "PIPO", "ABCO"))
```



# Plot emergents per year 

## Counts

```{r}
plot_emerge_count <- ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = total_emergents, fill = Species), alpha = .8, outlier.shape = NA)+
  ylab("Number of emerged trees")+
  xlab("Years since fire")+
  scale_x_discrete(breaks =c("10","20","30", "40"))+
  theme_bw()+
    theme(text = element_text(size = 11), 
        legend.title = element_blank(),
        legend.text=element_text(size=11),
        legend.position = "none")
plot_emerge_count
filename <- paste("../../results/figures/Simulations/base_count_boxplot", name, ".png", sep = "")
ggsave(file = filename, width = 5, height =4, dpi = 400)
```

## Proportions

```{r}
plot_emerge_prop <- ggplot(summary_emerge)+
  geom_boxplot(aes(x = as.factor(Years), y = prop_emerged, fill = Species), alpha = .8, outlier.shape = NA)+
  ylab("Proportion of initial trees that have emerged")+
  xlab("Years since fire")+
  scale_x_discrete(breaks =c("10","20","30", "40"))+
  theme_bw()+
  theme(text = element_text(size = 11), 
        legend.title = element_blank(),
        legend.text=element_text(size=11),
        legend.position = c(0.7, 0.2))+
  scale_fill_discrete(labels = c( "Ponderosa pine", "White fir"))

plot_emerge_prop
filename <- paste("../../results/figures/Simulations/base_prop_boxplot", name, ".png", sep = "")
ggsave(file = filename, width = 5, height =4, dpi = 400)
```


# Plot Q50 

# 

## Summarize with means
```{r}
summary_emerge <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n) %>% 
  group_by(Years, Species) %>% 
  summarize(mean = mean(prop_emerged), sd = sd(prop_emerged))
```

## Calculate bounds
```{r}
Q50 <- summary_emerge %>% 
  mutate(dist50 = mean-.5) %>% 
  filter(dist50>0) %>%
  ungroup() %>% 
  group_by(Species) %>% 
  filter(dist50 == min(dist50)) %>% 
  mutate(bound = "mean")

Q50_ub <- summary_emerge %>% 
  mutate(lowerdist50 = mean-sd-.5) %>% 
  filter(lowerdist50>0) %>%
  ungroup() %>% 
  group_by(Species) %>% 
  filter(lowerdist50 == min(lowerdist50)) %>% 
  mutate(bound = "upper")

Q50_lb <- summary_emerge %>% 
  mutate(upperdist50 = mean+sd-.5) %>% 
  filter(upperdist50>0) %>%
  ungroup() %>% 
  group_by(Species) %>% 
  filter(upperdist50 == min(upperdist50)) %>% 
  mutate(bound = "lower")
```

## Reformat table
```{r}
Q50 <- full_join(Q50, Q50_lb) 
Q50 <- full_join(Q50, Q50_ub) 

Q50 <- Q50 %>% 
  dplyr::select(Years, Species, bound) 

Q50 <- pivot_wider(Q50, names_from = bound, values_from = Years) %>% 
  dplyr::select(Species, lower, mean, upper)

Q50
```

# Plot on a per-area basis

Each plot in Welch's data was 60 m^2. Across 15 plots, that's 900 square meters. He found 67 seedlings. So 200 seedlings is 900*(200/67) square meters

```{r}
area <-  900*(200/67)
```


```{r}
load("../../results/coefficients/welch_ratios.Rdata")
welch_shrspp %>% 
  group_by(Species) %>% 
  summarize(sum(sum))
```

```{r}
counts <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  mutate() %>% 
  filter(Years == min(Years)) %>% 
  ungroup() %>% 
  group_by(Species, total) %>% 
  count() %>% 
  ungroup() 

counts %>% 
  ggplot()+
  geom_point(aes(x = total, y = n, col = Species))+
  geom_line(aes(x = total, y = n, group = Species, col = Species))+
  theme_bw()

counts %>% 
  group_by(Species) %>% 
  filter(n == max(n))
```

Good, this shows that my ratios match Welch's ratios. It's a coincidence that he found 200 seedlings and I used 200 seedlings as my n_seedlings value. So my starting area will be the same as the total of the Welch plot area, which is 60 m^2 * 15 plots = 900 m^2.

```{r}
summary_emerge <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n) %>% 
  mutate(Species = fct_relevel(Species, "PIPO", "ABCO")) %>% 
  mutate(density = total_emergents/area)
```

```{r}
plot_emerge_density <- ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = density, fill = Species), alpha = .8, outlier.shape = NA)+
  ylab("Density of emerged trees per m^2")+
  xlab("Years since fire")+
  scale_x_discrete(breaks =c("10","20","30", "40"))+
  theme_bw()+
    theme(text = element_text(size = 11), 
        legend.title = element_blank(),
        legend.text=element_text(size=11),
        legend.position = "none")
plot_emerge_density
filename <- paste("../../results/figures/Simulations/base_density_boxplot", name, ".png", sep = "")
ggsave(file = filename, width = 5, height =4, dpi = 400)
```

# Plot the way I plotted the species ones

## Summarize
```{r}
summary_emerge_prop <- dfsimallreps %>% 
  group_by(Years, rep, Species) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n) %>% 
  group_by(Years, Species) %>% 
  summarize(mean = mean(prop_emerged), sd = sd(prop_emerged))
```

### Filter out the flat parts - take out years if they differ by <0.001 (0.1%)
```{r}
max_year <- summary_emerge_prop %>% 
  mutate(mean = round(mean, 3)) %>% 
  group_by(Species) %>% 
  mutate(maxmean = max(mean)) %>% 
  filter(mean == maxmean) %>% 
  ungroup() %>%
  group_by(Species) %>% 
  filter(Years == min(Years)) %>%
  ungroup() %>% 
  filter(Years ==max(Years)) %>% 
  select(Years) %>% 
  unlist()

max_year
```

```{r}
summary_emerge_prop <- summary_emerge_prop %>% 
  filter(Years < max_year + 2)
```


## Save prop summary
```{r}
save(summary_emerge_prop, file = "../../results/data/summary_emerge_prop_base.Rdata")
```


## Plot 
```{r}
ggplot(summary_emerge_prop)+
  theme_bw()+
  geom_line(aes(x = Years, y = mean, col = Species, group = Species, linetype = Species), size = 1)+
  geom_ribbon(aes(x = Years, ymin = mean-sd, ymax = mean+sd, fill = Species, group = Species), alpha = .3)+
  ylab("Proportion of initial trees that have emerged")+
  xlab("Years since fire")+
  theme(legend.position = c(0.75, 0.3))+
   scale_fill_manual(values = c( "#899DA4", "#9A8822"), 
                                labels = c("White fir", "Ponderosa pine"))+

  scale_color_manual(values = c("#899DA4", "#9A8822"), 
                                   labels = c("White fir", "Ponderosa pine"))+

  scale_linetype_discrete(     labels = c("White fir", "Ponderosa pine"))+

  
  theme(text = element_text(size = 11), 
        
        legend.title = element_blank(),
        legend.spacing=unit(0, "cm"),
        legend.text=element_text(size=10),
        legend.margin = margin(0, 0, 0, 0)
        )+
  xlab(element_blank())+
  xlim(9,max(summary_emerge$Years))+
  ylim(c(0,1))
filename <- paste("../../results/figures/Simulations/base_prop_line", name, ".png", sep = "")
ggsave(file = filename, width = 5, height =4, dpi = 400)
```


```{r}
summary_emerge_density <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n) %>% 
  mutate(density = total_emergents/900) %>% 
   group_by(Years, Species) %>% 
  summarize(mean = mean(density), sd = sd(density))
```

## Density
```{r}
summary_emerge_density <- summary_emerge_density %>% 
  filter(Years < max_year + 2)
```


## Save density summary
```{r}
save(summary_emerge_density, file = "../../results/data/summary_emerge_density_base.Rdata")
```

```{r}
ggplot(summary_emerge_density)+
  theme_bw()+
  geom_line(aes(x = Years, y = mean, col = Species, group = Species, linetype = Species), size = 1)+
  geom_ribbon(aes(x = Years, ymin = mean-sd, ymax = mean+sd, fill = Species, group = Species), alpha = .3)+
  
  xlab("Years since fire")+
  theme(legend.position = c(0.75, 0.3))+
    ylab("Density of emerged trees per m^2")+
  scale_fill_manual(values = c( "#899DA4", "#9A8822"), 
                                labels = c("White fir", "Ponderosa pine"))+

  scale_color_manual(values = c("#899DA4", "#9A8822"), 
                                   labels = c("White fir", "Ponderosa pine"))+

  scale_linetype_discrete(     labels = c("White fir", "Ponderosa pine"))+

  
  theme(text = element_text(size = 11), 
        
        legend.position = "none"
        )

filename <- paste("../../results/figures/Simulations/base_density_line", name, ".png", sep = "")
ggsave(file = filename, width = 5, height =4, dpi = 400)
```

