---
title: "Growth_mort"
author: "Carmen"
date: "October 31, 2019"
output: 
  html_document:
    toc: TRUE
---

# Next step: Consider adding CEIN to the initialization even though there isn't any in the American River footprint

# This script runs simulations with the most up-to-date functions

```{r, include = F}
setwd("~/Shrubs-Seedlings/code/Simulations/")
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(sp)
require(tmaptools)
require(knitr)
require(mgcv)
strt <- Sys.time()
```

# Define parameters
```{r}
fire <- "AMRC"
year <- "2016"
years <- 19
iterations <- 5
max_shrub_ht_cm <- 250
max_shrub_ht_years <- 15
n_seedlings <- 100
length_m <- 40
height_m <- 40
lambda <- 4
shrub_clumpiness <- 7
```

# Load functions

#### Create shrub patch
```{r}
source("functions/shrubclump.R")
```

#### Initialization function
```{r}
source("functions/initialize.R")
```

#### Height growth functions
```{r}
source("functions/abcogrowth.R")
source("functions/pipogrowth.R")
```

#### Diameter growth functions
```{r}
source("functions/abcodia.R")
source("functions/pipodia.R")
```

#### Mortality functions
```{r}
source("functions/abcomort.R")
source("functions/pipomort.R")
```

#### Shrub growth functions
```{r}
source("functions/abco_shrubgrowth.R")
source("functions/pipo_shrubgrowth.R")
```

#### Simulation function
```{r}
source("functions/sim.R")
```

#### Iteration function
```{r}
source("functions/iterate.R")
```

# Initialize

## Create clumped shrub pattern
```{r}
shrubclump()
plot(r)
```

## Randomly select seedlings from data and place them on the shrub patch
```{r}
initialize()
```

## Plot patch with seedlings
```{r}
max_shrub <- max(r@data@attributes[[1]]$sqrt_shrubarea3)
r@data@attributes[[1]]$shrub_rel <- r@data@attributes[[1]]$sqrt_shrubarea3/max_shrub
```

```{r}
pts.sf.pipo.graph <- pts.sf.pipo %>% 
  rename("Pine height" = Ht_cm1)
pts.sf.abco.graph <- pts.sf.abco %>% 
  rename("Fir height" = Ht_cm1)
```

```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(col = "sqrt_shrubarea3", title = "Shrub competition index", palette = "Greys", alpha = .5)+
tm_shape(r)+
  tm_raster(col = "ShrubSpp03", alpha = .2, title = "Shrub species", palette = "Set1")+
  tm_layout(asp=1:1, legend.outside = T)+
tm_shape(pts.sf.pipo.graph)+
  tm_symbols(size = "Pine height", col = "darkgreen", size.max = 500, border.col = "white", border.lwd = .05)+
tm_shape(pts.sf.abco.graph)+
  tm_symbols(size = "Fir height", col = "darkblue", size.max = 500, border.col = "white", border.lwd = .05)
```

# Simulate across years
```{r, warning=FALSE}
time <- Sys.time()
suppressMessages(sim(years))
print(paste("One simulation run took", Sys.time()-time, "seconds"))
```

## Tests

### Shrub growth patterns
```{r}
ggplot(dfsimall %>% filter(Species == "ABCO"))+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, group = Sdlg))+
  theme_bw()
```

```{r}
ggplot(dfsimall %>% filter(Species == "PIPO"))+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, group = Sdlg))+
  theme_bw()
```

### Diameter growth patterns
```{r}
ggplot(dfsimall, aes(x = Years, y = dia.cm, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

### Height growth patterns
```{r}
ggplot(dfsimall, aes(x = Years, y = Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))
```

### Diameter::Height growth patterns
```{r}
ggplot(dfsimall, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Species))
```

### Diameter:height
```{r}
ggplot(dfsimall %>% filter(Years==10))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 5))
```

### Diameter and height boxplots
```{r}
ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  theme(text = element_text(size = 20))+
  ylim(c(0,100))+
  ggtitle("Diameter distribution after first simulation year")
```

#### Just for first 2 years of the simulation
```{r}
ggplot(dfsimall %>% filter(Years<11))+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  theme(text = element_text(size = 20))
```

Note: use 3 cm as the diameter cutoff for where I switch to a different equation

```{r}
ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  theme(text = element_text(size = 20))

```

## Plot shrub patch spatially
```{r}
pts.sf.pipo.graph <- pts.sf.pipo %>% 
  rename("Pine height (cm)" = Ht_cm1)
pts.sf.abco.graph <- pts.sf.abco %>% 
  rename("Fir height (cm)" = Ht_cm1)
```

```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(col = "sqrt_shrubarea3", title = "Shrub competition index", palette = "Greys", alpha = .5)+
tm_shape(r)+
  tm_raster(col = "ShrubSpp03", alpha = .7, title = "Shrub species", palette = "Pastel1")+
  tm_layout(asp=1:1, legend.outside = T, legend.title.size = 4, legend.text.size = 2)+
tm_shape(pts.sf.pipo.graph)+
  tm_symbols(size = "Pine height (cm)", col = "#DCC960", size.max = 300, border.lwd = 3)+
tm_shape(pts.sf.abco.graph)+
  tm_symbols(size = "Fir height (cm)", col = "#899DA4", size.max = 300, border.lwd = 3)
```

# Iterate 
```{r, warning=FALSE}
time <- Sys.time()
iterate(iterations)
print(paste("That took", round(Sys.time()-time, 1), "minutes"))
dfsimallreps %>% 
  group_by(rep) %>% 
  summarize(mean(Ht_cm1))
```

# Summarize

## Height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>%
  mutate(rep = as.factor(paste(rep))) %>% 
  group_by(rep, Years, Species) %>% 
  mutate(mean_ht_years = mean(Ht_cm1))
dfsimallreps_summary %>% dplyr::select(rep, Years, mean_ht_years) %>% summary()
```

```{r}
ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = mean_ht_years, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = mean_ht_years, group = Species, col = Species), size = 1)+
  ggtitle("Results for 1000 simulations")+
  xlab("Years since fire")+
  ylab("Average tree ht (cm) by simulation")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ggsave(file = "../../results/figures/Simulations/sim_1000_hts.png", width = 6, height =4, dpi = 400)
```

## Height by year and species

### Shrub growth patterns
```{r}
ggplot(dfsimallreps_summary %>% filter(Species == "ABCO"))+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, group = Sdlg))+
  theme_bw()
```

```{r}
ggplot(dfsimallreps_summary %>% filter(Species == "PIPO"))+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, group = Sdlg))+
  theme_bw()
```

### Diameter growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = dia.cm, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

#### For a single tree
```{r}
ggplot(dfsimallreps %>% filter(Sdlg == 244))+
  geom_line(aes(x = Years, y = dia.cm))
```

```{r}
ggplot(dfsimallreps %>% filter(Sdlg == 244))+
  geom_line(aes(x = Years, y = Ht_cm1))
```

#### Plot the relationships between variables inputting the diameter growth equations to compare them to what I saw in the dendro analysis
```{r}
test <- dfsimallreps %>% 
  filter(Years %in% c(19,20)) %>% 
  dplyr::select(Sdlg, Species, Ht_cm1, dia.cm, Years, pred_exp, rep, ID_withinrep) %>% 
  tbl_df() %>% 
  arrange(Sdlg)
test
test <- test %>% 
  mutate(ID = paste(Sdlg, rep, ID_withinrep, sep = "-"))
test %>% 
  arrange(ID)
test2 <- pivot_wider(test, names_from = "Years", values_from = "dia.cm", id_cols = "ID")
test2 %>% 
  arrange(ID)

test2 <- test2 %>% 
  rename(dia.cmYear19 = `19`, dia.cmYear20 = `20`)

ggplot(test2)+
  geom_point(aes(x = dia.cmYear19, y = dia.cmYear20))+
  geom_abline(aes(slope = 1, intercept = 0))+
  theme_minimal()+
  ylim(0,20)+
  xlim(0,20)
```

### Height growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))+
  ylim(0,300)
```

### Diameter::Height growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  ylim(0,.2)
```

### Diameter:height
```{r}
ggplot(dfsimallreps_summary %>% filter(Years==10))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))
ggplot(dfsimallreps_summary %>% filter(Years==20))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))
```

### Diameter and height boxplots
```{r}
ggplot(dfsimallreps_summary)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))+
  ylim(c(0,100))
```

```{r}
ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))

```


## Counts by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Species) %>% 
  mutate(count = n()) %>% 
  mutate(count = as.numeric(count))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = count, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = count, fill = Species, col = Species), size = 1)+
  ggtitle("Results for 1000 simulations")+
  xlab("Years since fire")+
  ylab("Tree count")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ggsave(file = "../../results/figures/Simulations/sim_1000_count.png", width = 6, height = 4, dpi = 400)
```

## Shrub height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Ht1.3, ShrubSpp03) %>% 
  mutate(mean_shrub_ht = mean(Ht1.3))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_ht, group = ShrubSpp03, col = ShrubSpp03))+
  geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle("Results for 1000 simulations")+
  xlab("Years since fire")+
  ylab("Shrub height")+
  theme_bw()
```

```{r}
print(Sys.time() - strt)
```

# Seedling height by shrub species and year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Species, rep, Years, Ht_cm1, ShrubSpp03) %>% 
  mutate(mean_ht = mean(Ht_cm1))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = Ht_cm1, group = ShrubSpp03, col = ShrubSpp03, symbol = Species))+
  geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle("Results for 1000 simulations")+
  xlab("Years since fire")+
  ylab("Focal tree height")+
  theme_bw()
```


# Next steps to improve the model

1.  Use Kristen's data or Hugh's data for initial conditions
2.  Improve dispersal kernel based on Kristen/Hugh's data 
3.  Improve shrub growth based on data - DONE
4.  Include residual surviving trees and their seed dispersal
5.  Include seed dispersal of post-fire regen once it reaches reproductive age 
6.  Add customization of patch size and shape
7.  Add customization of whether the weather conditions reflect those of 2015, 2016, or 2017
8.  Change sapling growth equations once they emerge from the shrub canopy


For next week:

1.  Update display of shrub competition after simulation years
2. See if there's a way to increase R2 of the dendro diameter growth equations
3. double check the math on the dendro diameter data wrangling
6.  Add 0/1 for "emergent year" = when 50% of trees are above shrub canopy
7.  apply to King, American River Complex, rest of the fires I measured
8.  Add diameter equation for larger seedlings -- make it so that the diameter equation being used is different for smaller seedlings vs. larger seedlings

Other notes:

1.  maybe submit to American Naturalist
2.  Global Change Biology - mixing up the years
3.  no overstory reproduction for now 
5.  what does shrub competition mean for new recruitment?

