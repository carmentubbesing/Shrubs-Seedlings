---
title: "Growth_mort"
author: "Carmen"
date: "October 31, 2019"
output: 
  html_document:
    toc: TRUE
---

# This script runs simulations with the most up-to-date functions

```{r, include = F}
setwd("~/Shrubs-Seedlings/code/Simulations/")
pkgs <- c("raster", "tidyverse", "tmap", "sf", "sp", "tmaptools", "knitr", "mgcv", "gridExtra", "doParallel")
lapply(pkgs, require, character.only = T)
strt <- Sys.time()
```

#### Iteration function
```{r}
print(Sys.time())
source("functions/iterate.R")
```

# Define iterations
```{r}
iterations <- 50
```

# Define length of simulation
```{r}
years_max <<- 40
```

# Iterate 
```{r, warning=FALSE}
time <- Sys.time()
iterate(iterations)
print(paste("That took", round(Sys.time()-time, 1), "minutes"))
```

# Test years
```{r}
dfsimallreps %>% group_by(rep, Species) %>% filter(Years == max(Years)) %>% group_by(rep,Years,Species) %>% count()
```

# Filter out years in which nothing happens
```{r}
max_year <- dfsimallreps %>% 
  group_by(Years, emerged) %>% 
  summarize(sum_emerged = sum(emerged)) %>% 
  filter(emerged ==0) %>% 
  ungroup() %>% 
  summarize(max_year = max(Years)) %>% 
  unlist()
```

```{r}
dfsimallreps <- dfsimallreps %>% 
  filter(Years < max_year+2)
```

# Save results
```{r}
save(dfsimallreps, file = paste("../../results/data/Simulations",  Sys.Date(), iterations, ".Rdata", sep = "_"))
```

# Summarize

## Height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>%
  mutate(rep = as.factor(paste(rep))) %>% 
  group_by(rep, Years, Species) %>% 
  mutate(mean_ht_years = mean(Ht_cm1))
```

```{r}
ht <- ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = mean_ht_years, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = mean_ht_years, group = Species, col = Species), size = 1)+
  xlab("Years since fire")+
  ylab("Average tree ht (cm) by simulation")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ht
filename <- paste("../../results/figures/Simulations/hts_sim", iterations, Sys.Date(), ".png", sep = "_")
ggsave(file = filename, width = 6, height =4, dpi = 400)
```

#### Shrub growth patterns
```{r}
ggplot(dfsimallreps_summary)+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, group = Sdlg))+
  theme_bw()
```

### Diameter growth patterns 
```{r}
ggplot(dfsimallreps)+
  #geom_line(aes(x = Years, y = dia.cm, col = Species, group = interaction(rep, ID_withinrep)), alpha = .1)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

#### For a single tree
```{r}
tree244dia <- ggplot(dfsimallreps %>% filter(Sdlg == 244 & rep == 1))+
  geom_line(aes(x = Years, y = dia.cm))+
  theme_minimal()
```

```{r}
tree244ht <- ggplot(dfsimallreps %>% filter(Sdlg == 244 & rep ==1))+
  geom_line(aes(x = Years, y = Ht_cm1))+
  theme_minimal()
```

```{r}
grid.arrange(tree244dia, tree244ht, ncol = 2)
```

#### Plot the relationships between variables inputting the diameter growth equations to compare them to what I saw in the dendro analysis
```{r}
test <- dfsimallreps %>% 
  filter(Years %in% c(19,20)) %>% 
  dplyr::select(Sdlg, Species, Ht_cm1, dia.cm, Years, pred_exp, rep, ID_withinrep) %>% 
  tbl_df() %>% 
  arrange(Sdlg)
test <- test %>% 
  mutate(ID = paste(Sdlg, rep, ID_withinrep, sep = "-"))

test2 <- pivot_wider(test, names_from = "Years", values_from = "dia.cm", id_cols = "ID")

test2 <- test2 %>% 
  rename(dia.cmYear19 = `19`, dia.cmYear20 = `20`)

ggplot(test2)+
  geom_point(aes(x = dia.cmYear19, y = dia.cmYear20))+
  geom_abline(aes(slope = 1, intercept = 0))+
  theme_minimal()+
  ylim(0,20)+
  xlim(0,20)
```

### Height growth patterns
```{r}
ggplot(dfsimallreps, aes(x = Years, y = Ht_cm1, col = Species, group = interaction(rep, ID_withinrep)))+
  #geom_line(alpha = .1)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))
```

### Diameter::Height growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = interaction(rep, ID_withinrep)))+
  #geom_line(alpha = .1)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Species))
```

### Diameter:height at years 10 and 20
```{r}
yr10 <- ggplot(dfsimallreps_summary %>% filter(Years==10))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))+
  theme_minimal()+
  ggtitle("Year 10")
yr20 <- ggplot(dfsimallreps_summary %>% filter(Years==20))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))+
  theme_minimal()+
  ggtitle("Year 20")
grid.arrange(yr10, yr20, ncol = 2)
```

### Diameter and height boxplots
```{r}
diabox <- ggplot(dfsimallreps_summary)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))
```

```{r}
htbox <- ggplot(dfsimallreps)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))
```

```{r}
grid.arrange(diabox, htbox)
```

## Counts by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Species) %>% 
  mutate(count = n()) %>% 
  mutate(count = as.numeric(count))
```

```{r}
title <- paste("Results for", iterations, "simulations", sep = " ")
title
ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = count, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = count, fill = Species, col = Species), size = 1)+
  ggtitle(title)+
  xlab("Years since fire")+
  ylab("Tree count")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ggsave(file = "../../results/figures/Simulations/sim_100_count.png", width = 6, height = 4, dpi = 400)
```

## Shrub height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Ht1.3, Cov1.3, ShrubSpp03) %>% 
  mutate(mean_shrub_ht = mean(Ht1.3), mean_shrub_cov = mean(Cov1.3))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_ht, group = ShrubSpp03, col = ShrubSpp03))+
  #geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle(paste("Results for", iterations, "simulations", sep = " "))+
  xlab("Years since fire")+
  ylab("Shrub height")+
  theme_bw()
```

## Shrub cover by year
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_cov, group = ShrubSpp03, col = ShrubSpp03))+
  #geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle(paste("Results for", iterations, "simulations", sep = " "))+
  xlab("Years since fire")+
  ylab("Shrub cover")+
  theme_bw()
```

## Seedling height by shrub species and year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Species, rep, Years, Ht_cm1, ShrubSpp03) %>% 
  summarize(mean_ht = mean(Ht_cm1))
```

```{r}
ggplot(dfsimallreps, aes(x = Years, y = Ht_cm1, group = ShrubSpp03, col = ShrubSpp03, symbol = Species))+
  #geom_line(aes(group = interaction(rep, ID_withinrep)), alpha = .05)+
  geom_smooth()+
  ggtitle(paste("Results for", iterations, "simulations", sep = " "))+
  xlab("Years since fire")+
  ylab("Focal tree height")+
  theme_bw()
```

## Growth by climate year
```{r}
ggplot(dfsimallreps %>% filter(Species == "PIPO"))+
  geom_boxplot(aes(x = as.factor(Year), y = pred_exp))+
  theme_minimal()
```

```{r}
dfsimallreps %>% 
  group_by(Year) %>% 
  summarize(n(), mean(pred_exp))
```

# Plot how many trees emerge above the shrub canopy each year

## Add column for whether the tree has emerged 
```{r}
dfsimallreps <- dfsimallreps %>% 
  mutate(emerged = ifelse(
    (Ht_cm1*0.75)>Ht1.3, 1, 0
  ))
```

### Check
```{r}
dfsimallreps %>% filter(Years == 28) %>% group_by(Species, emerged) %>% count()
```

## How many trees are neither emerged nor dead at the end? Should be none.
```{r}
dfsimallreps %>% 
  filter(Years == max(Years)) %>% 
  group_by(emerged, Species) %>% 
  count()
```

## Plot emergents per year 

### Summarize
```{r}
summary_emerge <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n)
```

### Counts

```{r}
plot_emerge_count <- ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = total_emergents, fill = Species), alpha = .8)+
  ylab("Number of emerged trees")+
  xlab("Years since fire")+
  ggtitle(paste("Results for", iterations, "simulations", sep = " "))
```

### Proportions

```{r}
plot_emerge_prop <- ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = prop_emerged, fill = Species), alpha = .8)+
  ylab("Proportion of initial\nseedlings that have emerged")+
  xlab("Years since fire")+
  ggtitle(paste("Results for", iterations, "simulations", sep = " "))
```

```{r}
grid.arrange(plot_emerge_count, plot_emerge_prop, ncol = 1)
```

## Check to make sure there are in fact trees that emerged before the simulation started
```{r}
dfsimallreps %>% 
  filter(rep==1 & Years==9) %>% 
  dplyr::select(Species, Sdlg, Ht1.3, Ht_cm1) %>% 
  mutate(emerge = ifelse(Ht_cm1*.75>Ht1.3, 1, 0)) %>% 
  group_by(Species, emerge) %>% 
  count()
```

## Plot proportion of original seedlings left at the end
```{r}
summary_prop <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) 

summary_prop <- summary_prop %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species) %>% 
  filter(Years== max(Years)) %>% 
  summarize(emerged = sum(emerged)) %>% 
  mutate(prop_emerged = emerged/initial_n) 

summary_prop

boxplot_prop <- ggplot(summary_prop)+
  geom_boxplot(aes(x = Species, y = prop_emerged))+
  theme_minimal()+
  ylab("Proportion of initial trees")+
   ggtitle(paste("Results for", iterations, "simulations at", max(dfsimallreps$Years),"years after fire", sep = " "))

ggsave(file = "../../results/figures/Simulations/sim_100_emerge_prop_all2015.png", width = 6, height =4, dpi = 400)
```

```{r}
grid.arrange(boxplot_trees, boxplot_prop, ncol = 2)
```

```{r}
print(paste("The whole thing took", round(Sys.time()-strt, 1), "minutes"))
```

```{r}
print(Sys.time())
```

# Long-term goals

1.  Use Kristen's data or Hugh's data for initial conditions
2.  Improve dispersal kernel based on Kristen/Hugh's data 
4.  Include residual surviving trees and their seed dispersal
5.  Include seed dispersal of post-fire regen once it reaches reproductive age 
6.  Add customization of patch size and shape
8.  Change sapling growth equations once they emerge from the shrub canopy
9.  Update display of shrub competition after simulation years
7.  apply to King, American River Complex, rest of the fires I measured
5.  what does shrub competition mean for new recruitment?

