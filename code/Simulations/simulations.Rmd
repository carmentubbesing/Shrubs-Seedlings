---
title: "Growth_mort"
author: "Carmen"
date: "October 31, 2019"
output: 
  html_document:
    toc: TRUE
---

# Next step: Consider adding CEIN to the initialization even though there isn't any in the American River footprint

# This script runs simulations with the most up-to-date functions

```{r, include = F}
setwd("~/Shrubs-Seedlings/code/Simulations/")
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(sp)
require(tmaptools)
require(knitr)
require(mgcv)
require(gridExtra)
strt <- Sys.time()
```

# Load functions

#### Create shrub patch
```{r}
source("functions/shrubclump.R")
```

#### Initialization function
```{r}
source("functions/initialize.R")
```

#### Height growth functions
```{r}
source("functions/abcogrowth.R")
source("functions/pipogrowth.R")
```

#### Diameter growth functions
```{r}
source("functions/abcodia_footprints.R")
source("functions/pipodia_footprints.R")
```

#### Mortality functions
```{r}
source("functions/abcomort.R")
source("functions/pipomort.R")
```

#### Shrub growth functions
```{r}
source("functions/abco_shrubgrowth.R")
source("functions/pipo_shrubgrowth.R")
```

#### Simulation function
```{r}
source("functions/sim.R")
```

#### Iteration function
```{r}
source("functions/iterate.R")
```

# Define parameters
```{r}
fire <- "AMRC"
years <- 20
cumsum_2015 <- 0.441
cumsum_2016 <- 0.912
cumsum_2017 <- 1
iterations <- 100
max_shrub_ht_cm <- 250
max_shrub_ht_years <- 15
n_seedlings <- 100
length_m <- 40
height_m <- 40
lambda <- 4
shrub_clumpiness <- 7
```

# Initialize

## Create clumped shrub pattern
```{r}
shrubclump()
```

## Randomly select seedlings from data and place them on the shrub patch
```{r}
initialize()
```

## Plot patch with seedlings
```{r}
pts.sf.pipo.graph <- pts.sf.pipo %>% 
  rename("Pine height" = Ht_cm1)
pts.sf.abco.graph <- pts.sf.abco %>% 
  rename("Fir height" = Ht_cm1)
```

```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(col = "sqrt_shrubarea3", title = "Shrub competition index", palette = "Greys", alpha = .5)+
tm_shape(r)+
  tm_raster(col = "ShrubSpp03", alpha = .2, title = "Shrub species", palette = "Set1")+
  tm_layout(asp=1:1, legend.outside = T)+
tm_shape(pts.sf.pipo.graph)+
  tm_symbols(size = "Pine height", col = "darkgreen", size.max = 500, border.col = "white", border.lwd = .05)+
tm_shape(pts.sf.abco.graph)+
  tm_symbols(size = "Fir height", col = "darkblue", size.max = 500, border.col = "white", border.lwd = .05)
```

# Simulate across years
```{r, warning=FALSE}
time <- Sys.time()
suppressMessages(sim(years))
print(paste("One simulation run took", Sys.time()-time, "seconds"))
```

# Tests

### Plot # of new emergents each year
```{r}
dfsimall %>% 
  group_by(Years, Species) %>% 
  mutate(emerged = ifelse(
    Ht_cm1>Ht1.3, 1, 0
  )) %>% 
  select(Sdlg, Species, ID_withinrep, Ht1.3, Ht_cm1, Years, emerged) %>% 
  group_by(Species, ID_withinrep) %>% 
  arrange(Years) %>% 
  mutate(cumsum_emerge = cumsum(emerged)) %>% 
  mutate(new_emerge = ifelse(cumsum_emerge ==1, 1, 0)) %>% 
  ungroup() %>% 
  group_by(Years, Species) %>% 
  summarize(new_emergents = sum(new_emerge)) %>% 
  ungroup() %>% 
  group_by(Species) %>% 
  arrange(Years) %>% 
  mutate(total_emergents = cumsum(new_emergents)) %>% 
  ggplot(aes(x = Years, y = total_emergents, col = Species))+
  geom_point()+
  geom_line()+
  theme_minimal()
```


### Shrub growth patterns
```{r}
ht <- ggplot(dfsimall)+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, linetype = Species, group = Sdlg))+
  theme_bw()
```

```{r}
cov <- ggplot(dfsimall)+
  geom_line(aes(x = Years, y = Cov1.3, col = ShrubSpp03, linetype = Species, group = Sdlg))+
  theme_bw()
```

```{r}
grid.arrange(ht, cov, ncol = 2)
```

### Focal tree dia and ht growth patterns
```{r}
dia <- ggplot(dfsimall, aes(x = Years, y = dia.cm, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

```{r}
ht <- ggplot(dfsimall, aes(x = Years, y = Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))
```

```{r}
ratio <- ggplot(dfsimall, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Species))
```

```{r}
grid.arrange(dia, ht, ratio, ncol = 2)
```

### Diameter and height boxplots
```{r}
all_dia <- ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))+
  theme(legend.position="none")
```

```{r}
strt_dia <- ggplot(dfsimall %>% filter(Years<11))+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  ggtitle("Diameter distribution after\nfirst simulation year")
```

```{r}
all_ht <- ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))+
  theme(legend.position="none")
```

```{r}
strt_ht <- ggplot(dfsimall %>% filter(Years<11))+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  ggtitle("Diameter distribution after\nfirst simulation year")
```

```{r}
grid.arrange(strt_dia, all_dia, strt_ht, all_ht)
```

## Plot shrub patch spatially
```{r}
pts.sf.pipo.graph <- pts.sf.pipo %>% 
  rename("Pine height (cm)" = Ht_cm1)
pts.sf.abco.graph <- pts.sf.abco %>% 
  rename("Fir height (cm)" = Ht_cm1)
```

```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(col = "sqrt_shrubarea3", title = "Shrub competition index", palette = "Greys", alpha = .5)+
tm_shape(r)+
  tm_raster(col = "ShrubSpp03", alpha = .7, title = "Shrub species", palette = "Pastel1")+
  tm_layout(asp=1:1, legend.outside = T, legend.title.size = 4, legend.text.size = 2)+
tm_shape(pts.sf.pipo.graph)+
  tm_symbols(size = "Pine height (cm)", col = "#DCC960", size.max = 300, border.lwd = 3)+
tm_shape(pts.sf.abco.graph)+
  tm_symbols(size = "Fir height (cm)", col = "#899DA4", size.max = 300, border.lwd = 3)
```

# Iterate 
```{r, warning=FALSE}
time <- Sys.time()
iterate(iterations)
print(paste("That took", round(Sys.time()-time, 1), "minutes"))
```

# Summarize

## Height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>%
  mutate(rep = as.factor(paste(rep))) %>% 
  group_by(rep, Years, Species) %>% 
  mutate(mean_ht_years = mean(Ht_cm1))
```

```{r}
ht <- ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = mean_ht_years, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = mean_ht_years, group = Species, col = Species), size = 1)+
  xlab("Years since fire")+
  ylab("Average tree ht (cm) by simulation")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ht
ggsave(file = "../../results/figures/Simulations/sim_100_hts.png", width = 6, height =4, dpi = 400)
```

#### Shrub growth patterns
```{r}
ggplot(dfsimallreps_summary)+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, group = Sdlg))+
  theme_bw()
```

### Diameter growth patterns - FIX THIS FOR PIPO
```{r}
ggplot(dfsimallreps_summary %>% filter(Species == "ABCO"))+
  geom_line(aes(x = Years, y = dia.cm, col = Species, group = Sdlg), alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

#### For a single tree
```{r}
ggplot(dfsimallreps %>% filter(Sdlg == 244))+
  geom_line(aes(x = Years, y = dia.cm))
```

```{r}
ggplot(dfsimallreps %>% filter(Sdlg == 244))+
  geom_line(aes(x = Years, y = Ht_cm1))
```

#### Plot the relationships between variables inputting the diameter growth equations to compare them to what I saw in the dendro analysis
```{r}
test <- dfsimallreps %>% 
  filter(Years %in% c(19,20)) %>% 
  dplyr::select(Sdlg, Species, Ht_cm1, dia.cm, Years, pred_exp, rep, ID_withinrep) %>% 
  tbl_df() %>% 
  arrange(Sdlg)
test
test <- test %>% 
  mutate(ID = paste(Sdlg, rep, ID_withinrep, sep = "-"))
test %>% 
  arrange(ID)
test2 <- pivot_wider(test, names_from = "Years", values_from = "dia.cm", id_cols = "ID")
test2 %>% 
  arrange(ID)

test2 <- test2 %>% 
  rename(dia.cmYear19 = `19`, dia.cmYear20 = `20`)

ggplot(test2)+
  geom_point(aes(x = dia.cmYear19, y = dia.cmYear20))+
  geom_abline(aes(slope = 1, intercept = 0))+
  theme_minimal()+
  ylim(0,20)+
  xlim(0,20)
```

### Height growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))+
  ylim(0,300)
```

### Diameter::Height growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  ylim(0,.2)
```

### Diameter:height
```{r}
ggplot(dfsimallreps_summary %>% filter(Years==10))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))
ggplot(dfsimallreps_summary %>% filter(Years==20))+
  geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))
```

### Diameter and height boxplots
```{r}
ggplot(dfsimallreps_summary)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))
```

```{r}
ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))

```


## Counts by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Species) %>% 
  mutate(count = n()) %>% 
  mutate(count = as.numeric(count))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = count, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = count, fill = Species, col = Species), size = 1)+
  ggtitle("Results for 100 simulations")+
  xlab("Years since fire")+
  ylab("Tree count")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ggsave(file = "../../results/figures/Simulations/sim_100_count.png", width = 6, height = 4, dpi = 400)
```

## Shrub height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Ht1.3, Cov1.3, ShrubSpp03) %>% 
  mutate(mean_shrub_ht = mean(Ht1.3), mean_shrub_cov = mean(Cov1.3))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_ht, group = ShrubSpp03, col = ShrubSpp03))+
  geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle("Results for 100 simulations")+
  xlab("Years since fire")+
  ylab("Shrub height")+
  theme_bw()
```

```{r}
print(Sys.time() - strt)
```

## Shrub cover by year
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_cov, group = ShrubSpp03, col = ShrubSpp03))+
  geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle("Results for 100 simulations")+
  xlab("Years since fire")+
  ylab("Shrub cover")+
  theme_bw()
```

```{r}
print(Sys.time() - strt)
```


## Seedling height by shrub species and year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Species, rep, Years, Ht_cm1, ShrubSpp03) %>% 
  mutate(mean_ht = mean(Ht_cm1))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = Ht_cm1, group = ShrubSpp03, col = ShrubSpp03, symbol = Species))+
  geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle("Results for 100 simulations")+
  xlab("Years since fire")+
  ylab("Focal tree height")+
  theme_bw()
```

## Growth by climate year
```{r}
ggplot(dfsimallreps %>% filter(Species == "PIPO"))+
  geom_boxplot(aes(x = as.factor(Year), y = pred_exp))
```

```{r}
dfsimallreps %>% 
  group_by(Year) %>% 
  summarize(n(), mean(pred_exp))
```

# Plot how many trees emerge above the shrub canopy each year

## Add column for whether the tree has emerged 
```{r}
dfsimallreps <- dfsimallreps %>% 
  mutate(emerged = ifelse(
    Ht_cm1>Ht1.3, 1, 0
  ))
```

### Check
```{r}
dfsimallreps %>% group_by(emerged) %>% count()
```

## Count total emergents per year
```{r}
summary_emerge <- dfsimallreps %>% 
  dplyr::select(Sdlg, Species, ID_withinrep, Ht1.3, Ht_cm1, Years, emerged, rep)  %>% 
  group_by(Species, ID_withinrep, rep) %>% 
  arrange(Years) %>% 
  mutate(cumsum_emerge = cumsum(emerged)) %>% 
  mutate(new_emerge = ifelse(cumsum_emerge ==1, 1, 0)) %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  summarize(new_emergents = sum(new_emerge), total= n()) %>% 
  ungroup() %>% 
  group_by(Species, rep) %>% 
  arrange(Years) %>% 
  mutate(total_emergents = cumsum(new_emergents))
```

## Plot emergents per year - this is misleading because some of the cumulatively emerged trees have died
```{r}
ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = total, fill = Species), col = "black", alpha = .2)+
  geom_boxplot(aes(x = as.factor(Years), y = total_emergents, fill = Species), alpha = .8)+
  ylab("Total seedlings (light) and emerged trees (dark)")+
  xlab("Years since fire")
```

```{r}
summary_emerge_prop <- summary_emerge %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_total = total/initial_n, prop_emerged = total_emergents/initial_n)
  
summary_emerge_prop 
```

```{r}
ggplot(summary_emerge_prop)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = prop_total, fill = Species), col = "black", alpha = .2)+
  geom_boxplot(aes(x = as.factor(Years), y = prop_emerged, fill = Species), alpha = .8)+
  ylab("Proportion of initial seedlings that have emerged")+
  xlab("Years since fire")
```

## Check
```{r}
dfsimallreps %>% 
  filter(Species=="PIPO") %>% 
  filter(rep==1 & Years==9) %>% 
  select(Sdlg, Ht1.3, Ht_cm1) %>% 
  mutate(emerge = ifelse(Ht_cm1>Ht1.3, 1, 9)) %>% 
  group_by(emerge) %>% 
  count()
```

## Calculate how many surviving trees are left at last year both emerged and non-emerged
```{r}
summary_count <- dfsimallreps %>% 
  group_by(rep, Species) %>% 
  filter(Years == max(Years)) %>% 
  summarize(total = n(), emerged = sum(emerged)) 

summary_count <- pivot_longer(summary_count, cols = c(3,4), names_to = "stat")

summary_count

boxplot_trees <- ggplot(summary_count)+
  geom_boxplot(aes(x = Species, y = value, col = stat))+
  theme_minimal()+
  ylab("Number of trees")+
  ggtitle("Simulation results at 29 years post-fire")
boxplot_trees
```

## Same graph but for proportion of original seedlings
```{r}
summary_prop <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) 

summary_prop <- summary_prop %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species) %>% 
  filter(Years== max(Years)) %>% 
  summarize(total = n(), emerged = sum(emerged)) %>% 
  mutate(prop_total = total/initial_n, prop_emerged = emerged/initial_n) 

summary_prop <- pivot_longer(summary_prop, cols = c(4:7), names_to = "stat")
summary_prop

boxplot_prop <- ggplot(summary_prop %>% filter(stat %in% c("prop_total", "prop_emerged")))+
  geom_boxplot(aes(x = Species, y = value, col = stat))+
  theme_minimal()+
  ylab("Proportion of initial trees")
boxplot_prop

ggsave(file = "../../results/figures/Simulations/sim_100_emerge_prop_all2015.png", width = 6, height =4, dpi = 400)
```

```{r}
grid.arrange(boxplot_trees, boxplot_prop, ncol = 2)
```

# Next steps to improve the model

1.  Use Kristen's data or Hugh's data for initial conditions
2.  Improve dispersal kernel based on Kristen/Hugh's data 
4.  Include residual surviving trees and their seed dispersal
5.  Include seed dispersal of post-fire regen once it reaches reproductive age 
6.  Add customization of patch size and shape
8.  Change sapling growth equations once they emerge from the shrub canopy

For next week:

1.  Update display of shrub competition after simulation years
7.  apply to King, American River Complex, rest of the fires I measured

Other notes:

1.  maybe submit to American Naturalist
2.  Global Change Biology - mixing up the years
3.  no overstory reproduction for now 
5.  what does shrub competition mean for new recruitment?

