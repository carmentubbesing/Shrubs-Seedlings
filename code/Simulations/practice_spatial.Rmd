---
title: "Practice"
author: "Carmen"
date: "October 23, 2019"
output: 
  html_document:
    toc: TRUE
---

```{r}
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(sp)
require(tmaptools)
require(knitr)
```

# Load seedling and shrub data from fire footprints
```{r}
load(file="~/Shrubs-Seedlings/compiled_data/fire_footprints/master_seedlings_vert.Rdata")
```

# Assign each pixel shrub cov, ht, and competition values. For now, exclude seedlings without 2016 height values.
```{r}
df <- df %>% 
  dplyr::select(Sdlg, Species, Cov1.3, Ht1.3, ShrubSpp03, shrubarea3, BasDia2016.cm, Ht2016.cm_spring, heatload, incidrad, Slope.Deg, Elevation, Fire, Years, Year) %>% 
  filter(Year=="2016") %>% 
  filter(Fire == "AMRC") %>% 
  filter(!is.na(Ht2016.cm_spring)) %>% 
  mutate(Cov_prop = Cov1.3/1200) %>% 
  distinct()
```

# Create a raster from scratch
```{r}
values <- as.numeric(paste(sample(df$Sdlg, 400, replace = T)))
values
xy <- matrix(values, 20,20)
r <- raster(xy, xmn = 0, xmx = 20, ymn = 0, ymx = 20)
plot(r)
```

## Add a crs
```{r}
crs_epsg <- CRS("+init=epsg:26910")
crs_epsg
```

```{r}
crs(r) <- crs_epsg
crs(r)
get_projection(r)
```

# Plot
```{r}
tm_shape(r)+
  tm_raster()+
  tm_layout(asp=1:1)
```

# Create polygon surrounding the raster
```{r}
p <- as(extent(r), "SpatialPolygons")
crs(p) <- crs(r)
get_projection(p)
```

```{r}

tm_shape(r)+
  tm_raster()+
  tm_layout(asp=1:1)+
tm_shape(p)+
  tm_borders(col = "purple", lwd= 5)
```

# Create points
```{r}
x.left <- 0.5+rpois(10,2.5)
x.right <- 19.5-rpois(10,2.5)
y.bottom <- 0.5+rpois(10,2.5)
y.top <- 19.5-rpois(10,2.5)
x <- sample(c(x.left, x.right), 20)
y <- sample(c(y.top, y.bottom), 20)

left.edge <- cbind(x = x.left, y = (0.5 + sample(c(0:19), 10)))
right.edge <- cbind(x = x.right, y = (0.5 +sample(c(0:19), 10)))

top.edge <- cbind(x =  c(0.5 + sample(c(1:19), 10)), y = y.top)
bottom.edge <- cbind(x = c(0.5 + sample(c(1:19), 10)),  y = y.bottom)

edges <- rbind(left.edge, right.edge, top.edge, bottom.edge)
pts.xy <- edges
```

```{r}
pts.xy %>% 
  as.data.frame() %>% 
  group_by(x, y) %>% 
  summarize(n()) %>% 
  tail()
left.edge %>% 
  as.data.frame() %>% 
  group_by(x, y) %>% 
  summarize(n()) %>% 
  tail()

```

# Convert to spatial
```{r}
pts.sp <- SpatialPoints(coords = pts.xy[,c("x", "y")], proj4string = crs(p))
plot(pts.sp)
pts.sf <- as(pts.sp, "sf")
```

# Decide which trees are fir and which are pine - 1.32 fir:pine ratio
```{r}
# pts.sf <- pts.sf %>% 
#   mutate(Species = sample(c("ABCO", "PIPO"), size = nrow(pts.sf), replace = T, prob = c(1.32, 1)))
# summary(as.factor(pts.sf$Species))
```

# Find raster values for each seedling 
```{r}
pts.sf <- pts.sf %>% 
  mutate(Sdlg = raster::extract(r, as(pts.sf, "Spatial")))
head(pts.sf)
```

# Add seedling species, ht, cov, shrub variables to sf object
```{r}
head(pts.sf)
nrow(pts.sf)
pts.sf <- pts.sf %>% 
  mutate(Sdlg = as.factor(Sdlg))
pts.sf <- left_join(pts.sf, df)
nrow(pts.sf)
pts.sf
```


# Next: make them grow for a few time steps based on predictive functions from Ch. 2 results. Then make some die based on mortality study results

# For now, keep shrub competition static across years for each pixel

## Normalize function
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
```

# Reformat pts.sf so that it's compatible with LM
```{r}
summary(as.factor(pts.sf$ShrubSpp03))

pts.sf.lm <- pts.sf %>% 
  rename("Ht_cm1" = Ht2016.cm_spring) %>% 
  mutate(Years = as.factor(Years)) %>% 
  mutate(sqrt_shrubarea3 = sqrt(shrubarea3)) %>% 
  mutate("Year"="2016") %>% 
  mutate(Year = as.factor(Year)) %>% 
  mutate(ShrubSpp03 = case_when(ShrubSpp03 == "CHSE" ~ "Other",
                                 TRUE ~ as.character(ShrubSpp03))) 
summary(as.factor(pts.sf.lm$ShrubSpp03))
```


```{r}
pts.sf.abco <- pts.sf.lm %>% filter(Species == "ABCO")
pts.sf.pipo <- pts.sf.lm %>% filter(Species == "PIPO")
```

# Plot simulations
```{r}
tm_shape(p)+
  tm_borders(col = "purple", lwd= 5)+
tm_shape(r)+
  tm_raster(alpha = .5)+
  tm_layout(asp=1:1, legend.bg.color = "white", legend.outside = T)+
tm_shape(pts.sf.pipo)+
   tm_dots(size = .3, col = "darkgreen")+
tm_shape(pts.sf.abco)+
  tm_dots(size = .3, col = "darkblue")
```

# Load LM coefficients

## PIPO
```{r}
load("~/Shrubs-Seedlings/results/data/FireFootprints/LM_pipo.Rdata")
LMpipo <- LM
remove(LM)
coefpipo <- LMpipo$coefficients$fixed
coefpipo
```

## ABCO
```{r}
load("~/Shrubs-Seedlings/results/data/FireFootprints/LM_abco.Rdata")
LMabco <- LM
remove(LM)
coefabco <- LMabco$coefficients$fixed
coefabco
```

# Create functions for predicting growth based on fire footprints results

## PIPO
```{r}
pipogrowth <- function(){
   hts <- pts.sf.pipo %>% dplyr::select(Ht_cm1) %>% st_drop_geometry() %>% unlist()# Save hts before normalization to convert it back later
  pts.sf.pipo <<- pts.sf.pipo %>% 
    mutate_if(is.numeric, normalize) %>% 
    mutate(ShrubSpp03 = as.factor(paste(ShrubSpp03))) %>% 
    mutate(pred = coefpipo["(Intercept)"] +
             coefpipo["Ht_cm1"]*Ht_cm1+
             coefpipo["Years"]*as.numeric(paste(Years))+
             coefpipo["sqrt_shrubarea3"]*sqrt_shrubarea3+
             coefpipo["heatload"]*heatload+
             coefpipo["BasDia2016.cm"]*BasDia2016.cm) %>%
    mutate(pred = case_when(
      ShrubSpp03 == "CECO" ~ pred + coefpipo["ShrubSpp03CECO"],
      ShrubSpp03 == "CEIN" ~ pred + coefpipo["ShrubSpp03CEIN"],
      ShrubSpp03 == "CHFO" ~ pred + coefpipo["ShrubSpp03CHFO"],
      ShrubSpp03 == "LIDE" ~ pred + coefpipo["ShrubSpp03LIDE"],
      ShrubSpp03 == "Other" ~ pred + coefpipo["ShrubSpp03Other"],
      TRUE ~ as.numeric(pred)) ) %>% 
  mutate(pred = case_when(
      Year == "2016" ~ pred + coefpipo["Year2016"],
      Year == "2017" ~ pred + coefpipo["Year2017"],
      TRUE ~ as.numeric(pred)) ) %>% 
    mutate(pred_exp = exp(pred)) %>% 
        mutate(Ht_cm1 = Ht_cm1*sd(hts)+mean(hts)) %>%      # de-normalize ht
    mutate(Ht_cm1 = Ht_cm1 + pred_exp*Ht_cm1)   # calculate new ht after growth

}
pipogrowth()
head(pts.sf.pipo)
```

### Check by plotting
```{r}
ggplot(pts.sf.pipo)+
  geom_line(aes(x = sqrt_shrubarea3, y = pred_exp), col = "#fc8d62")
ggplot(pts.sf.pipo)+
  geom_boxplot(aes(x = ShrubSpp03, y = pred_exp))
ggplot(pts.sf.pipo)+
  geom_line(aes(x = Ht_cm1, y = pred_exp), col = "#fc8d62")
```

## ABCO
```{r}
abcogrowth <- function(){
  hts <- pts.sf.abco %>% dplyr::select(Ht_cm1) %>% st_drop_geometry() %>% unlist()# Save hts before normalization to convert it back later
  pts.sf.abco <<- pts.sf.abco %>% 
    mutate_if(is.numeric, normalize) %>% 
    mutate(ShrubSpp03 = as.factor(paste(ShrubSpp03))) %>% 
    mutate(pred = coefabco["(Intercept)"] +
             coefabco["Ht_cm1"]*Ht_cm1+
             coefabco["Years"]*as.numeric(paste(Years))+
             coefabco["sqrt_shrubarea3"]*sqrt_shrubarea3+
             coefabco["heatload"]*heatload+
             coefabco["incidrad"]*incidrad+
             coefabco["Slope.Deg"]*Slope.Deg+
             coefabco["Elevation"]*Elevation+
             coefabco["BasDia2016.cm"]*BasDia2016.cm) %>%
     mutate(pred = case_when(
      Year == "2016" ~ pred + coefabco["Year2016"],
      Year == "2017" ~ pred + coefabco["Year2017"],
      TRUE ~ as.numeric(pred)) ) %>% 
    mutate(pred_exp = exp(pred)) %>% 
    mutate(Ht_cm1 = Ht_cm1*sd(hts)+mean(hts)) %>%      # de-normalize ht
    mutate(Ht_cm1 = Ht_cm1 + pred_exp*Ht_cm1)   # calculate new ht after growth
}
abcogrowth()
head(pts.sf.abco)
```

### Check by plotting
```{r}
ggplot(pts.sf.abco)+
  geom_line(aes(x = sqrt_shrubarea3, y = pred_exp), col = "#fc8d62")
ggplot(pts.sf.abco)+
  geom_boxplot(aes(x = ShrubSpp03, y = pred_exp))
ggplot(pts.sf.abco)+
  geom_line(aes(x = Ht_cm1, y = pred_exp), col = "#fc8d62")
```

# Plot simulations
```{r}
simplot <- tm_shape(p)+
  tm_borders(col = "purple", lwd= 5)+
tm_shape(r)+
  tm_raster(alpha = .5, title = "Shrub competition")+
  tm_layout(asp=1:1, legend.bg.color = "white", legend.outside = T)+
tm_shape(pts.sf.pipo)+
  tm_symbols(size = "Ht_cm1", col = "darkgreen", size.max = 300)+
tm_shape(pts.sf.abco)+
  tm_symbols(size = "Ht_cm1", col = "darkblue", size.max = 300)
simplot
```

# Apply across 30 years
```{r}
head(pts.sf.abco)
dfsim <- data.frame()


for(i in 1:3){
  print(i)
  abcogrowth()
  pipogrowth()
  pts.sf.pipo <- pts.sf.pipo %>% 
    mutate(Years = as.numeric(paste(Years))+1) 
  
  pts.sf.abco <- pts.sf.abco %>% 
    mutate(Years = as.numeric(paste(Years))+1)
  dfsim <- full_join(st_drop_geometry(pts.sf.pipo), st_drop_geometry(pts.sf.abco))
}
summary(dfsim)


simplot
head(pts.sf.abco)
  tm_shape(p)+
  tm_borders(col = "purple", lwd= 5)+
tm_shape(r)+
  tm_raster(alpha = .5, title = "Shrub competition")+
  tm_layout(asp=1:1, legend.bg.color = "white", legend.outside = T)+
tm_shape(pts.sf.pipo)+
  tm_symbols(size = "Ht_cm1", col = "darkgreen", size.max = 300)+
tm_shape(pts.sf.abco)+
  tm_symbols(size = "Ht_cm1", col = "darkblue", size.max = 300)
```


# Create a function to kill some seedlings based on mortality~growth relationships
```{r}

```

# Questions I need to decide on:

-  1. How do I determine the shrub competition values of each raster pixel, since my sampling was not random?
-  2. How do I place the initial seedlings?
-  3. Do I combine data from different fires, or do them one at a time?

