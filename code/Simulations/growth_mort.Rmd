---
title: "Growth_mort"
author: "Carmen"
date: "October 31, 2019"
output: 
  html_document:
    TOC: TRUE
---

```{r, include = F}
setwd("~/Shrubs-Seedlings/code/Simulations/")
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(sp)
require(tmaptools)
require(knitr)
```

# Load functions

## Normalize function
```{r}
source("functions/normalize.R")
```

## Initialization function
```{r}
source("functions/initialize.R")
```

## Growth functions
```{r}
source("functions/abcogrowth.R")
source("functions/pipogrowth.R")
```

## Simulation function
```{r}
source("functions/sim.R")
```

## Iteration function
```{r}
source("functions/iterate.R")
```


# Prep
```{r}
initialize()
```

# Plot
```{r}
tm_shape(p)+
  tm_borders(col = "purple", lwd= 5)+
tm_shape(r)+
  tm_raster(alpha = .5)+
  tm_layout(asp=1:1, legend.bg.color = "white", legend.outside = T)+
tm_shape(pts.sf.pipo)+
   tm_dots(size = "Ht_cm1", col = "darkgreen", size.max = 300)+
tm_shape(pts.sf.abco)+
  tm_dots(size = "Ht_cm1", col = "darkblue", size.max = 300)
```

# Apply across 20 years
```{r}
suppressMessages(sim(20))
summary(pts.sf.pipo)
```

# Plot patch
```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(alpha = .5, title = "Shrub competition")+
  tm_layout(asp=1:1, legend.outside = T)+
tm_shape(pts.sf.pipo)+
  tm_symbols(size = "Ht_cm_nonnorm", col = "darkgreen", size.max = 3000)+
tm_shape(pts.sf.abco)+
  tm_symbols(size = "Ht_cm_nonnorm", col = "darkblue", size.max = 3000)
```

# Plot trends
```{r}
ggplot(dfsimall)+
  geom_smooth(aes(x = Years, y = Ht_cm_nonnorm, group = Species, col = Species))+
  theme_bw()
```

```{r}
ggplot(dfsimall %>% filter(Years_nonnorm ==20))+
  geom_smooth(aes(x = shrubarea3, y = Ht_cm_nonnorm, group = Species, col = Species))+
  theme_bw()
```

# Iterate 
```{r}
iterate(300)
dfsimallreps %>% 
  group_by(rep) %>% 
  summarize(mean(Ht_cm_nonnorm))
```

# Summarize

## By shrub competition
```{r}
dfsimallreps <- dfsimallreps %>% 
  ungroup() %>% 
  mutate(rep = as.factor(paste(rep))) %>% 
  group_by(rep, shrubarea3) %>% 
  mutate(mean_ht_shrubs = mean(Ht_cm_nonnorm))
dfsimallreps %>% select(rep, shrubarea3, mean_ht_shrubs) %>% summary()
```

```{r}
ggplot(dfsimallreps)+
  geom_smooth(aes(x = shrubarea3, y = mean_ht_shrubs, group = Species, col = Species))+
  geom_point(aes(x = shrubarea3, y = mean_ht_shrubs, group = Species, col = Species))+
  theme_bw()
```

## By year
```{r}
dfsimallreps <- dfsimallreps %>% 
  ungroup() %>% 
  mutate(rep = as.factor(paste(rep))) %>% 
  group_by(rep, Years) %>% 
  mutate(mean_ht_years = mean(Ht_cm_nonnorm))
dfsimallreps %>% select(rep, Years, mean_ht_years) %>% summary()
```

```{r}
ggplot(dfsimallreps)+
  geom_smooth(aes(x = Years, y = mean_ht_years, group = Species, col = Species), method = "lm")+
  geom_point(aes(x = Years, y = mean_ht_years, group = Species, col = Species))+
  theme_bw()
```

