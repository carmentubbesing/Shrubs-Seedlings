---
title: "simulations_plot"
author: "Carmen"
date: "2/13/2020"
output: 
  html_document:
    toc: TRUE
---

```{r}
load("~/Simulations2020-02-17_100AMRC.Rdata")
strt <- Sys.time()
```

```{r, include = F}
require(tidyverse)
require(gridExtra)
```

# Check for reps that got dropped as errors -- should be TRUE
```{r}
length(unique(dfsimallreps$rep)) == max(dfsimallreps$rep)
length(unique(dfsimallreps$rep))
max(dfsimallreps$rep)
```

# Summarize

## Focal tree height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>%
  mutate(rep = as.factor(paste(rep))) %>% 
  group_by(rep, Years, Species) %>% 
  mutate(mean_ht_years = mean(Ht_cm1))
```

```{r}
ht <- ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = mean_ht_years, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = mean_ht_years, group = Species, col = Species), size = 1)+
  xlab("Years since fire")+
  ylab("Average tree ht (cm) by simulation")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))
ht
filename <- paste("../../results/figures/Simulations/hts_sim", max(dfsimallreps$Years), Sys.Date(), ".png", sep = "_")
#ggsave(file = filename, width = 6, height =4, dpi = 400)
```

## Diameter growth patterns 
```{r}
ggplot(dfsimallreps)+
  #geom_line(aes(x = Years, y = dia.cm, col = Species, group = interaction(rep, ID_withinrep)), alpha = .1)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

## Height by error term
```{r}
summary <- dfsimallreps %>% 
  filter(rep %in% c(1:20)) %>% 
  group_by(rep, Species, Years, error_pipo_gr, error_abco_gr) %>% 
  summarize(mean_ht = mean(Ht_cm1))
```

```{r}
ggplot(summary %>% filter(Species == "PIPO"))+
  geom_line(aes(x = Years, y = mean_ht, col = error_pipo_gr, group = interaction(Species, rep)))+
  scale_color_continuous(low = "red", high = "blue")+
  theme_bw()
```

```{r}
ggplot(summary %>% filter(Species == "ABCO"))+
  geom_line(aes(x = Years, y = mean_ht, col = error_abco_gr, group = interaction(Species, rep)))+
  scale_color_continuous(low = "red", high = "blue")+
  theme_bw()
```

## Ht and dia for a single tree
```{r}
tree244dia <- ggplot(dfsimallreps %>% filter(Sdlg == 244 & rep == 1))+
  geom_line(aes(x = Years, y = dia.cm))+
  theme_minimal()
```

```{r}
tree244ht <- ggplot(dfsimallreps %>% filter(Sdlg == 244 & rep ==1))+
  geom_line(aes(x = Years, y = Ht_cm1))+
  theme_minimal()
```

```{r}
grid.arrange(tree244dia, tree244ht, ncol = 2)
```

#### Plot the relationships between variables inputting the diameter growth equations to compare them to what I saw in the dendro analysis
```{r}
test <- dfsimallreps %>% 
  filter(Years %in% c(19,20)) %>% 
  dplyr::select(Sdlg, Species, Ht_cm1, dia.cm, Years, pred_exp, rep, ID_withinrep) %>% 
  tbl_df() %>% 
  arrange(Sdlg)
test <- test %>% 
  mutate(ID = paste(Sdlg, rep, ID_withinrep, sep = "-"))

test2 <- pivot_wider(test, names_from = "Years", values_from = "dia.cm", id_cols = c("rep", "ID"))

test2 <- test2 %>% 
  rename(dia.cmYear19 = `19`, dia.cmYear20 = `20`)

ggplot(test2)+
  geom_point(aes(x = dia.cmYear19, y = dia.cmYear20, col = as.factor(rep)))+
  geom_abline(aes(slope = 1, intercept = 0))+
  theme_minimal()+
  ylim(0,20)+
  xlim(0,20)
```

### Height growth patterns
```{r}
ggplot(dfsimallreps, aes(x = Years, y = Ht_cm1, col = Species, group = interaction(rep, ID_withinrep)))+
  #geom_line(alpha = .1)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))
```

### Diameter::Height growth patterns
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = interaction(rep, ID_withinrep)))+
  #geom_line(alpha = .1)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Species))
```

### Diameter:height at years 10 and 20
```{r}
# yr10 <- ggplot(dfsimallreps_summary %>% filter(Years==10))+
#   geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))+
#   theme_minimal()+
#   ggtitle("Year 10")
# yr20 <- ggplot(dfsimallreps_summary %>% filter(Years==20))+
#   geom_histogram(aes(dia.cm/Ht_cm1, bins = 20))+
#   theme_minimal()+
#   ggtitle("Year 20")
# grid.arrange(yr10, yr20, ncol = 2)
```

### Diameter and height boxplots
```{r}
diabox <- ggplot(dfsimallreps_summary)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))
```

```{r}
htbox <- ggplot(dfsimallreps)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  theme(text = element_text(size = 20))+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))
```

```{r}
grid.arrange(diabox, htbox)
```

## Counts by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Species) %>% 
  mutate(count = n()) %>% 
  mutate(count = as.numeric(count))
```

```{r}
title <- paste("Results for", max(dfsimallreps$Years), "years across", max(dfsimallreps$rep), "iterations", sep = " ")

title

ggplot(dfsimallreps_summary, aes(x = as.factor(Years), y = count, fill = Species, col = Species))+
  geom_boxplot(alpha = .2, outlier.alpha = .02)+
  geom_smooth(aes(x = as.factor(Years), y = count, fill = Species, col = Species), size = 1)+
  ggtitle(title)+
  xlab("Years since fire")+
  ylab("Tree count")+
  theme_bw()+
  scale_color_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  scale_fill_manual(values = c("#899DA4", "#9A8822"), labels = c("Fir", "Pine"))+
  theme(text = element_text(size = 16), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size = 8))

ggsave(file = "../../results/figures/Simulations/sim_100_count.png", width = 6, height = 4, dpi = 400)
```

## Shrub height by year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(rep, Years, Ht1.3, Cov1.3, ShrubSpp03) %>% 
  mutate(mean_shrub_ht = mean(Ht1.3), mean_shrub_cov = mean(Cov1.3))
```

```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_ht, group = ShrubSpp03, col = ShrubSpp03))+
  #geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle(paste("Results for", max(dfsimallreps$rep), "simulations", sep = " "))+
  xlab("Years since fire")+
  ylab("Shrub height")+
  theme_bw()
```

## Shrub cover by year
```{r}
ggplot(dfsimallreps_summary, aes(x = Years, y = mean_shrub_cov, group = ShrubSpp03, col = ShrubSpp03))+
  #geom_line(aes(group = Sdlg), alpha = .2)+
  geom_smooth()+
  ggtitle(paste("Results for", max(dfsimallreps$rep), "simulations", sep = " "))+
  xlab("Years since fire")+
  ylab("Shrub cover")+
  theme_bw()
```

## Seedling height by shrub species and year
```{r}
dfsimallreps_summary <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Species, rep, Years, Ht_cm1, ShrubSpp03) %>% 
  summarize(mean_ht = mean(Ht_cm1))
```

```{r}
ggplot(dfsimallreps, aes(x = Years, y = Ht_cm1, group = ShrubSpp03, col = ShrubSpp03, symbol = Species))+
  #geom_line(aes(group = interaction(rep, ID_withinrep)), alpha = .05)+
  geom_smooth()+
  ggtitle(paste("Results for", max(dfsimallreps$rep), "simulations", sep = " "))+
  xlab("Years since fire")+
  ylab("Focal tree height")+
  theme_bw()
```

## Growth by climate year
```{r}
ggplot(dfsimallreps %>% filter(Species == "PIPO"))+
  geom_boxplot(aes(x = as.factor(Year), y = pred_exp))+
  theme_minimal()
```

```{r}
dfsimallreps %>% 
  group_by(Year) %>% 
  summarize(n(), mean(pred_exp))
```

# Plot how many trees emerge above the shrub canopy each year

### Check that all have emerged by the last year
```{r}
dfsimallreps %>% 
  group_by(rep) %>% 
  filter(Years == max(Years)) %>% 
  group_by(Species, emerged, Years) %>% 
  filter(emerged ==0) %>% 
  group_by(rep, Sdlg) %>% 
  count()
```

## How many trees are neither emerged nor dead at the end? Should be none.
```{r}
dfsimallreps %>% 
  filter(Years == max(Years)) %>% 
  group_by(emerged, Species) %>% 
  count()
```

## Plot emergents per year 

### Summarize
```{r}
summary_emerge <- dfsimallreps %>% 
  group_by(Years, Species, rep) %>% 
  summarize(total_emergents = sum(emerged), total = n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  mutate(prop_emerged = total_emergents/initial_n)
```

### Counts

```{r}
plot_emerge_count <- ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = total_emergents, fill = Species), alpha = .8)+
  ylab("Number of emerged trees")+
  xlab("Years since fire")+
  ggtitle(paste("Results for", max(dfsimallreps$rep), "simulations", sep = " "))
```

### Proportions

```{r}
plot_emerge_prop <- ggplot(summary_emerge)+
  theme_minimal()+
  geom_boxplot(aes(x = as.factor(Years), y = prop_emerged, fill = Species), alpha = .8)+
  ylab("Proportion of initial\nseedlings that have emerged")+
  xlab("Years since fire")+
  ggtitle(paste("Results for", max(dfsimallreps$rep), "simulations", sep = " "))
```

```{r}
grid.arrange(plot_emerge_count, plot_emerge_prop, ncol = 1)
```

## Check to make sure there are in fact trees that emerged before the simulation started
```{r}
dfsimallreps %>% 
  filter(rep==1 & Years==9) %>% 
  dplyr::select(Species, Sdlg, Ht1.3, Ht_cm1) %>% 
  mutate(emerge = ifelse(Ht_cm1*.75>Ht1.3, 1, 0)) %>% 
  group_by(Species, emerge) %>% 
  count()
```

## Plot number and proportion of original seedlings left at the end

```{r}
title <- paste("Results for", max(dfsimallreps$rep), "simulations at\n", max(dfsimallreps$Years),"years after fire", sep = " ")
```

```{r}
summary_count <- dfsimallreps %>% 
  group_by(rep, Species) %>% 
  filter(Years == max(Years)) %>% 
  summarize(emerged = sum(emerged)) 

boxplot_trees <- ggplot(summary_count)+
  geom_boxplot(aes(x = Species, y = emerged))+
  theme_minimal()+
  ylab("Number of emerged trees")+
  ggtitle(title)
```

```{r}
summary_prop <- dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) 

summary_prop <- summary_prop %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species) %>% 
  filter(Years== max(Years)) %>% 
  summarize(emerged = sum(emerged)) %>% 
  mutate(prop_emerged = emerged/initial_n) 

summary_prop

boxplot_prop <- ggplot(summary_prop)+
  geom_boxplot(aes(x = Species, y = prop_emerged))+
  theme_minimal()+
  ylab("Proportion of initial trees")+
   ggtitle(title)

ggsave(file = "../../results/figures/Simulations/sim_100_emerge_prop_all2015.png", width = 6, height =4, dpi = 400)
```

```{r}
grid.arrange(boxplot_trees, boxplot_prop, ncol = 2)
```

```{r, echo = F}
print("The whole thing took")
Sys.time()-strt
```

# Are ending proportions significantly different between pine and fir?
```{r}
ggplot(summary_prop)+
  geom_histogram(aes(x = prop_emerged, fill = Species), bins =20)+
  theme_minimal()
glm <- glm(prop_emerged ~ Species, family = binomial, data = summary_prop, weights = initial_n)
summary(glm)
```


# What's different about the iterations where 100% of trees emerge?
```{r}
hundoP <- summary_prop %>% 
  ungroup() %>% 
  filter(prop_emerged==1) %>% 
  dplyr::select(rep) %>% 
  unlist()
hundoP
```

## What do the hundoP reps look like?
```{r}
ggplot(dfsimallreps %>% filter(rep %in% hundoP))+
  geom_smooth(aes(x = Years, y = Ht_cm1, group = rep))+
  geom_smooth(aes(x = Years, y = Ht1.3, group = rep), col = "red")
```

## Sensitivity to error in growth model
```{r}
dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species, error_pipo_gr) %>% 
  filter(Years== max(Years)) %>% 
  summarize(emerged = sum(emerged)) %>% 
  mutate(prop_emerged = emerged/initial_n) %>% 
  filter(Species == "PIPO") %>% 
  ggplot(aes(x = error_pipo_gr, y = prop_emerged))+
  geom_point()+
  geom_smooth()+
  theme_minimal()+
  ggtitle("PIPO")

dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species, error_abco_gr) %>% 
  filter(Years== max(Years)) %>% 
  summarize(emerged = sum(emerged)) %>% 
  mutate(prop_emerged = emerged/initial_n) %>% 
  filter(Species == "ABCO") %>% 
  ggplot(aes(x = error_abco_gr, y = prop_emerged))+
  geom_point()+
  geom_smooth()+
  theme_minimal()+
  ggtitle("ABCO")
```

## Sensitivity to error in mortality model
```{r}
dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species, coef_gr_mort_pipo) %>% 
  filter(Years== max(Years)) %>% 
  summarize(emerged = sum(emerged)) %>% 
  mutate(prop_emerged = emerged/initial_n) %>% 
  filter(Species == "PIPO") %>% 
  ggplot(aes(x = coef_gr_mort_pipo, y = prop_emerged))+
  geom_point()+
  geom_smooth()+
  theme_minimal()+
  ggtitle("PIPO")

dfsimallreps %>% 
  ungroup() %>% 
  group_by(Years, Species, rep) %>% 
  mutate(total= n()) %>% 
  ungroup() %>% 
  group_by(rep, Species) %>% 
  mutate(initial_n = max(total)) %>% 
  ungroup() %>% 
  group_by(rep, initial_n, Species, coef_gr_mort_abco) %>% 
  filter(Years== max(Years)) %>% 
  summarize(emerged = sum(emerged)) %>% 
  mutate(prop_emerged = emerged/initial_n) %>% 
  filter(Species == "ABCO") %>% 
  ggplot(aes(x = coef_gr_mort_abco, y = prop_emerged))+
  geom_point()+
  geom_smooth()+
  theme_minimal()+
  ggtitle("ABCO")
```


# Take home: the growth error terms super strongly affect the results! 

# Long-term goals

1.  Use Kristen's data or Hugh's data for initial conditions
2.  Improve dispersal kernel based on Kristen/Hugh's data 
4.  Include residual surviving trees and their seed dispersal
5.  Include seed dispersal of post-fire regen once it reaches reproductive age 
6.  Add customization of patch size and shape
8.  Change sapling growth equations once they emerge from the shrub canopy
9.  Update display of shrub competition after simulation years
7.  apply to King, American River Complex, rest of the fires I measured
5.  what does shrub competition mean for new recruitment?

