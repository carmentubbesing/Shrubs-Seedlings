---
title: "simulations_test"
author: "Carmen"
date: "2/11/2020"
output: html_document
---


```{r, include = F}
setwd("~/Shrubs-Seedlings/code/Simulations/")
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(sp)
require(tmaptools)
require(knitr)
require(mgcv)
require(gridExtra)
require(doParallel)
strt <- Sys.time()
```

# Load functions

#### Create shrub patch
```{r}
source("functions/shrubclump.R")
```

#### Initialization function
```{r}
source("functions/initialize.R")
```

#### Height growth functions
```{r}
source("functions/abcogrowth.R")
source("functions/pipogrowth.R")
```

#### Diameter growth functions
```{r}
source("functions/abcodia_footprints.R")
source("functions/pipodia_footprints.R")
```

#### Mortality functions
```{r}
source("functions/abcomort.R")
source("functions/pipomort.R")
```

#### Shrub growth functions
```{r}
source("functions/abco_shrubgrowth.R")
source("functions/pipo_shrubgrowth.R")
```

#### Simulation function
```{r}
source("functions/sim.R")
```

#### Iteration function
```{r}
source("functions/iterate.R")
```

# Define parameters
```{r}
fire <- "AMRC"
years <- 20
cumsum_2015 <- 0.441
cumsum_2016 <- 0.912
cumsum_2017 <- 1
iterations <- 2
max_shrub_ht_cm <- 250
max_shrub_ht_years <- 15
n_seedlings <- 100
length_m <- 40
height_m <- 40
lambda <- 4
shrub_clumpiness <- 7
```


# Initialize

## Create clumped shrub pattern
```{r}
shrubclump()
```

## Randomly select seedlings from data and place them on the shrub patch
```{r}
initialize()
```

## Plot patch with seedlings
```{r}
pts.sf.pipo.graph <- pts.sf.pipo %>% 
  rename("Pine height" = Ht_cm1)
pts.sf.abco.graph <- pts.sf.abco %>% 
  rename("Fir height" = Ht_cm1)
```

```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(col = "sqrt_shrubarea3", title = "Shrub competition index", palette = "Greys", alpha = .5)+
tm_shape(r)+
  tm_raster(col = "ShrubSpp03", alpha = .2, title = "Shrub species", palette = "Set1")+
  tm_layout(asp=1:1, legend.outside = T)+
tm_shape(pts.sf.pipo.graph)+
  tm_symbols(size = "Pine height", col = "darkgreen", size.max = 500, border.col = "white", border.lwd = .05)+
tm_shape(pts.sf.abco.graph)+
  tm_symbols(size = "Fir height", col = "darkblue", size.max = 500, border.col = "white", border.lwd = .05)
```

# Simulate across years
```{r, warning=FALSE}
time <- Sys.time()
suppressMessages(sim(years))
print(paste("One simulation run took", Sys.time()-time, "seconds"))
```

# Tests

### Plot # of new emergents each year
```{r}
dfsimall %>% 
  group_by(Years, Species) %>% 
  mutate(emerged = ifelse(
    Ht_cm1*.75>Ht1.3, 1, 0
  )) %>% 
  select(Sdlg, Species, ID_withinrep, Ht1.3, Ht_cm1, Years, emerged) %>% 
  group_by(Species, ID_withinrep) %>% 
  arrange(Years) %>% 
  mutate(cumsum_emerge = cumsum(emerged)) %>% 
  mutate(new_emerge = ifelse(cumsum_emerge ==1, 1, 0)) %>% 
  ungroup() %>% 
  group_by(Years, Species) %>% 
  summarize(new_emergents = sum(new_emerge)) %>% 
  ungroup() %>% 
  group_by(Species) %>% 
  arrange(Years) %>% 
  mutate(total_emergents = cumsum(new_emergents)) %>% 
  ggplot(aes(x = Years, y = total_emergents, col = Species))+
  geom_point()+
  geom_line()+
  theme_minimal()
```

### Shrub growth patterns
```{r}
ht <- ggplot(dfsimall)+
  geom_line(aes(x = Years, y = Ht1.3, col = ShrubSpp03, linetype = Species, group = Sdlg))+
  theme_bw()
```

```{r}
cov <- ggplot(dfsimall)+
  geom_line(aes(x = Years, y = Cov1.3, col = ShrubSpp03, linetype = Species, group = Sdlg))+
  theme_bw()
```

```{r}
grid.arrange(ht, cov, ncol = 2)
```

### Focal tree dia and ht growth patterns
```{r}
dia <- ggplot(dfsimall, aes(x = Years, y = dia.cm, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm, col = Species, group = Species))
```

```{r}
ht <- ggplot(dfsimall, aes(x = Years, y = Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = Ht_cm1, col = Species, group = Species))
```

```{r}
ratio <- ggplot(dfsimall, aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Sdlg))+
  geom_line(alpha = .3)+
  theme_bw()+
  geom_smooth(aes(x = Years, y = dia.cm/Ht_cm1, col = Species, group = Species))
```

```{r}
grid.arrange(dia, ht, ratio, ncol = 2)
```

### Diameter and height boxplots
```{r}
all_dia <- ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))+
  theme(legend.position="none")
```

```{r}
strt_dia <- ggplot(dfsimall %>% filter(Years<11))+
  geom_boxplot(aes(x = as.factor(Years), y = dia.cm, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  ggtitle("Diameter distribution after\nfirst simulation year")
```

```{r}
all_ht <- ggplot(dfsimall)+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Height (cm)")+
  scale_x_discrete(name = "Years since fire", breaks = c("10", "15", "20", "25"))+
  theme(legend.position="none")
```

```{r}
strt_ht <- ggplot(dfsimall %>% filter(Years<11))+
  geom_boxplot(aes(x = as.factor(Years), y = Ht_cm1, fill = Species))+
  theme_minimal()+
  xlab("Years")+
  ylab("Diameter (cm)")+
  ggtitle("Diameter distribution after\nfirst simulation year")
```

```{r}
grid.arrange(strt_dia, all_dia, strt_ht, all_ht)
```

## Plot shrub patch spatially
```{r}
pts.sf.pipo.graph <- pts.sf.pipo %>% 
  rename("Pine height (cm)" = Ht_cm1)
pts.sf.abco.graph <- pts.sf.abco %>% 
  rename("Fir height (cm)" = Ht_cm1)
```

```{r}
tm_shape(p)+
  tm_borders(col = "black", lwd= 5)+
tm_shape(r)+
  tm_raster(col = "sqrt_shrubarea3", title = "Shrub competition index", palette = "Greys", alpha = .5)+
tm_shape(r)+
  tm_raster(col = "ShrubSpp03", alpha = .7, title = "Shrub species", palette = "Pastel1")+
  tm_layout(asp=1:1, legend.outside = T, legend.title.size = 4, legend.text.size = 2)+
tm_shape(pts.sf.pipo.graph)+
  tm_symbols(size = "Pine height (cm)", col = "#DCC960", size.max = 300, border.lwd = 3)+
tm_shape(pts.sf.abco.graph)+
  tm_symbols(size = "Fir height (cm)", col = "#899DA4", size.max = 300, border.lwd = 3)
```
