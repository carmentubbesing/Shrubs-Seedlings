---
title: "analyze_vertical_growth"
author: "Carmen"
date: "November 9, 2017"
output: 
    html_document:
        toc: TRUE
---

This code analyzes how shrub removal affected seedling vertical growth.

```{r, include = F}
library(dplyr)
library(readxl)
library(ggplot2)
library(nlme)
library(effects)
```

# Load data
```{r}
df <- read.csv(file = "~/../Dropbox (Stephens Lab)/Shrub_experiment/Data/JOINED_DATA/df_vert.csv")
dfshrub <- read.csv(file = "~/../Dropbox (Stephens Lab)/Shrub_experiment/Data/JOINED_DATA/dfshrub.csv")
```

# Add shrub data
```{r}
df <- full_join(df, dfshrub)
summary(df$shrubarea)
```

# Stats

## Look at sample sizes
```{r}
df %>% group_by(species, shrub_species, shrubs) %>% 
  summarise(n())
```


## Use multiple regression on sqrt(gr_17_over_16), including retained/removed, seedling height, shrub species, and seedling species, AND interaction between removal and seedling species and height and removal
```{r}
LM1 <- lm(sqrt(gr_17_over_16) ~ shrubs + ht_cm +  species + shrub_species + shrubs:species, data = df)
LM1_noremoval <- lm(sqrt(gr_17_over_16) ~ ht_cm + species + shrub_species, data = df)
summary(LM1)
drop1(LM1, test = "F")
anova(LM1, LM1_noremoval)
```

# Look at residuals
```{r}
E <- residuals(LM1)
pred <- predict(LM1)
plot(LM1, which=c(1))
plot(df$shrubs, E)
plot(df$species, E)
plot(df$shrub_species, E)
```

## Use multiple regression on sqrt(gr_17_over_16)
including retained/removed, seedling height, shrub species, pre-removal shrub area, and seedling species, AND interaction between removal and seedling species
```{r}
LM1 <- lm(sqrt(gr_17_over_16) ~ shrubs + ht_cm +  species + shrub_species + shrubs:species + shrubs:ht_cm + shrubarea, data = df)
LM1_noremoval <- lm(sqrt(gr_17_over_16) ~ ht_cm + species + shrub_species + shrubarea, data = df)
drop1(LM1, test = "F")
anova(LM1, LM1_noremoval)
```

### Look at residuals
```{r}
E <- residuals(LM1)
pred <- predict(LM1)
plot(LM1, which=c(1))
plot(df$shrubs, E)
plot(df$species, E)
plot(df$shrub_species, E)
plot(df$shrubarea, E)
```

```{r}
df %>% 
  group_by(species, shrubs) %>% 
  summarise(mean(gr_2017_rel))
```

```{r}
s
```


## Mixed effects with island effect
```{r}
MM1 <- lme(sqrt(gr_17_over_16) ~ shrubs + ht_cm +  species + shrub_species + shrubarea + shrubs:species + shrubs:shrub_species + shrubs:ht_cm, random =~1|island, data = df, method = "ML")
MM1_noremoval <- lme(sqrt(gr_17_over_16) ~ ht_cm + species + shrub_species + shrubarea, random =~1|island, method = "ML",data = df)
anova(MM1, MM1_noremoval)
```

### Residuals
```{r}
E <- residuals(MM1)
pred <- predict(MM1)
plot(MM1, which=c(1))
plot(df$shrubs, E)
plot(df$species, E)
plot(df$shrub_species, E)
```

## Outlier: Strangely low growth in 2016 - throw it out 
```{r}
df <- df[E<1.3,]
```


## Re-run analyses

### No random effect
```{r}
LM1 <- lm(sqrt(gr_17_over_16) ~ shrubs + ht_cm +  species + shrub_species + shrubarea + shrubs:species + shrubs:shrub_species + shrubs:ht_cm, data = df)
LM1_noremoval <- lm(sqrt(gr_17_over_16) ~ ht_cm + species + shrub_species + shrubarea, data = df)
drop1(LM1, test = "F")
anova(LM1, LM1_noremoval)
AIC(LM1)
```

### Mixed effects with island effect
```{r}
MM1 <- lme(sqrt(gr_17_over_16) ~ shrubs + ht_cm +  species + shrubarea + shrub_species + shrubs:species + shrubs:shrub_species + shrubs:ht_cm, random =~1|island, data = df, method = "ML")
MM1_noremoval <- lme(sqrt(gr_17_over_16) ~ ht_cm + species + shrub_species + shrubarea, random =~1|island, method = "ML",data = df)
anova(MM1, MM1_noremoval)
```



# Result: shrub removal POSITIVELY affected seedling vertical growth

# Plot predictions

### Create MyData
```{r}
MyData <- expand.grid(shrubs = c("retained", "removed"), ht_cm = c(seq(10,300, length = 20)), species = c("ABCO", "PIPO"), shrub_species = c("CEIN","CECO","ARPA"), shrubarea = seq(33000,120000, length = 20))
```

## Mixed effects model with island effect

```{r}
MyData$predMM <- predict(MM1, level = 0, newdata = MyData)
```

### Overall effect
```{r}
MyData_summary <- MyData %>% 
  group_by(shrubs, shrub_species, species) %>% 
  summarise(mean_predMM = mean(predMM))

figure <- ggplot(MyData_summary,aes(x = shrubs, y = (mean_predMM)^2)) +
  geom_point(aes(col = species, shape = shrub_species), size = 2)+
  geom_line(aes(col = species, linetype = shrub_species, group = interaction(shrub_species, species)))+
  theme_bw()+
  scale_color_manual(values=c("#1a9850", "#d73027"))+
  labs(y = expression(paste("predicted  ", frac("2017 relative vertical growth","2016 relative vertical growth"))))+
  ggtitle("Removal plots had lower relative vertical growth")
figure
setwd("~/../Dropbox (Stephens Lab)/Shrub_experiment/results/figures/")
png("vert_growth.png")
figure
dev.off()
```

### Plot effect of height
```{r}
MyData$ht_cm <- as.numeric(paste(MyData$ht_cm))
ggplot(MyData)+
  geom_line(aes(x = ht_cm, y = (predMM^2), group = interaction(shrub_species, shrubs, species, shrubarea), col = interaction(species, shrub_species), linetype = shrubs))+
  scale_color_manual(values = c('#d73027','#66bd63','#f46d43','#a6d96a','#fdae61','#1a9850'))+
  theme_bw()+
  ggtitle("The effect of removal was stronger for larger seedlings")+
  labs(y = expression(paste("Predicted  ", frac("2017 relative vertical growth","2016 relative vertical growth"))))+
  labs(x = "Seedling height in 2017 (cm)")
```

The taller the seedling, the greater effect of removal. Huh!

### Effect of pre-treatment shrub cover was small within the range sampled
```{r}
MyData_shrubarea_summary <- MyData %>% 
  group_by(species, shrubs, shrubarea) %>% 
  summarise(predMM = mean(predMM))
ggplot(MyData_shrubarea_summary)+
  geom_line(aes(x = shrubarea, y = (predMM^2), group = interaction(shrubs, species), linetype = shrubs, col = species))
```

#Save final data frame
```{r}
save(df, file = "~/../Dropbox (Stephens Lab)/Shrub_experiment/Data/JOINED_DATA/df_vert_final.Rdata")
```

