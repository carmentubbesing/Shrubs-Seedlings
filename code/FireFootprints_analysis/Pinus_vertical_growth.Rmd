---
title: 'Pinus with shrubarea vertical analysis - fire footprints'
author: "Carmen"
date: "March 9 + 2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r, include = F}
require(nlme)
require(randomForest)
require(tree)
require(knitr)
require(tidyverse)
require(ggplot2)
require(VSURF)
require(effects)
require(MuMIn)
require(car)
set.seed(12346)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/code/FireFootprints_analysis/")
load(file="../../compiled_data/fire_footprints/master_seedlings_vert.Rdata")
```

## Filter to just PIPO
```{r}
df %>% 
  filter(Species == "PIPO") %>% 
  group_by(Fire) %>% 
  summarize(n()) %>% 
  arrange(`n()`)
df <- df %>% 
  filter(Species == "PIPO")
```

## Change species and Sdlg and soil order to factor
```{r}
df <- df %>% 
  mutate(Species = as.factor(Species)) %>% 
  mutate(Sdlg = as.factor(Sdlg)) %>% 
  mutate(soil_order = as.factor(soil_order))
df <- droplevels(df)
```

# Convert shrub area to log scale
```{r}
df <- df %>% 
  mutate(sqrt_shrubarea3 = sqrt(shrubarea3))
```


# Count the seedlings
```{r}
length(unique(df$Sdlg))
nrow(df)
```

# Try using VSURF

## Make df of just the predictor variables I want to include
```{r}
xdf <- df %>% 
  dplyr::select(Elevation,
         Slope.Deg,
         heatload,
         incidrad,
         Aspect.rad.fold.NESW,
         siteclass,
         Year,
         Years,
         BasDia2016.cm, 
         Ht_cm1,
         sqrt_shrubarea3,
         ShrubSpp03) 
```

## Normalize the numeric ones
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
xdf <- xdf %>% mutate_if(is.numeric, normalize)
```

# Find average growth rate
```{r}
mean(df$VertGrowth_Rel)
sd(df$VertGrowth_Rel)
sd(df$VertGrowth_Rel)/sqrt(nrow(df))
ggplot(df)+
  geom_boxplot(aes(y = VertGrowth_Rel))
```

# Run a random forest on everything
```{r}
forest <- randomForest(
     x = xdf,
     y = df$VertGrowth_Rel, 
     importance = TRUE, 
     scale = TRUE, 
     ntree=5000)
varImpPlot(forest)
```

<!-- # STOP HERE TO SAVE TIME -->

<!-- # Apply VSURF to vertical growth -->
<!-- ```{r} -->
<!-- vsurf <- VSURF(x = xdf, -->
<!--                y = df$VertGrowth_Rel, -->
<!--                na.action = na.omit, -->
<!--                parallel = T) -->
<!-- summary(vsurf) -->
<!-- vsurf$varselect.pred -->
<!-- xdf[vsurf$varselect.pred] -->
<!-- ``` -->

<!-- ## Save the results -->
<!-- ```{r} -->
<!-- vars <- names(xdf[vsurf$varselect.pred]) -->
<!-- vars -->
<!-- ``` -->

# RESUME HERE

## Look at final random forest
```{r}
forest <- randomForest(
  x = xdf %>%
    select(vars),
  y = df$VertGrowth_Rel,
  importance = TRUE,
  scale = TRUE)
varImpPlot(forest)
```

# Look at a linear model using the variables that were identified by VSURF, plus interactions that seem biologically meaningful

## Structure data for LM
```{r}
LMdf <- df %>% 
  mutate(sqrt_shrubarea3 = sqrt(shrubarea3)) %>%
  mutate(log_shrubarea3 = log(shrubarea3+1)) %>%
  select(Fire, 
         Sdlg, 
         VertGrowth_Rel, 
         Years, 
         Ht_cm1, 
         shrubarea3, 
         sqrt_shrubarea3, 
         log_shrubarea3, 
         BasDia2016.cm, 
         incidrad, 
         Year, 
         Elevation, 
         heatload, 
         ShrubSpp03) %>% 
 mutate_if(is.numeric, normalize) %>% 
  mutate(VertGrowth_Rel = df$VertGrowth_Rel)
LMdf <- droplevels(LMdf)
```

```{r}
vars
LM <- lme(VertGrowth_Rel ~  Years +  Ht_cm1 + shrubarea3 + heatload + incidrad + Year + ShrubSpp03,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
summary(LM)
```

## Check collinearity

### Compare Zuur model with vif function from car package
```{r}
source("~/../Documents/HighstatLibV10.R.txt") # from Zuur https://highstat.com/index.php/mixed-effects-models-and-extensions-in-ecology-with-r
corvif(LMdf[c("Years", "Ht_cm1", "shrubarea3", "heatload", "incidrad", "Year", "ShrubSpp03")])
vif(LM)
```

A VIF cutoff value of 5 is often used, and none of my variables have values larger than that, so I think I'm ok.

## See whether model with shrubarea2 or sqrt_shrubarea2 is better
```{r}
none <- lme(VertGrowth_Rel ~ 
         Years +  Ht_cm1 + shrubarea3 + heatload +  incidrad + Year + ShrubSpp03, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
AIC(none)

sqrt <- lme(VertGrowth_Rel ~  
          Years +  Ht_cm1 + sqrt_shrubarea3 + heatload +  incidrad + Year + ShrubSpp03, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
AIC(sqrt)

AIC(lme(VertGrowth_Rel ~  
           Years +  Ht_cm1 + log_shrubarea3 + heatload +  incidrad + Year + ShrubSpp03, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML"))
```

Square root transformed wins

## See whether model with or without interaction is better
```{r}
without <- lme(VertGrowth_Rel ~ 
           Years +  Ht_cm1 + sqrt_shrubarea3 + heatload +  incidrad + Year+ ShrubSpp03,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
AIC(without)
with <- lme(VertGrowth_Rel ~  
           Years +  Ht_cm1*sqrt_shrubarea3 + heatload +  incidrad + Year+ ShrubSpp03,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
AIC(with)
anova(with, without)
```

Without wins.

## Look at drop1 results
```{r}
LM <-  lme(VertGrowth_Rel ~ 
            Years +  Ht_cm1 + sqrt_shrubarea3 + heatload +  incidrad + Year + ShrubSpp03,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
summary(LM)
drop <- drop1(LM, test = "Chisq")
drop$var <- row.names(drop)
drop <- tbl_df(drop)
drop %>% 
  arrange( `Pr(>Chi)`) %>% 
  mutate( `Pr(>Chi)` = paste( `Pr(>Chi)`))
```

No need to include interaction after all

# See whether residuals are better for log transformed or not
```{r}
LM <-  lme(VertGrowth_Rel ~ 
            Years +  Ht_cm1 + sqrt_shrubarea3 + heatload +  incidrad + Year + ShrubSpp03,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
plot(LM)
```

```{r}
LM <-  lme(exp(VertGrowth_Rel) ~ 
            Years +  Ht_cm1 + sqrt_shrubarea3 + heatload +  incidrad + Year+ ShrubSpp03,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
plot(LM)
```

Log transformed looks better 

# Re-establish the best LM so far:
```{r}
LM <-  lme(VertGrowth_Rel ~ 
           Years +  Ht_cm1 + sqrt_shrubarea3 + heatload +  incidrad + Year+ ShrubSpp03,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

Note: Chisq here is performing likelihood ratio tests

# Look at residuals

### Residuals
```{r}
E <- resid(LM, type = "normalized")
df$E <- E
pred <- predict(LM)
plot(LM)
plot(df$shrubarea3, E)
plot(df$Ht_cm1, E)
plot(df$Years, E)
plot(df$Ht1.3, E)
plot(df$BasDia2016.cm, E)
plot(df$incidrad, E)
plot(df$Year, E)
ggplot(df, aes(x = log(df$shrubarea3), y = E))+
  geom_point()+
  geom_smooth()
```

# Look at individual effects

Note: the plots look exactly the same but with different axes if you don't normalize the numeric predictors. So for including plots to visualize in the paper, I just use non-normalized data

```{r}
eff_years <- predictorEffect("Years", LM)
plot(eff_years)

eff_shrubarea <- predictorEffect("sqrt_shrubarea3", LM)
plot(eff_shrubarea)

eff_ht <- predictorEffect("Ht_cm1", LM)
plot(eff_ht)

plot(predictorEffect("Year", LM))

plot(predictorEffect("ShrubSpp03", LM))
```

# Calculate Nakagawa's pseudo R2
```{r}
r.squaredGLMM(LM)
```

# Re-create effects plots using predictorEffects() and ggplot

```{r}
eff_shrubarea <- predictorEffect("sqrt_shrubarea3", LM)
effects_df <- as.data.frame(eff_shrubarea)
head(effects_df)
```

## Transform variables back to original units
```{r}
effects_df <- effects_df %>% 
  mutate(sqrt_shrubarea3 = sqrt_shrubarea3*sd(sqrt(df$shrubarea3))+mean(sqrt(df$shrubarea3)) )
effects_df
```

### test
```{r}
hist(effects_df$sqrt_shrubarea3)
hist(sqrt(df$shrubarea3))
```


## Plot effects of shrubarea
```{r}
ggplot(effects_df)+
  geom_line(aes(x = sqrt_shrubarea3, y = exp(fit)))+
  geom_ribbon(aes(x = sqrt_shrubarea3, ymin = exp(lower), ymax = exp(upper)), alpha = .5, fill = "#fdbb84")+
  theme_bw()+
  #xlab("                                  Shrub competition")+
  xlab(bquote('                           Shrub competition ' ))+
  ylab("Relative growth rate")+
  #ggtitle("Pine growth in relation to shrub environment within 2 m")+
  geom_rug(data = df, aes(x = sqrt(shrubarea3), y = exp(VertGrowth_Rel)), alpha = .5, position = "jitter", sides = "b")+
  ylim(c(0.04,0.3))+
  labs(fill = "Juvenile tree height (cm)")+
  theme(text = element_text(size = 11),
        #panel.grid.minor = element_blank(),
        panel.grid.major = element_blank())
ggsave(file = "../../results/figures/FireFootprints/PineVertRel.png", width = 3, height = 3, dpi = 400)
```

# Look at relationship between years and shrubarea
```{r}
ggplot(df)+
  geom_boxplot(aes(x = Fire, y = shrubarea3))
ggplot(df)+
  geom_boxplot(aes(x = as.factor(Years), y = shrubarea3))
```

# Find the shrubarea values associated with each quartile, and the mean growth for each of those
```{r}
summary <- summary(sqrt(df$shrubarea3))
quart1 <- summary[2]
quart3 <- summary[5]
median <- summary[3]
min <- summary[1]
max <- summary[6]
mean <- mean(sqrt(df$shrubarea3))

fit_quart1 <- effects_df[which.min(abs(effects_df$sqrt_shrubarea3 - quart1)),]$fit
fit_quart1
fit_quart3 <- effects_df[which.min(abs(effects_df$sqrt_shrubarea3 - quart3)),]$fit
fit_median <- effects_df[which.min(abs(effects_df$sqrt_shrubarea3 - median)),]$fit
fit_min <- effects_df[which.min(abs(effects_df$sqrt_shrubarea3 - min)),]$fit
fit_max <- effects_df[which.min(abs(effects_df$sqrt_shrubarea3 - max)),]$fit
fit_mean <- effects_df[which.min(abs(effects_df$sqrt_shrubarea3 - mean)),]$fit
mean <- mean(df$shrubarea3/10000)
print(paste("fit_quart1 = ", exp(fit_quart1)))
print(paste("fit_quart3 = ", exp(fit_quart3)))
print(paste("fit_median = ", exp(fit_median)))
print(paste("fit_min = ", exp(fit_min)))
print(paste("fit_max = ", exp(fit_max)))


print(paste("fit_quart1_log = ", fit_quart1))
print(paste("fit_quart3_log = ", fit_quart3))
print(paste("fit_median_log = ", fit_median))
print(paste("fit_min_log = ", fit_min))
print(paste("fit_max_log = ", fit_max))
print(paste("fit_mean_log = ", fit_mean))
```

```{r}

sd <- sd(df$shrubarea3/10000)
```

# Pretty plot of shrub species effects
```{r}
eff_shrubspp <- predictorEffect("ShrubSpp03", LM)
effects_df <- as.data.frame(eff_shrubspp)
head(effects_df)
```

```{r}
ggplot(effects_df)+
  geom_point(aes(x = ShrubSpp03, y = exp(fit)))+
  ylab("Juvenile pine relative growth rate")+
  theme_bw()+
  geom_errorbar(aes(x = ShrubSpp03, ymin=exp(lower), ymax=exp(upper)), width=.1) +
  scale_x_discrete(labels=c("ARPA" = "Arctostaphylos",
                            "CECO" = "Ceanothus\ncordulatus",
                            "CEIN" = "Ceanothus\nintegerrimus",
                            "CHFO" = "Chamaebatia\nfoliolosa",
                            "LIDE" = "Notholithocarpus\ndensiflorus"
                            ))+
  theme(  text = element_text(size = 11),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text.x = element_text(face = "bold.italic",
                                   angle=45, 
                                   vjust=1, 
                                   hjust=1))+
  xlab("Dominant shrub species")
  


 ggsave(file = "../../results/figures/FireFootprints/PineVertShrubSpp.png", width = 4, height = 4, dpi = 400)
```



## Save final data
```{r}
save(df, file ="~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/pine_vert.Rdata")
```
