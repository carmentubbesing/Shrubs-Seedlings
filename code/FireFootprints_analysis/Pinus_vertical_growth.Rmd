---
title: 'Analysis 6: Pinus with shrubarea vertical analysis - fire footprints'
author: "Carmen"
date: "March 9 + 2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r, include = F}
require(nlme)
require(randomForest)
require(tree)
require(knitr)
require(dplyr)
require(tidyr)
require(ggplot2)
library(effects)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
```

# Load data
```{r, include=F}
setwd("~/Shrubs-Seedlings/compiled_data/")
load(file="fire_footprints/master_seedlings2.Rdata")
```

## Filter to just pines
```{r}
df <- df[df$Species%in%c("PIPO","PILA") & !df$Fire %in% c("PLKN","WRTS"),]
```

## Change species to factor
```{r}
df <- df %>% 
  mutate(Species = as.factor(Species))
```


# Normalize variables that still need it

```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
```

```{r}
df <- df %>% 
  mutate(Cov1.2_norm = normalize(Cov1.2)) %>% 
  mutate(Cov1.3_norm = normalize(Cov1.3))
```

# Conditional inference tree
```{r}
tree_df <- tree(VertGrowth_Rel ~  Fire + FirePatch + Year + Species + Ht_cm + shrubarea2 + shrubarea3 + Cov1 + Cov1.2 + Cov1.3 + Ht1 + Ht1.2 + Ht1.3, df)
summary(tree_df)
plot(tree_df)
text(tree_df, pretty = 0)
pruned <- prune.tree(tree_df, best = 5)
plot(pruned)
text(pruned, pretty = 0)
```


## Look at random forest
```{r}
fit <- randomForest(formula = VertGrowth_Rel ~ Fire + Year + Species + Ht_cm + shrubarea2 + shrubarea3 + Cov1 + Cov1.2 + Cov1.3 + Ht1 + Ht1.2 + Ht1.3 + Spp1 + Spp2 + Spp3 + IAG, 
                    data = df,
                    importance = TRUE,
                    mtry = 13)
fit
varImpPlot(fit)
```

## See how well random forest predicts data
```{r}
train = sample(1:nrow(df), nrow(df)/2)
tree_train = randomForest(formula = VertGrowth_Rel ~ Fire + Year + Species + Ht_cm + shrubarea2 + shrubarea3 + Cov1 + Cov1.2 + Cov1.3 + Ht1 + Ht1.2 + Ht1.3 + Spp1 + Spp2 + Spp3 + IAG, 
                    data = df,
                    importance = TRUE,
                    mtry = 13,
                    subset = train)
yhat.bag = predict(tree_train, newdata = df[-train,])
growth.test = unlist(df[-train, "VertGrowth_Rel"])
plot(yhat.bag, growth.test)
abline(0,1)
```

# Look for patterns in residuals of mixed effects model
```{r}
M1 <- lme(VertGrowth_Rel ~ Year + Species + Ht_cm + shrubarea2 + shrubarea3 + Cov1 + Cov1.2 + Cov1.3 + Ht1 + Ht1.2 + Ht1.3 + Spp1 , random = ~1|FirePatch, data= df) 
anova(M1)
```

```{r}
E <- resid(M1, type="normalized")
coplot(E ~ Ht_cm | Fire, data=df, ylab="Normalized residuals", col=df$Fire)
```

## Predictions - perfect data
```{r}
MyData <-  rbind(
  expand.grid( 
    Fire = unique(df$Fire), 
    Year = unique(df$Year), 
    shrubarea2 = seq(min(df$shrubarea2), max(df$shrubarea2), length = 100),
    Ht_cm = mean(df$Ht_cm),
    Species = c("PIPO","PILA"),
    ShrG1 = unique(df$ShrG1)
    )
)
```

### "Normalize"" MyData variables

```{r}
MyData$Ht_norm <- (MyData$Ht_cm - mean(df$Ht_cm))/sd(df$Ht_cm)
MyData$shrubarea2_sqrt <- sqrt(MyData$shrubarea2)
MyData$shrubarea2_sqrt_norm <- 
  (MyData$shrubarea2_sqrt - 
     mean(sqrt(df$shrubarea2))
   )/sd(sqrt(df$shrubarea2))
```


## Save final data
```{r}
save(df, file ="~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/pinus_vert.Rdata")
```

## Different approach (Nov 13, 2017) - no AIC table, just pick variables based on preliminary knowledge
```{r}
f <- VertGrowth_Rel ~  Year + shrubarea2_sqrt_norm + Ht_norm + ShrG1 + shrubarea2_sqrt_norm*Ht_norm
f_noshrubs <- VertGrowth_Rel ~  Year + Ht_norm  + ShrG1
LM1 <- lme(f,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "ML")
LM1_noshrubs <- lme(f_noshrubs,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "ML")
anova(LM1, LM1_noshrubs)
```

## Find all possible variable combinations
```{r}
v1 <- c("shrubarea2_sqrt_norm", "Cov1.2_norm" , "Cov1.3_norm" , "IAG", "ShrG1", "shrubarea2_sqrt_norm*Ht_norm")
combs <- do.call("c", lapply(seq_along(v1), function(i) combn(v1, i, FUN = list)))
list.bad <- list()
for(i in 1:length(combs)){
  if("Cov1.2_norm" %in% combs[i][[1]] & "Cov1.3_norm" %in% combs[i][[1]])
    {
    list.bad <- c(list.bad, i)
    }
  if("shrubarea2_sqrt_norm" %in% combs[i][[1]] & ("Cov1.2_norm" %in% combs[i][[1]] | "Cov1.3_norm" %in% combs[i][[1]]     )){
    list.bad <- c(list.bad, i)
    } 
}
list.bad <- unlist(list.bad)
combs.bad <- combs[list.bad]
combs <- setdiff(combs, combs.bad)
length(combs)
```

## Table
```{r}
table <- data.frame(Model = character(), Formula = character(), AIC = numeric())
for(i in 1:length(combs)){
  vars <- combs[i]
  vars <- paste(vars[[1]], collapse="+")
  f <- formula(paste("(VertGrowth_Rel ~  Year  + Ht_norm +", vars,")"))
  M <- lme(f,data = df, random = list(~ 1| Fire, ~1| Sdlg))
  ModelName <- paste("M", i, sep="_")
  add <- data.frame(c(ModelName),c(vars), c(AIC(M)))
  table <- rbind(table, add)
}
colnames(table) <- c("Model","Variables", "AIC")
table_final <- kable(table %>% arrange(AIC), format = "markdown") 
table_final
```


## Compare best model to null

## AIC model selection shows that this is the best model, when year and height are included:
```{r}
f <- VertGrowth_Rel ~  Year + shrubarea2_sqrt_norm + Ht_norm 
f_null <- VertGrowth_Rel ~  Year + Ht_norm 
LM2 <- lme(f,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "ML")
LM2_null <- lme(f_null,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "ML")
anova(LM2, LM2_null)
```

# Add gls
```{r}
LM3 <- lme(f,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "REML", weights = varExp(form=~Ht_norm))
LM2 <- lme(f,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "REML")
anova(LM3, LM2)
```

# THIS IS THE BEST:
```{r}
f <- VertGrowth_Rel ~  Year + shrubarea2_sqrt_norm + Ht_norm 
f_null <- VertGrowth_Rel ~  Year + Ht_norm 
LM3 <- lme(f,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "ML", weights = varExp(form=~Ht_norm))
LM3_null <- lme(f_null,data = df, random = list(~ 1| Fire, ~1| Sdlg), method = "ML")
anova(LM3, LM3_null)
```

```{r}
summary(LM3)
```


# Plot again with new best model
```{r}
MyData$pred_simple <- predict(LM3, level = 0,newdata = MyData)
```

```{r}
MyData_summary_simple <- MyData %>% 
  group_by(shrubarea2) %>% 
  mutate(pred_simple = mean(pred_simple))
MyData_summary_simple
figure_summary <- ggplot(MyData_summary_simple)+
  labs(title = "Pine seedling vertical growth")+
  ylab("relative growth (cm/cm)")+
  xlab(
    expression(
      atop(
        sqrt("shrub cover * shrub height"),
    paste("0-2 m from seedling")))
    )+
  geom_line(aes(y = pred_simple, x = sqrt(shrubarea2)), size = 1.5, col = "#a02313")+
  geom_point(data=df, aes(x = sqrt(shrubarea2), y = VertGrowth_Rel), col = "#a02313")+
  theme_bw()+
  theme(
    plot.background = element_rect(fill = '#e9ebe8', colour = '#e9ebe8'),
        panel.background = element_rect(fill="#e9ebe8"),
        text = element_text(size=20),
        axis.title = element_text(colour = "#a02313"),
        plot.title = element_text(colour = "#a02313")
    )
figure_summary
```

```{r}
E <- resid(LM3, type="normalized")
plot(LM3)
plot(sqrt(df$shrubarea2), E)
plot((df$Ht_norm), E)
coplot(E ~ Ht_cm | Fire, data=df, ylab="Normalized residuals", col=df$Fire)
```

# Save figure
```{r}
setwd("C:/Users/Carmen/Documents/Shrubs-Seedlings/results/figures")
pdf("pine_vert.pdf", width = 5.5, height = 8, pointsize = 30,useDingbats = F)
figure_summary
dev.off()
```

# Calculate pseudo r squared
```{r}
meanGrth <- mean(df$VertGrowth_Rel)
sse <- (df$VertGrowth_Rel - predict(LM3))^2
sst <- (df$VertGrowth_Rel - meanGrth)^2
R2 <- 1 - (sum(sse)/sum(sst))
R2
```


