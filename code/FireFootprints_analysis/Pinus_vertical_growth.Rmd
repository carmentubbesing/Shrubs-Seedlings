---
title: 'Pinus with shrubarea vertical analysis - fire footprints'
author: "Carmen"
date: "March 9 + 2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r, include = F}
require(nlme)
require(randomForest)
require(tree)
require(knitr)
require(tidyverse)
require(ggplot2)
require(VSURF)
require(effects)
set.seed(12346)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/code/FireFootprints_analysis/")
load(file="../../compiled_data/fire_footprints/master_seedlings_vert.Rdata")
```

## Filter to just PIPO
```{r}
df %>% 
  filter(Species == "PIPO") %>% 
  group_by(Fire) %>% 
  summarize(n()) %>% 
  arrange(`n()`)
df <- df %>% 
  filter(Species == "PIPO")
```

## Change species and Sdlg to factor
```{r}
df <- df %>% 
  mutate(Species = as.factor(Species)) %>% 
  mutate(Sdlg = as.factor(Sdlg)) 
summary(df$Species)
summary(df$Sdlg)

```

# Count the seedlings
```{r}
length(unique(df$Sdlg))
nrow(df)
```

# Try using VSURF

## Make df of just the predictor variables I want to include
```{r}
xdf <- df %>% 
  select(Elevation,
         Slope.Deg,
         heatload,
         incidrad,
         Year,
         Years,
         BasDia2016.cm, 
         Ht_cm1,
         shrubarea1,
         shrubarea2, 
         shrubarea3,
         ShrubSpp01, 
         ShrubSpp02, 
         ShrubSpp03
         ) 
```

## Normalize the numeric ones
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
xdf <- xdf %>% mutate_if(is.numeric, normalize)
```

# Find average growth rate
```{r}
mean(df$VertGrowth_Rel)
sd(df$VertGrowth_Rel)
sd(df$VertGrowth_Rel)/sqrt(nrow(df))
ggplot(df)+
  geom_boxplot(aes(y = VertGrowth_Rel))
```

# Run a random forest on everything
```{r}
forest <- randomForest(
     x = xdf,
     y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE, ntree=5000)
varImpPlot(forest)
```


# STOP HERE TO SAVE TIME

## Apply VSURF to vertical growth
```{r}
vsurf <- VSURF(x = xdf, 
               y = df$VertGrowth_Rel, 
               na.action = na.omit,
               parallel = T)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Check out shrubarea1/shrubarea2 

### See how correlated they are
```{r}
ggplot(df, aes(x = shrubarea1, y = shrubarea2))+
  geom_point()+
  geom_smooth(method = "loess")
```

### Run 10 random forests on the ones that come up to see whether to delete heatload or incidrad
```{r}
forests100 <- function(vars){
  forest <- randomForest(
    x = xdf %>% select(Years, Ht_cm1, shrubarea2, shrubarea1, Year, ShrubSpp01, BasDia2016.cm, incidrad), 
    y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
  forest$importance
  imp <- as.data.frame(forest$importance) 
  imp$var <- row.names(imp)
  imp <- imp %>% filter(var %in% vars)
  imp %>% filter(`%IncMSE` == max(imp$`%IncMSE`)) %>% select(var)
}
forests100(c("shrubarea1", "shrubarea2"))
reps <- replicate(100, forests100(c("shrubarea3", "shrubarea2")))
summary(as.factor(unlist(reps)))
```

This shows that shrubarea2 is better, so delete shrubarea1.

### Delete SHRUBAREA1 and SHRUBAREA3 based on the results of the above randomforest
```{r}
xdf <- xdf %>% 
  select(-shrubarea1, -shrubarea3)
```

### Then run VSURF again
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Repeat for heatload and incidrad

### See how correlated they are
```{r}
ggplot(df, aes(x = heatload, y = incidrad))+
  geom_point()+
  geom_smooth(method = "loess")
```

### Run 100 random forests on the ones that come up to see whether to delete heatload or incidrad
```{r}
forests100 <- function(vars){
  forest <- randomForest(
    x = xdf %>% select(Years, Ht_cm1, shrubarea2, heatload, Year, ShrubSpp01, BasDia2016.cm, incidrad), 
    y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
  forest$importance
  imp <- as.data.frame(forest$importance) 
  imp$var <- row.names(imp)
  imp <- imp %>% filter(var %in% vars)
  imp %>% filter(`%IncMSE` == max(imp$`%IncMSE`)) %>% select(var)
}
forests100(c("heatload", "incidrad"))
reps <- replicate(100, forests100(c("heatload", "incidrad")))
summary(as.factor(unlist(reps)))
```

This shows that heatload is better, so delete incidrad.

### Delete INCIDRAD based on the results of the above randomforest
```{r}
xdf <- xdf %>% 
  select(-incidrad)
```

### Then run VSURF again
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

# RESUME HERE

## Look at final random forest
```{r}
forest <- randomForest(
  x = xdf %>% 
    select(Years, Ht_cm1, shrubarea2, BasDia2016.cm, ShrubSpp01, Year, Elevation), 
  y = df$VertGrowth_Rel, 
  importance = TRUE, 
  scale = TRUE)
varImpPlot(forest)
```


# Look at a linear model using the variables that were identified by VSURF, plus interactions that seem biologically meaningful

## Structure data for LM
```{r}
LMdf <- df %>% 
  mutate(sqrt_shrubarea2 = sqrt(shrubarea2)) %>%
  mutate(log_shrubarea2 = log(shrubarea2+1)) %>%
  select(Fire, Sdlg, VertGrowth_Rel, Years, Ht_cm1, shrubarea2, shrubarea1, sqrt_shrubarea2, log_shrubarea2, BasDia2016.cm, incidrad, ShrubSpp01, Year, Elevation) %>% 
 mutate_if(is.numeric, normalize) %>% 
  mutate(VertGrowth_Rel = df$VertGrowth_Rel)
LMdf <- droplevels(LMdf)
```

```{r}
both <- lme(VertGrowth_Rel ~ 
          Years + Ht_cm1 + shrubarea2 + shrubarea1 + Year + ShrubSpp01 + BasDia2016.cm + incidrad, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
```


## See whether model with shrubarea2 or sqrt_shrubarea2 is better
```{r}
AIC(lme(VertGrowth_Rel ~ 
          Years + Ht_cm1 + shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML"))

AIC(lme(VertGrowth_Rel ~  
          Years + Ht_cm1 + sqrt_shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML"))

AIC(lme(VertGrowth_Rel ~  
           Years + Ht_cm1 + log_shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation, 
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML"))

```

Untransformed wins

## See whether model with or without interaction is better
```{r}
without <- lme(VertGrowth_Rel ~ 
           Years + Ht_cm1 + shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")

with <- lme(VertGrowth_Rel ~  
           Years + Ht_cm1*shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
anova(with, without)
```

No difference, so I should not include an interaction.

## Look at drop1 results
```{r}
LM <-  lme(VertGrowth_Rel ~ 
            Years + Ht_cm1 + shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

No need to include interaction after all

# See whether residuals are better for log transformed or not
```{r}
LM <-  lme(VertGrowth_Rel ~ 
            Years + Ht_cm1 + shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
plot(LM)
```

```{r}
LM <-  lme(exp(VertGrowth_Rel) ~ 
            Years + Ht_cm1 + shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
plot(LM)
```

Log transformed looks better to me. 

# Re-establish the best LM so far:
```{r}
LM <-  lme(VertGrowth_Rel ~ 
            Years + Ht_cm1 + shrubarea2 + BasDia2016.cm + ShrubSpp01 + Year + Elevation,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

Note: Chisq here is performing likelihood ratio tests

# Look at residuals

### Residuals
```{r}
E <- resid(LM, type = "normalized")
df$E <- E
pred <- predict(LM)
plot(LM)
plot(df$shrubarea3, E)
plot(df$Ht_cm1, E)
plot(df$Years, E)
plot(df$Ht1.3, E)
plot(df$BasDia2016.cm, E)
plot(df$incidrad, E)
plot(df$Year, E)
ggplot(df, aes(x = log(df$shrubarea3), y = E))+
  geom_point()+
  geom_smooth()
```

# Look at individual effects

Note: the plots look exactly the same but with different axes if you don't normalize the numeric predictors. So for including plots to visualize in the paper, I just use non-normalized data

```{r}
eff_years <- predictorEffect("Years", LM)
plot(eff_years)

eff_shrubarea <- predictorEffect("shrubarea2", both)
plot(eff_shrubarea)

eff_ht <- predictorEffect("Ht_cm1", LM)
plot(eff_ht)

eff_shrspp <- predictorEffect("ShrubSpp01", LM)
plot(eff_shrspp)

plot(predictorEffect("BasDia2016.cm", LM))

plot(predictorEffect("Year", LM))

plot(predictorEffect("Elevation", LM))
```

# Re-create effects plots using predictorEffects() and ggplot

```{r}
eff_shrubarea <- predictorEffect("shrubarea2", both)
effects_df <- as.data.frame(eff_shrubarea)
head(effects_df)
```

## Transform variables back to original units
```{r}
effects_df <- effects_df %>% 
  mutate(shrubarea2 = shrubarea2*sd(df$shrubarea2)+mean(df$shrubarea2)) 
```

### test
```{r}
hist(effects_df$shrubarea2)
hist(df$shrubarea2)
```

## Make shrubarea in m instead of cm
```{r}
effects_df <- effects_df %>% 
  mutate(shrubarea2 = shrubarea2/10000)
```

## Plot effects of shrubarea
```{r}
ggplot(effects_df)+
  geom_line(aes(x = shrubarea2, y = exp(fit)))+
  geom_ribbon(aes(x = shrubarea2, ymin = exp(lower), ymax = exp(upper)), alpha = .5, fill = "#fdbb84")+
  theme_bw()+
  xlab(bquote('Shrub competition ' (m^2)))+
  ylab("Relative growth rate")+
  ggtitle("Pine growth in relation to shrub environment within 2 m")+
  geom_rug(data = df, aes(x = shrubarea2/10000, y = exp(VertGrowth_Rel)), alpha = .5, position = "jitter", sides = "b")+
  ylim(c(0.04,0.215))+
  labs(fill = "Juvenile tree height (cm)")+
  theme(legend.position = c(0.8, 0.8))
ggsave(file = "../../results/figures/FireFootprints/PineVertRel.png", width = 6, height = 6, dpi = 400)
```

# Look at relationship between years and shrubarea
```{r}
ggplot(df)+
  geom_boxplot(aes(x = as.factor(Years), y = shrubarea2))
ggplot(df)+
  geom_boxplot(aes(x = Fire, y = shrubarea2))
```

## Save final data
```{r}
save(df, file ="~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/pine_vert.Rdata")
```
