---
title: "Clean and Compile 2016 Fire Footprint data"
author: "Carmen"
date: "September 20, 2017"
output: 
    html_document:
        toc: TRUE
        toc_depth: 1
---

```{r, include = F}
require(readxl)
require(dplyr)
require(tidyr)
```


Adapted from the .R file clean_combine

# Basic cleaning

## Open data
```{r}
DATAWD <- "C:/Users/Carmen/Dropbox (Stephens Lab)/SORTIE/Shrubs_Summer16/Completed_Data_and_Photos/" # PC
setwd(DATAWD) 
sdlt <- read.csv("Master_Compiled_seedlings.csv")
```

## Correct typos and create variable for fire x patch
```{r}
sdlt$Fire[sdlt$Fire=="FRED"]<- "FRDS"
sdlt$Fire[sdlt$Fire=="AMRC"]<- "AMCR"
sdlt$Species[sdlt$Species=="pipo"]<- "PIPO"
sdlt$Species[sdlt$Species=="PILA "]<- "PILA"
sdlt$Patch[sdlt$Patch=="s"]<- "S"
sdlt$FirePatch <- paste(sdlt$Fire, sdlt$Patch, sep = "-")
sdlt$FirePatch <- as.factor(sdlt$FirePatch)
```

## Subset to only non-CADE species 
```{r}
#sdlt <- sdlt[sdlt$Species!="CADE",]
```

## Take out repeat rows
```{r}
sdlt <- sdlt[sdlt$Return==0,]
```

## Reduce to variables of interest
```{r}
df <- sdlt[,c("Seedling.","Fire","FirePatch", "Elevation", "Species", "Slope.Deg","Aspect.deg","Ht.cm","BasDia.cm","LastYearGrth.cm","Light_File","DIFN", "ImmedAboveSpp", "ImmedAboveHt.cm")]
df <- tbl_df(df)
df <- rename(df,Sdlg = Seedling.)
```

# Aggregate shrub data by seedling
```{r}
setwd(DATAWD) 
shr <- read.csv("Master_Compiled_shrubs.csv")
shr <- tbl_df(shr)
shr$Dead.[is.na(shr$Dead.)] <- 0
shr$Cover.cm[is.na(shr$Cover.cm)] <- 0
shr$Ht.cm[is.na(shr$Ht.cm)] <- 0
shr <- subset(shr, shr$Dead.!= 1)
shr <- subset(shr, !shr$Seedling. %in% c("ARPA-1",  "ceco-1",  "CEIN-1", "CEIN-2","chfo-1", "DCECO-1", "DCECO-2", "DCECO-3", "LIDE-1",  "LIDE-2", "LIDE-3", "LIDE-4"))
shr$Seg <- 0
for(i in 1:nrow(shr)){
if(shr$Segment[i] %in% c("0-1 m ","0 -1 m","0-1 m")){
  shr$Seg[i] <- 1
} else if (shr$Segment[i]=="1-2 m "){
  shr$Seg[i] <- 2
} else if (shr$Segment[i] %in% c("2-3 m","2-3m")){
  shr$Seg[i] <- 3
}  else
    shr$Seg[i] <- 999
}
```

## Summarize by segment and total cover
```{r}
cov <- shr %>%
  group_by(Seedling., Seg) %>%
  summarise(cov =sum(Cover.cm)) %>%
  spread(Seg, cov) %>% 
  rename(Sdlg = Seedling.) %>%
  rename(Cov1=`1`) %>%
  rename(Cov2=`2`) %>%
  rename(Cov3=`3`)
```


## Summarize by segment and average height
```{r}
ht <- shr %>%
  group_by(Seedling., Seg) %>%
  summarise(ht =mean(Ht.cm)) %>%
  spread(Seg, ht) %>% 
  rename(Sdlg = Seedling.) %>%
  rename(Ht1=`1`) %>%
  rename(Ht2=`2`) %>%
  rename(Ht3=`3`)  
```

## Test - all should be TRUE
```{r}
sum(shr[shr$Seedling.==10 & shr$Seg==1,]$Cover.cm) == cov[cov$Sdlg==10,2]
sum(shr[shr$Seedling.==1 & shr$Seg==3,]$Cover.cm) == cov[cov$Sdlg==1,4]
mean(shr[shr$Seedling.==10 & shr$Seg==1,]$Ht.cm) == ht[ht$Sdlg==10,2]
mean(shr[shr$Seedling.==1 & shr$Seg==3,]$Ht.cm) == ht[ht$Sdlg==1,4]
```

## Combine cover and ht values
```{r}
shr_by_sdlg <- full_join(cov,ht,by="Sdlg")
```

## Find most common shrub species in 0-1, 1-2, and 2-3
```{r}
spp <- shr %>%
  group_by(Seedling.,Seg, ShrubSpp) %>%
  mutate(cov=sum(Cover.cm)) %>%
  ungroup %>%
  group_by(Seedling.,Seg)%>%
  filter(cov == max(cov)) %>%
  select(Seedling.,Seg,ShrubSpp,cov) %>%
  distinct(.keep_all=TRUE)
```

## Restructure spp so it can be binded to df
```{r}
spp2 <- spp %>%
  select(Seedling.,Seg, ShrubSpp) %>%
  group_by(Seedling.) %>%
  spread(Seg, ShrubSpp) %>%
  rename(Sdlg=Seedling.) %>%
  rename(Spp1=`1`) %>%
  rename(Spp2=`2`) %>%
  rename(Spp3=`3`)  # Check for lost seedlings
shr_by_sdlg <- full_join(shr_by_sdlg,spp2,by="Sdlg")
```

## Check the calculations - should be TRUE
```{r}
sum(shr[shr$Seedling.==1 &shr$Seg==1 & shr$ShrubSpp=="ARPA",]$Cover.cm)== 
  spp[spp$ShrubSpp=="ARPA" & spp$Seedling.==1 & spp$Seg==1,]$cov[1]
max(spp[spp$Seedling.==1 &spp$Seg==1,]$cov) == spp[spp$Seedling.==1&spp$Seg==1,]$cov[1]
```

## Check that shrub seedlings match seedlings seedlings
```{r}
nrow(df) - nrow(shr_by_sdlg)
setdiff(df$Sdlg, shr_by_sdlg$Sdlg)
setdiff(shr_by_sdlg$Sdlg, df$Sdlg)
```

# Combine seedling data with shrub data 

```{r}
df <- full_join(df, shr_by_sdlg, by="Sdlg")
```

## Combine segments into 0-1, 0-2, and 0-3 m
```{r}
df <- df %>%
  mutate(Cov1.2 = Cov1+Cov2) %>%
  mutate(Cov1.3 = Cov1.2+Cov3) %>%
  mutate(Ht1.2 = (Ht1+Ht2)/2) %>%
  mutate(Ht1.3 = (Ht1+Ht2+Ht3)/3)
```

## Create column for genus
```{r}
df$Genus <- 0
for (i in 1:nrow(df)){
  if(df$Species[i] %in% c("PILA","PIPO")){
    df$Genus[i] <- "Pinus"    
  } else if(df$Species[i] =="CADE"){
  df$Genus[i] <- "Calocedrus"
  } else if(df$Species[i] =="ABCO"){
    df$Genus[i] <- "Abies"
  } else if(df$Species[i] =="PSME"){
    df$Genus[i] <- "Pseudotsuga"
  } else 
    df$Genus[i] <- "UHOH"
}
df$Genus <- as.factor(df$Genus)

```

## Create Column for Spp1Genus
```{r}
df$ShrG1 <- 0
df$Spp1 <- as.character(df$Spp1)
df[is.na(df$Spp1),"Spp1"] <- "NONE"
for (i in 1:nrow(df)){
  if(df$Spp1[i] %in% c("ARNE","ARPA","ARVI")){
    df$ShrG1[i] <- "Arcto"    
  } else if(df$Spp1[i] %in% c("CECO","CEIN","CEPR")){
    df$ShrG1[i] <- "Ceanothus"    
  } else if(df$Spp1[i] %in% c("QUVA","QUKE")){
    df$ShrG1[i] <- "Quercus"
  } else if(df$Spp1[i] == "LIDE"){
    df$ShrG1[i] <- "LIDE"
  } else if(df$Spp1[i] == "CHFO"){
    df$ShrG1[i] <- "CHFO"
  } else if(df$Spp1[i] == "CHSE"){
    df$ShrG1[i] <- "CHSE"
      } else 
    df$ShrG1[i] <- "Other"
}
df$ShrG1 <- as.factor(df$ShrG1)
```

## Create column for shrub species immediately above seedling
```{r}
df$IAG <- 0
for (i in 1:nrow(df)){
  if(df$ImmedAboveSpp[i] %in% c("ARNE","ARPA","ARVI")){
    df$IAG[i] <- "Arcto"    
  } else if(df$ImmedAboveSpp[i] %in% c("CECO","CEIN","CEPR")){
    df$IAG[i] <- "Ceanothus"    
  } else if(df$ImmedAboveSpp[i] %in% c("QUVA","QUKE")){
    df$IAG[i] <- "Quercus"
  } else if(df$ImmedAboveSpp[i] == "LIDE"){
    df$IAG[i] <- "LIDE"
  } else if(df$ImmedAboveSpp[i] == "CHFO"){
    df$IAG[i] <- "CHFO"
  } else if(df$ImmedAboveSpp[i] == "CHSE"){
    df$IAG[i] <- "CHSE"
  } else 
    df$IAG[i] <- "Other"
}
df$IAG <- as.factor(df$IAG)
```

## Add years since fire
```{r}
df$Years <- 0
for(i in 1:nrow(df)){
  if (df$Fire[i] == "AMCR"){
    df$Years[i] <- 8
  } else if (df$Fire[i] == "CLVD"){
    df$Years[i] <- 24
  } else if (df$Fire[i] == "FRDS"){
    df$Years[i] <- 35
  } else if (df$Fire[i] == "PLKN"){
    df$Years[i] <- 43
  } else if (df$Fire[i] == "STAR"){
    df$Years[i] <- 38
  } else if (df$Fire[i] =="WRTS") {
    df$Years[i] <- 14
  } else 
    df$Years[i] <- 9999
}
summary(df$Years)
```

# Add DIFN degrees from FV2200 output file
```{r}
setwd("~/../Dropbox (Stephens Lab)/SORTIE/Shrubs_Summer16/Completed_Data_and_Photos/LAI-2000_data/")
DIFNl53 <- read.table(file="AllDIFNGaps1-4",header=T,sep="\t")
names(df)
DIFNl53 <- distinct(DIFNl53)

DIFNl53$LAI_File <- as.factor(DIFNl53$LAI_File)
df <- left_join(df, DIFNl53, by=c("Light_File"="LAI_File")) %>%
  rename(DIFN.all = DIFN.x) %>%
  rename(DIFN.53 =DIFN.y) %>%
  select(-SMP, -TransComp, -Model, -Records, -ScattCorr)
```

## Find which seedlings have DIFN.all but lack DIFN.53
```{r}
fix <- subset(df, !is.na(df$DIFN.all) & is.na(df$DIFN.53))
fix
```

## Fill in a couple seedlings with funky DIFN situations

Seedlings 3 and 9 have two light files. I average them for 3 and use one for 9 because the other one is funky

```{r}
df[df$Sdlg==9,"DIFN.53"] <- DIFNl53[DIFNl53$LAI_File==15,"DIFN"]
df[df$Sdlg==3,"DIFN.53"] <- mean(DIFNl53[DIFNl53$LAI_File%in%c(17,19),"DIFN"])

fix <- subset(df, !is.na(df$DIFN.all) & is.na(df$DIFN.53))
```

## Save
```{r}
setwd("~/Shrubs-Seedlings/compiled_data/")
save(df, file="master_data_2016.Rdata")
write.csv(df, file = "master_data_2016.csv", row.names = F)
```


### NEXT STEPS: ADD SLOPE VALUES AND ELEVATION VALUES WHERE THEY'RE MISSING, LOOK FOR MORE DIFN VALUES, BUILD
### A REGRESSION MODEL, AND ADD LAT AND LONG TABLE FOR EACH SEEDLING FROM PINS ON AVENZA

