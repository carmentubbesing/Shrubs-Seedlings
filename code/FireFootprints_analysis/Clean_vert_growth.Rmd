---
title: "Clean_vert_growth"
author: "Carmen"
date: "April 16, 2019"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r, include = F}
require(tidyverse)
require(ggplot2)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/code/FireFootprints_analysis/")
load(file="../../compiled_data/fire_footprints/master_seedlings2.Rdata")
```

# Throw out the PSME
```{r}
df <- df %>% 
  filter(Species != "PSME")
```


# Add 2015 height values

## Calculate 2015 height by subtracting growth from 2017 height, unless there's no 2017 height value

Calculate 2015 height as the height BEFORE 2015 growth
```{r}
df <- df %>% 
  mutate_at(c("Growth_15", "Growth_16","Growth_17"), as.numeric) %>%
  rename(Ht2017.cm.fall = Ht2017.cm) %>% 
  mutate(Ht2015.cm_spring_from2017 = Ht2017.cm.fall-Growth_16-Growth_17-Growth_15)
```

### Check: the following should be TRUE
```{r}
df %>% 
  dplyr::select(Ht2017.cm.fall, Growth_17, Growth_16, Growth_15, Ht2015.cm_spring_from2017) %>% 
  ungroup() %>% 
  mutate(check = Ht2015.cm_spring_from2017 + Growth_15 + Growth_16 + Growth_17 - Ht2017.cm.fall) %>% 
  filter(check > 0.0000001 | check < -0.0000001) %>% 
  nrow() ==0
```

## Fill in 2015 height for seedling 6, which for some reason lost that value somewhere along the way
```{r}
df <- df %>% 
  mutate(Ht2015.meas2016 = ifelse(Sdlg ==6, 9, Ht2015.meas2016))
```

## Add 2015 heights measured in 2016 for trees still missing 2015 height

```{r}
df <- df %>% 
  mutate(Ht2015.cm_spring = ifelse(is.na(Ht2015.cm_spring_from2017), Ht2015.meas2016, Ht2015.cm_spring_from2017))
```

### Check
```{r}
df %>% 
  dplyr::select(Ht2017.cm.fall, Growth_17, Growth_16, Growth_15, Ht2015.cm_spring_from2017, Ht2015.meas2016, Ht2015.cm_spring) %>% 
  arrange(desc(Ht2015.meas2016))
```

### Count how many seedlings this applies to
```{r}
df %>% 
  filter(is.na(Ht2015.cm_spring_from2017) & !is.na(Ht2015.meas2016)) %>% 
  group_by(Species) %>% 
  summarize(n())
```

### Find seedlings this didn't work for
```{r}
df %>% 
  filter(is.na(Ht2015.cm_spring)) %>% 
  dplyr::select(Sdlg, FirePatch, LastYearGrth.cm, Ht16_meas2016.cm, Ht2017.cm.fall, Ht2015.meas2016, Growth_17, Growth_16, Growth_15, Ht2015.cm_spring)
```

### Count seedlings without 2017 height or 2015 height measured in 2016
```{r}
df %>% 
  filter(is.na(Ht2015.cm_spring_from2017) & is.na(Ht2015.meas2016)) %>% 
  group_by(Species) %>% 
  summarize(n())
```

### Count the seedlings still missing Ht2015.cm_spring values
```{r}
df %>% 
  filter(is.na(Ht2017.cm)) %>% 
  mutate(has2015in2016 = ifelse(is.na(Ht2015.meas2016), 0, 1)) %>% 
  group_by(has2015in2016, Species) %>% 
  summarize(n())
length(unique(df$Sdlg))
```

Of the seedlings that didn't get revisited in 2017, about half (20 trees) are missing 2015 growth. That's 20 out of 244 trees. 

### For those seedlings, find average 2016 growing season apical growth relative to 2015 growth 
```{r}
find_apical_growth <- df %>% 
  filter(!is.na(Ht2015.meas2016) & is.na(Ht2017.cm)) %>% 
  mutate(apical_growth_2016 = Ht16_meas2016.cm - LastYearGrth.cm - Ht2015.meas2016) %>% 
  dplyr::select(Sdlg, Ht16_meas2016.cm, LastYearGrth.cm, Ht2015.meas2016, apical_growth_2016) %>% 
  distinct()
find_apical_growth

perc_apical_of_growth <- find_apical_growth %>% 
  mutate(apical_perc_growth = apical_growth_2016/LastYearGrth.cm) %>% 
  summarize(ave_apical_perc_growth = mean(apical_perc_growth))
perc_apical_of_growth <- unlist(perc_apical_of_growth)
perc_apical_of_growth
```


### Then multiply that by 2015 growth for seedlings lacking 2015 measurements and add the values up to calculate 2015 height
```{r}
df <- df %>%
  mutate(Ht2015.calc2016 = ifelse(is.na(Ht2017.cm) & is.na(Ht2015.meas2016), Ht16_meas2016.cm - LastYearGrth.cm - perc_apical_of_growth*LastYearGrth.cm, Ht2015.meas2016))

df %>% 
  filter(is.na(Ht2017.cm)) %>% 
  dplyr::select(Sdlg, Ht16_meas2016.cm, LastYearGrth.cm, Ht2015.meas2016, Ht2015.calc2016) 
```


## Assign 2015 spring height as Ht2015 calculated in 2016 if there's no 2017 value
```{r}
df <- df %>% 
  mutate(Ht2015.cm_spring = ifelse(is.na(Ht2015.cm_spring), Ht2015.calc2016, Ht2015.cm_spring))
```

## Find seedlings STILL missing 2015 height
```{r}
df %>% 
  filter(is.na(Ht2015.cm_spring)) %>% 
  dplyr::select(Sdlg, LastYearGrth.cm, Ht16_meas2016.cm, Ht2017.cm, Ht2015.meas2016, Growth_17, Growth_16, Growth_15, notes)
```

## Add height for those special cases
```{r}
df <- df %>% 
  mutate(Ht2015.cm_spring = ifelse(Sdlg == 6, Ht2017.cm-Growth_15, Ht2015.cm_spring)) %>% 
  mutate(Ht2015.cm_spring = ifelse(Sdlg == 72, Ht2017.cm-Growth_17 - Growth_16, Ht2015.cm_spring)) %>% 
  mutate(Ht2015.cm_spring = ifelse(Sdlg == 131, Ht2017.cm-Growth_15, Ht2015.cm_spring)) %>% 
  mutate(Ht2015.cm_spring = ifelse(Sdlg == 161, Ht2017.cm-Growth_15 - Growth_16, Ht2015.cm_spring))
```

# Add columns for 2016 and 2017 spring heights
```{r}
df <- df %>% 
  mutate(Ht2017.cm_spring = Ht2017.cm - Growth_17) %>% 
  mutate(Ht2016.cm_spring = Ht2017.cm - Growth_17 - Growth_16)
```

# Look at odd seedlings
```{r}
df %>% 
  filter(Sdlg %in% c(75, 161)) %>% 
  dplyr::select(Sdlg, LastYearGrth.cm, Ht16_meas2016.cm, Ht2017.cm, Ht2015.meas2016, Growth_17, Growth_16, Growth_15, notes, Ht2016.cm_spring, Ht2017.cm_spring, Ht2015.cm_spring)
```

## Fix them
```{r}
df <- df %>% 
  mutate(Ht2016.cm_spring = ifelse(Sdlg == 75, Ht2017.cm - Growth_16, Ht2016.cm_spring)) %>% 
  mutate(Ht2015.cm_spring = ifelse(Sdlg == 75, Ht2017.cm - Growth_16 - Growth_15, Ht2015.cm_spring)) %>% 
  mutate(Ht2016.cm_spring = ifelse(Sdlg == 161, Ht2017.cm - Growth_16, Ht2016.cm_spring))
```


# Create data frame with one row per growth measurement
```{r}
df <- tbl_df(df)
df <- df %>% 
  rename(`2017` = Growth_17, `2016` = Growth_16, `2015` = Growth_15)
df <- gather(df, "Year", "VertGrowth_cm",42:44)
df$Year <- as.factor(df$Year)
```

```{r}
head(df)
summary(df$Year)
```

# Take out species besides ABCO and PIPO
```{r}
df <- df %>% 
  filter(Species %in% c("ABCO", "PIPO"))
```

# Take out ABCO in Pillikan and Freds fires
```{r}
df <- df %>% 
  filter(!(Species == "ABCO" & df$Fire %in% c("PLKN","FRDS")))
```


# Remove bad rows

## Take out 2017 vertical growth measurements for trees that died since last measure
```{r}
summary(as.factor(df$Status))
df <- df %>% 
  filter(!(Status %in% c("DEAD", "dead") & Year == "2017"))
```

## Take out 2016 and 2017 vertical growth measurements for trees that were not found
```{r}
df <- df %>% 
  filter(!(Status %in% c("could not find","not found", "eaten", "herbicide","herbicided") & Year %in% c("2016", "2017")))
```

## Check out NA values and delete years that broke off
```{r}
df %>% 
  filter(is.na(VertGrowth_cm)) %>% 
  dplyr::select(Sdlg, Year, VertGrowth_cm, Status, notes) %>% 
  arrange(Sdlg)
df <- df %>% 
  filter(!(Sdlg %in% c("6","185","131","226","6","74","98") & Year %in% c("2017","2016"))) %>% 
  filter(!(Sdlg %in% c(145, 195,78) & Year == "2016")) %>% 
  filter(!(Sdlg == 75 & Year == 2017))  
```

# Take out unnecessary variables
```{r}
names(df)
df <- df %>% 
  dplyr::select(-ImmedAboveSpp, -ImmedAboveHt.cm, -IAG)
```

## Use growth measured in 2016 (which was 2015 growth) if 2015 growth couldn't be measured in 2017
```{r}
df %>% 
  filter(is.na(VertGrowth_cm)) %>% 
  dplyr::select(Sdlg, VertGrowth_cm, LastYearGrth.cm, Ht16_meas2016.cm, Ht2017.cm, notes)
df <- df %>% 
  mutate(VertGrowth_cm = ifelse(is.na(VertGrowth_cm) & Year == "2015", LastYearGrth.cm, VertGrowth_cm))
``` 

## Look at odd vertical growth value
```{r}
df %>% 
  filter(Sdlg == "195") %>% 
  dplyr::select(Sdlg, Year, LastYearGrth.cm, VertGrowth_cm, Ht16_meas2016.cm, Ht2017.cm, Ht2015.meas2016)
```

### Replace its 2015 growth with LastYearGrowth measured in 2016
```{r}
df <- df %>% 
  mutate(VertGrowth_cm = ifelse(Sdlg == "195" & Year == "2015", LastYearGrth.cm, VertGrowth_cm))
```

# Make VertGrowth numeric
```{r}
df$VertGrowth_cm <- as.numeric(df$VertGrowth_cm)
```

# Add height column that changes depending on year that represents height BEFORE that year's growth

```{r}
df <- df %>% 
  mutate(Ht_cm = ifelse(Year == "2017", Ht2017.cm_spring, 
                        ifelse(Year == "2016", Ht2016.cm_spring, 
                               ifelse(Year == "2015", Ht2015.cm_spring, 0))))
```


## Find missing heights
```{r}
df %>% 
  filter(is.na(Ht_cm)) %>% 
  dplyr::select(Sdlg, LastYearGrth.cm, Ht2016.cm_spring, Ht2017.cm, Ht2015.meas2016, Year, VertGrowth_cm, notes)
```

# Change years since fire depending on year of growth
```{r}
df %>% 
  group_by(Fire, Year, Years) %>% 
  summarize(n())
```

```{r}
df <- df %>% 
  mutate(FireYear = ifelse(Fire == "AMCR", 2008, ifelse(Fire == "CLVD", 1992, ifelse(Fire == "FRDS", 2004, ifelse(Fire == "STAR", 2001, 1981))))) %>% 
  mutate(Years = as.numeric(paste(Year))-FireYear)
```

## Check
```{r}
df %>% 
  group_by(Fire, FireYear, Year, Years) %>% 
  summarize(n())
```

# Calculate relative vertical growth 
```{r}
df %>% dplyr::select(Sdlg, Year, Ht_cm, VertGrowth_cm) %>% arrange(Sdlg)
df <- df %>% 
  rename(Ht_cm1 = Ht_cm) %>% 
  mutate(Ht_cm2 = Ht_cm1+VertGrowth_cm) %>% 
  #mutate(VertGrowth_Rel = log(Ht_cm2) - log(Ht_cm1))
  mutate(VertGrowth_Rel = (Ht_cm2 - Ht_cm1)/Ht_cm1) %>% 
  mutate(VertGrowth_Rel = log(VertGrowth_Rel))
df %>% dplyr::select(Sdlg, Year, Ht_cm1, Ht_cm2, VertGrowth_cm, VertGrowth_Rel) %>% arrange(Sdlg)
```

## Find NAs
```{r}
df %>% 
  filter(is.na(VertGrowth_cm) | is.na(VertGrowth_Rel))
```


# Consolidate shrub species into fewer categories 
```{r}
df %>% 
  group_by(Species, ShrubSpp01) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  filter(Species == "ABCO")
df %>% 
  group_by(Species, ShrubSpp02) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  filter(Species == "ABCO")
df %>% 
  group_by(Species, ShrubSpp03) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  filter(Species == "ABCO")
```

For ABCO, the winning set is CECO, ARPA, CHSE, CEPR, PREM, and CEIN.

```{r}
df %>% 
  group_by(Species, ShrubSpp01) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  filter(Species == "PIPO")
df %>% 
  group_by(Species, ShrubSpp02) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  filter(Species == "PIPO")
df %>% 
  group_by(Species, ShrubSpp03) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  filter(Species == "PIPO")
```

For PIPO, the winning set is CECO, ARPA, CHFO, CEIN, LIDE.

```{r}
df <- df %>% 
  mutate(ShrubSpp01 = ifelse(Species == "ABCO" & !ShrubSpp01 %in% c("CECO", "ARPA", "CHSE", "CEPR", "PREM", "CEIN"), "Other", as.character(ShrubSpp01)))
df <- df %>% 
  mutate(ShrubSpp02 = ifelse(Species == "ABCO" & !ShrubSpp02 %in% c("CECO", "ARPA", "CHSE", "CEPR", "PREM", "CEIN"), "Other", as.character(ShrubSpp02)))
df <- df %>% 
  mutate(ShrubSpp03 = ifelse(Species == "ABCO" & !ShrubSpp03 %in% c("CECO", "ARPA", "CHSE", "CEPR", "PREM", "CEIN"), "Other", as.character(ShrubSpp03)))
```

```{r}
df <- df %>% 
  mutate(ShrubSpp01 = ifelse(Species == "PIPO" & !ShrubSpp01 %in% c("CECO", "ARPA", "CHFO", "LIDE", "CEIN"), "Other", as.character(ShrubSpp01)))
df <- df %>% 
  mutate(ShrubSpp02 = ifelse(Species == "PIPO" & !ShrubSpp02 %in% c("CECO", "ARPA", "CHFO", "LIDE", "CEIN"), "Other", as.character(ShrubSpp02)))
df <- df %>% 
  mutate(ShrubSpp03 = ifelse(Species == "PIPO" & !ShrubSpp03 %in% c("CECO", "ARPA", "CHFO", "LIDE", "CEIN"), "Other", as.character(ShrubSpp03)))
```

## Make them factors
```{r}
df <- df %>% 
  mutate(ShrubSpp01 = as.factor(ShrubSpp01), ShrubSpp02 = as.factor(ShrubSpp02), ShrubSpp03 = as.factor(ShrubSpp03))
```

## plot shrub cover growth by shrub species
```{r}
df_shrubs <- df %>% 
  mutate(Years = as.factor(Years)) %>% 
  group_by(ShrubSpp03, Years) %>% 
  summarize(shrub_cover = mean(Cov1.3))
ggplot(df_shrubs)+
  geom_line(aes(x = Years, y = shrub_cover, group=ShrubSpp03, col = ShrubSpp03))
```

## plot shrub cover growth overall
```{r}
df_shrubs <- df %>% 
  group_by(Fire, Cov1.3, Ht1.3) %>% 
  summarise(Years = mean(Years))
ggplot(df_shrubs, aes(x = Years, y = Cov1.3))+
  geom_point()+
  stat_smooth(method = "loess", span = 1)
```

## plot shrub HEIGHT growth overall
```{r}
ggplot(df_shrubs, aes(x = Years, y = Ht1.3))+
  geom_point()+
  stat_smooth(method = "loess", span = 1)
```

# Summarize shrub cover and height
```{r}
perc <- function(x){x/1200}
df %>% 
  summarize(mincov = min(Cov1.3), medcov = median(Cov1.3), meancov = mean(Cov1.3),maxcov = max(Cov1.3)) %>% 
  mutate_all(perc)

df %>% 
  summarize(min(Ht1.3), median(Ht1.3), mean(Ht1.3), max(Ht1.3))
```


# Drop extra levels
```{r}
df <- droplevels(df)
```

# Count by species
```{r}
df %>% 
  dplyr::select(Species, Sdlg) %>% 
  distinct() %>% 
  group_by(Species) %>% 
  summarize(n())
```


# Save
```{r}
save(df, file = "../../compiled_data/fire_footprints/master_seedlings_vert.Rdata")
```

# Print all shrub patches
```{r}
sort(unique(as.factor(df$FirePatch)))
```

