---
title: "Fire Footprints Data Compile - 2016 and 2017"
author: "Carmen"
date: "September 20, 2017"
output: 
    html_document:
        toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
require(readxl)
require(dplyr)
require(tidyr)
require(ggplot2)
```

# Read in 2017 data
```{r}
setwd("~/../Dropbox (Stephens Lab)/SORTIE/FireFootprints_2017/data/compiled/")
df17 <- read_excel("Shrubs_Summer17_Compiled_Sep14.xlsx")
```

# Read in 2016 data
```{r}
setwd("~/Shrubs-Seedlings/compiled_data/")
df16 <- read.csv("master_data_2016.csv")
```

# Combine
```{r}
df <- full_join(df16, df17, by = "Sdlg")
```

# Take out the incense cedar
```{r}
df <- df %>% 
  filter(Species.x != "CADE")
```

# Sync up repeat column names

## Check for different species
```{r}
df %>% 
  filter(Species.x != Species.y)
```

## Go with 2017 species when it's listed since one tree's species was corrected
```{r}
df <- df %>% 
  mutate(Species = ifelse(!is.na(Species.y), Species.y, Species.x)) %>% 
  select(-Species.x, -Species.y)
```

## Sync fire and fire patch
```{r}
df %>% 
  filter(FirePatch.x != FirePatch.y)
df <- df %>% 
  rename(FirePatch = FirePatch.x) %>% 
  select(-FirePatch.y)
df <- df %>% 
  rename(Fire = Fire.x) %>% 
  select(-Fire.y)
```

## Rename date and datasheet columns
```{r}
df <- df %>% 
  rename(Date = Date.x) %>% 
  select(-Date.y) %>% 
  rename(DataSheet2017 = DataSheet)
```

## Rename basal diameter and height columns
```{r}
df <- df %>% 
  rename( BasDia2016.cm = BasDia.cm) %>% 
  rename(BasDia2017.mm.1 = Dia_1_mm) %>% 
  rename(BasDia2017.mm.2 = Dia_2_mm ) %>% 
  rename(Ht2016.cm = Ht.cm) %>% 
  rename(Ht2017.cm = Ht_cm)
```

## Reorder columns
```{r}
df <- df %>% 
  select(Sdlg, Species, Fire, FirePatch, Ht2016.cm, Ht2017.cm, everything())
```

# Find missing seedlings from 2017 data
```{r}
df %>% 
  filter(is.na(Ht2017.cm) & is.na(Status)) %>% 
  select(Sdlg, Status, FirePatch, DataSheet2017, notes)
```

## Record why things were left out 
```{r}
df <- df %>% 
  mutate(Status = ifelse(Sdlg %in% c(19,28, 139, 137), "exclude, lone in patch", Status)) %>% 
  mutate(Status = ifelse(FirePatch == "FRDS-JB" | Sdlg %in% c(58,80,91,92,93,100,103,106,107,229,176), "not found",Status)) %>% 
  mutate(Status = ifelse(Sdlg == 7, "exclude, under oak", Status))

```

## Remove seedlings that were excluded for reasons other than dead or couldn't find them
```{r}
df <- df %>% 
  filter(!Status %in% c("exclude, under oak", "exclude, lone in patch"))
summary(as.factor(df$Status))
```


# Calculate diameter growth

## Calculate diameter average in 2017
```{r}
df <- df %>% 
  mutate(BasDia2017.mm.1 = as.numeric(BasDia2017.mm.1)) %>% 
  mutate(BasDia2017.mm.2 = as.numeric(BasDia2017.mm.2)) 
df <- replace_na(df, replace = list(BasDia2017.mm.2 = 0, BasDia2017.mm.1 = 0))
df <- df %>% 
  mutate(BasDia2017.mm.ave = (BasDia2017.mm.1+BasDia2017.mm.2)/2)
```

## Adjust 2016 diameters to mm and correct for calipers error
```{r}
df <- df %>% 
  mutate(BasDia2016.mm = BasDia2016.cm*10-1.1)
```

## Calculate growth
```{r}
df <- df %>% 
  mutate(DiaGrowth = ifelse(BasDia2017.mm.1 >0, BasDia2017.mm.ave - BasDia2016.mm, NA))
df %>% 
  filter(BasDia2017.mm.ave >0 & !is.na(DiaGrowth)) %>% 
  summarise(mean(DiaGrowth))
hist(df$DiaGrowth, breaks = 30)
```

# Get data ready to analyze vertical growth

## Create data frame with one row per growth measurement
```{r}
df <- tbl_df(df)
names(df)
df <- df %>% 
  rename(`2017` = Growth_17, `2016` = Growth_16, `2015` = Growth_15)
df <- gather(df, "Year", "VertGrowth",41:43)
df$Year <- as.factor(df$Year)
```

## Use growth measured in 2016 (which was 2015 growth) if 2015 growth couldn't be measured in 2017
```{r}
df <- df %>% 
  mutate(VertGrowth = ifelse(is.na(VertGrowth) & Year == "2015", LastYearGrth.cm, VertGrowth))
``` 

## Take out 2017 vertical growth measurements for trees that died since last measure
```{r}
summary(as.factor(df$Status))
df <- df %>% 
  filter(!(Status %in% c("DEAD", "dead") & Year == "2017"))
```

## Take out 2016 and 2017 vertical growth measurements for trees that were not found
```{r}
df <- df %>% 
  filter(!(Status %in% c("could not find","not found", "eaten", "herbicide","herbicided") & Year %in% c("2016", "2017")))
```

## Check out NA values and delete years that broke off
```{r}
df %>% 
  filter(is.na(VertGrowth)) %>% 
  select(Sdlg, Year, VertGrowth, Status, notes) %>% 
  arrange(Sdlg)
df <- df %>% 
  filter(!(Sdlg %in% c("6","185","131","226","6","74","98") & Year %in% c("2017","2016"))) %>% 
  filter(!(Sdlg %in% c(145, 195,78) & Year == "2016")) %>% 
  filter(!(Sdlg == 75 & Year == 2017))  
```

## Look at odd vertical growth value
```{r}
df <- df %>% 
  mutate(VertGrowth = ifelse(Sdlg == "195" & Year == "2015", LastYearGrth.cm, VertGrowth))
df$VertGrowth <- as.numeric(df$VertGrowth)
```


## Create shrubarea variables for each distance from the seedling
```{r}
df <- df %>% 
  mutate(shrubarea2 = Ht1.2 * Cov1.2) %>% 
  mutate(shrubarea3 = Ht1.3 * Cov1.3)
```

### Fix NA shrubarea
```{r}
df <- df %>% filter(!(is.na(shrubarea2) & Sdlg == "17"))
```


## Fill in height if it was not taken in 2017
```{r}
df <- df %>% 
  mutate(Ht_cm = ifelse(is.na(Ht2017.cm), Ht2016.cm, Ht2017.cm)) %>% 
  select(-Ht2016.cm, -Ht2017.cm)
```


## Look at distribution of relative growth rate
```{r}
df$VertGrowth_Rel <- df$VertGrowth/df$Ht_cm
hist(df$VertGrowth_Rel, breaks = 30)
```

## Look at relative growth rate in relation to DIFN
```{r}
ggplot(df, aes(x = DIFN.all, y = VertGrowth_Rel))+
  geom_point()+
  geom_smooth(method = "lm")
```

## Standardize continuous variables I plan to use in the model
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
```

```{r}
df <- df %>% 
  mutate(Ht_norm = normalize(Ht_cm)) %>% 
  mutate(shrubarea2_sqrt_norm = normalize(sqrt(shrubarea2)) )
```

# Add elevation and slope where they're missing - look in original data sheets
```{r}
df %>% 
  filter(is.na(Elevation)) %>% 
  arrange(Sdlg)
```

## Create function for adding elevation data to an individual seedling
```{r}
elv <- function(sdlg, elev){
  df <<- df %>% 
    mutate(Elevation = ifelse(Sdlg == sdlg, elev, Elevation))
}
```

## Apply the function using elevation data from the QGIS project file `C:\Users\Carmen\Dropbox (Stephens Lab)\SORTIE\FireFootprints_2017\GIS_maps\Seedling_locations`
```{r}
elv(26, 1642)
elv(27, 1642)
elv(159, 1643)
elv(161, 1676)
elv(162, 1679)
elv(163, 1679)
elv(164, 1679)
elv(165, 1692)
elv(166, 1703)
elv(167, 1703)
elv(168, 1701)
elv(169, 1706)
elv(170, 1644)
elv(171, 1644)
elv(172, 1644)
elv(174, 1645)
elv(176, 1689)
elv(177, 1702)
elv(178, 1697)
elv(179, 1646)
elv(180, 1646)
elv(181, 1642)
elv(220, 1652)
elv(221, 1651)
elv(223, 1663)
elv(224, 1663)
elv(226, 1668)
elv(250, 1685)
elv(251, 1684)
elv(252, 1684)
elv(253, 1681)
elv(254, 1681)
elv(256, 1680)
elv(257, 1680)
elv(258, 1682)
elv(259, 1683)
elv(260, 1683)
elv(262, 1681)
elv(263, 1682)
elv(264, 1684)
elv(265, 1684)
```

## For 222 and 225, and 255, I can't find an avenza point location. So I'll average the elevations of other seedlings with numbers just above and below them

### 222&225 elevation estimation
```{r}
elv_est <- df %>% 
  filter(Sdlg %in% c(220, 221, 223, 224, 226)) %>% 
  select(Sdlg, FirePatch, Elevation) %>% 
  distinct() %>% 
  summarize(mean(Elevation))
elv_est <- unlist(elv_est)
elv_est
elv(222, elv_est)
elv(225, elv_est)
```

### 255 elevation estimate
```{r}
elv_est <- df %>% 
  filter(Sdlg %in% c(254, 256)) %>% 
  select(Sdlg, FirePatch, Elevation) %>% 
  distinct() %>% 
  summarize(mean(Elevation))
elv_est <- unlist(elv_est)
elv_est
elv(255, elv_est)
```

### Test
```{r}
df %>% filter(Sdlg %in% c(222, 225, 255)) %>% select(Sdlg, FirePatch, Elevation) %>% distinct()
```


## Test for completion
```{r}
df %>% 
  filter(is.na(Elevation)) %>% 
  arrange(Sdlg) %>% 
  select(Sdlg, FirePatch, Elevation, Slope.Deg, Aspect.deg) %>% 
  distinct()
```

# Save
```{r}
save(df, file = "~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/master_seedlings.Rdata")
write.csv(df, file = "~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/master_seedlings.csv", row.names = F)
```

