---
title: Fir volume growth analysis exploration - fire footprints
author: Carmen
date: November 19, 2017
output: 
    html_document:
        toc: TRUE
---

```{r, include = F}
library(ggplot2)
library(dplyr)
require(nlme)
library(kableExtra)
library(knitr)
library(lme4)
library(tidyr)
library(randomForest)
library(VSURF)
library(effects)
```

# Load data
```{r}
load(file = "~/Shrubs-Seedlings/compiled_data/fire_footprints/fir_vol.Rdata")
```

# Reduce # of levels in shrub variables
```{r}
df <- droplevels(df)
sort(summary(df$ShrubSpp01))
sort(summary(df$ShrubSpp02))
sort(summary(df$ShrubSpp03))
df <- df %>% 
  mutate(ShrubSpp02 = ifelse(!ShrubSpp02 %in% c("CECO", "ARPA", "CHSE"), "Other", paste(ShrubSpp02)))%>% 
  mutate(ShrubSpp02 = as.factor(ShrubSpp02)) %>% 
    mutate(ShrubSpp01 = ifelse(!ShrubSpp01 %in% c("CECO", "ARPA", "CHSE"), "Other", paste(ShrubSpp01)))%>% 
  mutate(ShrubSpp01 = as.factor(ShrubSpp01)) %>% 
    mutate(ShrubSpp03 = ifelse(!ShrubSpp03 %in% c("CECO", "ARPA", "CHSE"), "Other", paste(ShrubSpp03)))%>% 
  mutate(ShrubSpp03 = as.factor(ShrubSpp03))
```


# Visualize pre and post volumes on a log scale
```{r}
ggplot(df)+
  geom_point(aes(x = log(vol_pre_cm2), y = log(vol_post_cm2)), col = "red")+
  scale_x_continuous(limits = c(-5,7.5))+
  scale_y_continuous(limits = c(-5,7.5))+
  geom_abline(slope = 1,intercept = 0)
```

```{r}
ggplot(df)+
  geom_point(aes(x = log(vol_pre_cm2), y = (log(vol_post_cm2)-log(vol_pre_cm2)) ), col = "green")+
  scale_x_continuous(limits = c(-5,7.5))+
  scale_y_continuous(limits = c(-5,7.5))
```

## Plot relative growth rate vs. volume to check for a possible relationship

### least squares
```{r}
ggplot(df, aes(x = log(vol_pre_cm2), y = RGR))+
  geom_point()+
  geom_smooth(method = 'lm')
```

### loess
```{r}
ggplot(df, aes(x = log(vol_pre_cm2), y = RGR))+
  geom_point()+
  geom_smooth()
```

This looks like I should maybe include volume in the model of growth rate or adjust how I analyze growth rates

## Plot relative growth rate vs. ht to check for a relationship

### least squares
```{r}
ggplot(df, aes(x = tree_Ht_log_norm, y = RGR))+
  geom_point()+
  geom_smooth(method = 'lm')
```

### loess
```{r}
ggplot(df, aes(x = tree_Ht_log_norm, y = RGR))+
  geom_point()+
  geom_smooth()
```

There appears to be less of a relationship between height and growth than between volume and growth

# Mixed effects with random fire effect
```{r}
MM1 <- lme(RGR ~Cov1.2_norm, random =~1|Fire, data = df, method = "ML")

MM1_null <- lme(RGR ~ 1, random =~1|Fire, method = "ML",data = df)
anova(MM1, MM1_null)
summary(MM1)
```

```{r}
decdf <- read.csv("~/Shrubs-Seedlings-master_Dec2018/code/FireFootprints_analysis/df_firvol_Dec2018.csv")
setdiff(as.numeric(df$Sdlg), decdf$Sdlg)
setdiff(decdf$Sdlg, as.numeric(df$Sdlg))
```

# Try using VSURF

## Make df of just the predictor variables I want to include
```{r}
xdf <- df %>% 
  select(Fire, 
         #FirePatch,
         Elevation,
         Slope.Deg,
         Aspect.rad.fold.NESW,
         #DIFN.all,
         ImmedAboveSpp,
         ImmedAboveHt.cm,
         Years,
         #LAI,
         #DIFN.53,
         tree_Ht_cm,
         Lat.rad,
         shrubarea2, 
         shrubarea3,
         Cov1, 
         Cov1.2, 
         Cov1.3, 
         Ht1, 
         Ht1.2, 
         Ht1.3,
         ShrubSpp01, 
         ShrubSpp02, 
         ShrubSpp03, 
         #IAG, 
         #ShrG1, 
         BasDia2016.cm, 
         vol_pre_cm2, 
         heatload,
         incidrad) 
```

## Normalize the numeric ones
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
xdf <- xdf %>% mutate_if(is.numeric, normalize)
```

## Apply VSURF to RGR
```{r}
vsurf <- VSURF(x = xdf, y = df$RGR, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

# See how that compares to a simple random forest using the same variables
```{r}
forest <- randomForest(x = xdf, y = df$RGR, importance = TRUE, scale = TRUE)
varImpPlot(forest)
```

# Look at a linear model using the variables that were identified by VSURF, plus interactions that seem biologically meaningful

## Structure data for LM
```{r}
LMdf <- df %>% 
  select(Fire, RGR, BasDia2016.cm, vol_pre_cm2, Slope.Deg, ShrubSpp02, shrubarea3, Ht1.3) %>% 
  mutate_if(is.numeric, normalize)
LMdf <- droplevels(LMdf)
summary(LMdf$ShrubSpp02)
```

## Linear model
```{r}
LM <-  lme(RGR ~ BasDia2016.cm+  Slope.Deg+ ShrubSpp02 + shrubarea3+ vol_pre_cm2+ Ht1.3 + vol_pre_cm2:Ht1.3,data = LMdf, random = ~ 1| Fire, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

### Look at individual effects
```{r}
eff_shrubarea <- effect("shrubarea3", LM)
plot(eff_shrubarea)

eff_shrubht<- effect("Ht1.3", LM)
plot(eff_shrubht)

eff_shrubspp <- effect("ShrubSpp02", LM)
plot(eff_shrubspp)
```

### Compare to model with no shrub data
```{r}
LMnull <- lme(RGR ~ BasDia2016.cm+  Slope.Deg+ vol_pre_cm2,data = LMdf, random = ~ 1| Fire, method = "ML")
anova(LM, LMnull)
```

### Residuals
```{r}
E <- resid(LM, type = "normalized")
pred <- predict(LM)
plot(LM)
plot(df$shrubarea2_sqrt_norm, E)
plot(df$tree_Ht_log_norm, E)
plot(log(df$vol_pre_cm2), E)
```
