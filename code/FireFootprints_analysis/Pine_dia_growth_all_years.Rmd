---
title: "Pine diameter growth analysis, all years"
author: "Carmen"
date: "November 14, 2017"
output: 
    html_document:
        toc: TRUE
---

```{r, include = F}
library(ggplot2)
library(dplyr)
require(nlme)
```

# Load data
```{r}
load(file = "~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/master_seedlings.Rdata")
```

# Filter out firs and fires with very few pines
```{r}
df <- df %>% 
  filter(Species %in% c("PIPO","PILA")) %>% 
  filter(!(Fire == "WRTS"))
df$Species <- as.factor(df$Species)
df %>% 
  group_by(Fire) %>% 
  summarise(n())
```

# Take a look
```{r}
hist(df$DiaGrowth)
summary(df$DiaGrowth)
df %>% filter(is.na(DiaGrowth))
```

```{r}
df %>% group_by(Species) %>% 
  summarise(n())
```


# Clean

## Take out trees with no second dia measurement
```{r}
df <- df %>% filter(!(BasDia2017.mm.2== 0 & BasDia2017.mm.1 == 0))
```

## Restructure so there's only one row per seedling 
```{r}
df_dia <- df %>% 
  select(-VertGrowth, -VertGrowth_Rel, -Year) %>% 
  distinct()
```


## Take out outliers on both ends, defined as greater than two SD from the mean
```{r}
hist(df_dia$DiaGrowth)
mean(df_dia$DiaGrowth) - 2*sd(df_dia$DiaGrowth)
mean(df_dia$DiaGrowth) + 2*sd(df_dia$DiaGrowth)
df_dia <- df_dia %>% 
  filter(!(DiaGrowth < (mean(df_dia$DiaGrowth) - 2*sd(df_dia$DiaGrowth)) |
             DiaGrowth > mean(df_dia$DiaGrowth) + 2*sd(df_dia$DiaGrowth)))
hist(df_dia$DiaGrowth)
df_dia %>% 
  filter(DiaGrowth < 0) %>% 
  summarise(n())
18/nrow(df_dia)
```

### A seedling was defined as an outlier using analysis of residuals after the fact
It had suspiciously lower basal diameter in 2017 compared to 2016, and I take it out here
```{r}
df_dia <- df_dia %>% filter(!(Fire == "CLVD" & Sdlg == "11"))
```

## Lump quercus with "other" shrub genus since it only has 3 observations
```{r}
df_dia <- df_dia %>% 
  ungroup() %>% 
  mutate(ShrG1 = ifelse(ShrG1 == "Quercus", "Other", as.character(ShrG1)))
df_dia$ShrG1 <- as.factor(df_dia$ShrG1)
```


# Calculate relative diameter growth
```{r}
df_dia <- df_dia %>% 
  mutate(DiaGrowth_rel = DiaGrowth/(BasDia2016.cm*10))
hist(df_dia$DiaGrowth_rel)
```

## Adjust so that no values are below 0 
```{r}
df_dia <- df_dia %>% 
  mutate(DiaGrowth_rel = (DiaGrowth_rel - min(df_dia$DiaGrowth_rel)))
```

# Stats

## Mixed effects model: How does relative diameter growth relate to shrub area?
```{r}
f <- DiaGrowth_rel ~  shrubarea2_sqrt_norm + Ht_norm + ShrG1 + Ht_norm:shrubarea2_sqrt_norm
f_noshrubs <- DiaGrowth_rel ~  Ht_norm  + ShrG1
LM1 <- lme(f,data = df_dia, random = ~ 1| Fire, method = "ML")
LM1_noshrubs <- lme(f_noshrubs,data = df_dia, random = ~ 1| Fire, method = "ML")
anova(LM1, LM1_noshrubs)
```

# Look for patterns in residuals of mixed effects model

## In relation to fitted values
```{r}
E <- resid(LM1, type="normalized")
df_dia$resid <- E
plot(LM1, col = df_dia$Fire)
df_dia[fitted.values(LM1)<0,]$resid
```

## In relation to height
```{r}
plot(E~df_dia$Ht_norm)
coplot(E ~ Ht_norm | Fire, data=df_dia, ylab="Normalized residuals", col=df_dia$Fire)
```

## In relation to shrub area and fire
```{r}
plot(df_dia$shrubarea2_sqrt_norm, E)
plot(df_dia$Fire, E)
```

# Is the variance different between larger and smaller seedlings? 
```{r}
sd(unlist(df_dia[df_dia$Ht_cm < median(df_dia$Ht_cm),"resid"]))
sd(unlist(df_dia[df_dia$Ht_cm >= median(df_dia$Ht_cm),"resid"]))
sd(df_dia$resid)
(sd(unlist(df_dia[df_dia$Ht_cm < median(df_dia$Ht_cm),"resid"])))/(sd(unlist(df_dia[df_dia$Ht_cm >= median(df_dia$Ht_cm),"resid"])))
```

Not bad.

# Plot 

## Make fake data
```{r}
MyData <-  rbind(
  expand.grid( 
    Fire = unique(df_dia$Fire), 
    shrubarea2_sqrt_norm = seq(min(df_dia$shrubarea2_sqrt_norm), max(df_dia$shrubarea2_sqrt_norm), length = 10),
    Ht_norm = seq(min(df_dia$Ht_norm), max(df_dia$Ht_norm), length = 10),
    Species = c("PIPO","PILA"),
    ShrG1 = unique(df_dia$ShrG1)
    ) 
)
```


## Plot
```{r}
MyData$pred_simple <- predict(LM1, newdata = MyData)
```

### Summary plot
```{r}
MyData_summary_simple <- MyData %>% 
  group_by(shrubarea2_sqrt_norm, ShrG1) %>% 
  mutate(pred_simple = mean(pred_simple))
figure_summary <- ggplot(MyData_summary_simple)+
  labs(title = "Predicted pine seedling diameter growth (lines) \nand actual growth (points)")+
  ylab("Predicted relative seedling growth")+
  xlab("shrub cover * shrub height 0-2 m from seedling")+
  geom_line(aes(y = pred_simple, x = shrubarea2_sqrt_norm, group = ShrG1, col = ShrG1))+
  geom_point(data=df_dia, aes(x = shrubarea2_sqrt_norm, y = DiaGrowth_rel))
figure_summary
```

```{r}
df_dia %>% 
  group_by(ShrG1) %>% 
  summarise(n())
```

# Add date measured in 2016??
