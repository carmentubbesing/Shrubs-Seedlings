---
title: "fir functional group vertical growth - fire footprints"
author: "Carmen"
date: "November 13, 2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r, include = F}
require(nlme)
require(randomForest)
require(tree)
require(knitr)
require(tidyverse)
require(ggplot2)
require(VSURF)
require(effects)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/compiled_data/")
load(file="fire_footprints/master_seedlings2.Rdata")
```

# Filter to just white firs
```{r}
df %>% 
  group_by(Fire,Species) %>% 
  summarize(n())
```


```{r}
df <- df %>% 
  filter(Species == "ABCO" & !df$Fire %in% c("PLKN","FRDS"))
```

## Change species and Sdlg to factor
```{r}
df <- df %>% 
  mutate(Species = as.factor(Species)) %>% 
  mutate(Sdlg = as.factor(Sdlg)) 
summary(df$Species)
summary(df$Sdlg)

```

# Count
```{r}
length(unique(df$Sdlg))
nrow(df)
```


# Try using VSURF

## Make df of just the predictor variables I want to include
```{r}
xdf <- df %>% 
  select(Elevation,
         Slope.Deg,
         Aspect.rad.fold.NESW,
         Years,
         Ht_cm,
         shrubarea1,
         shrubarea2, 
         shrubarea3,
         Cov1, 
         Cov1.2, 
         Cov1.3, 
         Ht1, 
         Ht1.2, 
         Ht1.3,
         ShrubSpp01, 
         ShrubSpp02, 
         ShrubSpp03, 
         BasDia2016.cm, 
         heatload,
         incidrad,
         Year,
         Years) 
```

## Normalize the numeric ones
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
xdf <- xdf %>% mutate_if(is.numeric, normalize)
```

# STOP HERE IF YOU DON'T WANT THINGS TO TAKE FOREVER

## Apply VSURF to vertical growth
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Run a random forest on the ones that come up to see whether to delete heatload or incidrad from VSURF
```{r}
forest <- randomForest(x = xdf %>% select(heatload, Years, incidrad, shrubarea2, Elevation, Year), y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
varImpPlot(forest)
```

### Delete incidrad based on the results of the above randomforest
```{r}
xdf <- xdf %>% 
  select(-incidrad)
```

### Then run VSURF again
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Repeat for shrubarea2 and shrubarea3

### Run a random forest
```{r}
forest <- randomForest(x = xdf %>% select(heatload, Years, shrubarea2, Aspect.rad.fold.NESW, shrubarea3, Year), y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
varImpPlot(forest)
```

### Delete SHRUBAREA2 based on the results of the above randomforest
```{r}
xdf <- xdf %>% 
  select(-shrubarea2)
```

### Then run VSURF again
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Repeat for heatload and Aspect

### Run a random forest
```{r}
forest <- randomForest(x = xdf %>% select(heatload, Years, Aspect.rad.fold.NESW, shrubarea3, Elevation, Year), y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
varImpPlot(forest)
```

### See how correlated they are
```{r}
ggplot(df, aes(x = heatload, y = Aspect.rad.fold.NESW))+
  geom_point()+
  geom_smooth(method = "loess")
```

### Delete ASPECT based on the results of the above randomforest
```{r}
xdf <- xdf %>% 
  select(-Aspect.rad.fold.NESW)
```

### Then run VSURF again
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Repeat for shrubarea3 and Ht1.3

### Run a random forest
```{r}
forest <- randomForest(x = xdf %>% select(heatload, Years, shrubarea3, Ht1.3, Elevation, Year), y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
varImpPlot(forest)
```

### See how correlated they are
```{r}
ggplot(df, aes(x = shrubarea3, y = Ht1.3))+
  geom_point()+
  geom_smooth(method = "loess")
```

### Delete HT1.3 based on the results of the above randomforest
```{r}
xdf <- xdf %>% 
  select(-Ht1.3)
```

### Then run VSURF again
```{r}
vsurf <- VSURF(x = xdf, y = df$VertGrowth_Rel, na.action = na.omit)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Run a randomforest using those variables
```{r}
forest <- randomForest(x = xdf %>% select(heatload, Years, shrubarea3, Cov1, Elevation, Year), y = df$VertGrowth_Rel, importance = TRUE, scale = TRUE)
varImpPlot(forest)
```

Check the correlation of Cov1 and shrubarea3 to see if one needs to be deleted

```{r}
ggplot(df, aes(x = shrubarea3, y = Cov1))+
   geom_point()+
   geom_smooth(method = "loess")
```

Looks ok.

# RESUME HERE

# Look at a linear model using the variables that were identified by VSURF, plus interactions that seem biologically meaningful

## Structure data for LM
```{r}
LMdf <- df %>% 
  mutate(sqrt_shrubarea3 = sqrt(shrubarea3)) %>% 
  select(Sdlg, VertGrowth_Rel, Fire, heatload, Years, shrubarea3, sqrt_shrubarea3, Cov1, Elevation, Year) %>% 
  mutate_if(is.numeric, normalize)
LMdf <- droplevels(LMdf)
```

## See whether model with shrubarea3 or sqrt_shrubarea3 is better
```{r}
AIC(lme(VertGrowth_Rel ~ heatload+ Years+ shrubarea3+ sqrt_shrubarea3+ Cov1+ Elevation+ Year,data = LMdf, random = ~ 1| Sdlg, method = "ML"))
AIC(lme(VertGrowth_Rel ~  heatload+ Years+ shrubarea3+ shrubarea3+ Cov1+ Elevation+ Year,data = LMdf, random = ~ 1| Sdlg, method = "ML")
)
```

Untransformed wins.


## Linear model
```{r}
LM <-  lme(VertGrowth_Rel ~ heatload+ Years+ shrubarea3+ Cov1+ Elevation+ Year,data = LMdf, random = ~ 1| Sdlg, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

Note: the plots look exactly the same but with different axes if you don't normalize the numeric predictors. So for including plots to visualize in the paper, I just use non-normalized data

#### Re-run model with non-normalized data
```{r}
LMdf <- df %>% 
  mutate(sqrt_shrubarea3 = sqrt(shrubarea3)) %>% 
  select(Sdlg, VertGrowth_Rel, shrubarea3, heatload, Year, Cov1, Elevation, Years) %>% 
  mutate(shrubarea3_m = shrubarea3/10000)
LMdf <- droplevels(LMdf)
```

```{r}
LM <-  lme(VertGrowth_Rel ~ heatload+ Years+ shrubarea3_m+ Cov1+ Elevation+ Year,data = LMdf, random = ~ 1| Sdlg, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

### Look at individual effects
```{r}
eff_shrubarea <- predictorEffect("shrubarea3_m", LM)
plot(eff_shrubarea)

eff_shrubcov<- predictorEffect("Cov1", LM)
plot(eff_shrubcov)

eff_shrubspp <- predictorEffect("heatload", LM)
plot(eff_shrubspp)

eff_shrubspp <- predictorEffect("Year", LM)
plot(eff_shrubspp)
```


### Re-create effects plot using predictorEffects() and ggplot
```{r}
effects_df <- as.data.frame(eff_shrubcov)
ggplot(effects_df)+
  geom_line(aes(x = 100*Cov1/400, y = fit))+
  geom_ribbon(aes(x = 100*Cov1/400, ymin = lower, ymax = upper), alpha = .5, fill = "#fdbb84")+
  theme_bw()+
  xlab("Shrub cover (%)")+
  ylab("Predicted relative growth (cm/cm)")+
  ggtitle("Fir growth in relation to shrub environment within 1 m")+
  geom_rug(data = df, aes(x = 100*Cov1/400, y = VertGrowth_Rel), alpha = .5, position = "jitter", sides = "b")+
    ylim(c(0.025,0.2))
setwd("../code/FireFootprints_analysis/")
ggsave(file = "../../results/figures/FireFootprints/FirVertRel.png")
```


### Compare to model with no shrub data
```{r}
LMnull <- lme(VertGrowth_Rel ~ heatload+ Years+  Elevation+ Year,data = LMdf, random = ~ 1| Sdlg, method = "ML")
anova(LM, LMnull)
```

### Residuals
```{r}
E <- resid(LM, type = "normalized")
df$E <- E
pred <- predict(LM)
plot(LM)
plot(df$shrubarea3, E)
plot(df$Ht_cm, E)
ggplot(df, aes(x = shrubarea3, y = E))+
  geom_point()+
  geom_smooth()
```



## Save final data
```{r}
save(df, file ="~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/fir_vert.Rdata")
```
