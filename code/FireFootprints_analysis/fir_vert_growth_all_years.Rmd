---
title: "fir vertical growth - fire footprints"
author: "Carmen"
date: "November 13, 2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r, include = F}
require(nlme)
require(randomForest)
require(tree)
require(knitr)
require(tidyverse)
require(ggplot2)
require(VSURF)
require(effects)
```

```{r set.seed(333)}
knitr::opts_chunk$set(cache = T)
set.seed(333)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/code/FireFootprints_analysis/")
load(file="../../compiled_data/fire_footprints/master_seedlings_vert.Rdata")
```

# Filter to just white firs
```{r}
df %>% 
  group_by(Fire,Species) %>% 
  summarize(n())
```

```{r}
df <- df %>% 
  filter(Species == "ABCO" & !df$Fire %in% c("PLKN","FRDS"))
```

## Change species and Sdlg to factor
```{r}
df <- df %>% 
  mutate(Species = as.factor(Species)) %>% 
  mutate(Sdlg = as.factor(Sdlg))
```

# Count
```{r}
length(unique(df$Sdlg))
nrow(df)
```

# Find average growth rate
```{r}
mean(df$VertGrowth_Rel)
sd(df$VertGrowth_Rel)
sd(df$VertGrowth_Rel)/sqrt(nrow(df))
ggplot(df)+
  geom_boxplot(aes(y = VertGrowth_Rel))
```

## Take out rows with Inf log(VertGrowth) because growth = 0 cm
```{r}
df <- df %>% 
  filter(is.finite(df$VertGrowth_Rel))
```

# Apply VSURF
```{r}
summary(df$siteclass)
```


## Make df of just the predictor variables I want to include
```{r}
xdf <- df %>% 
  dplyr::select(Elevation,
         Slope.Deg,
         heatload,
         incidrad,
         Aspect.rad.fold.NESW,
         Year,
         Years,
         BasDia2016.cm, 
         Ht_cm1,
         shrubarea3,
         ShrubSpp03,
         siteclass) 
```

## Normalize the numeric ones
```{r}
normalize <- function(x) {
    return ((x - mean(x)) / sd(x))
  }
xdf <- xdf %>% mutate_if(is.numeric, normalize)
```


## Apply VSURF to vertical growth
```{r}
vsurf <- VSURF(x = xdf, 
               y = df$VertGrowth_Rel, 
               na.action = na.omit,
               parallel = T)
summary(vsurf)
vsurf$varselect.pred
xdf[vsurf$varselect.pred]
```

## Save the results
```{r}
vars <- names(xdf[vsurf$varselect.pred])
vars
```

## Look at final random forest
```{r}
forest <- randomForest(
  x = xdf %>% 
    dplyr::select(vars), 
  y = df$VertGrowth_Rel, 
  importance = TRUE, 
  scale = TRUE)
varImpPlot(forest)
```

# Look at a linear model using the variables that were identified by VSURF, plus interactions that seem biologically meaningful

## Structure data for LM
```{r}
LMdf <- df %>% 
  mutate(sqrt_shrubarea3 = sqrt(shrubarea3)) %>%
  mutate(log_shrubarea3 = log(shrubarea3)) %>% 
  dplyr::select(Fire, Sdlg, heatload, Years, BasDia2016.cm, shrubarea3, sqrt_shrubarea3, log_shrubarea3, Elevation, Ht_cm1, Slope.Deg, Year, Aspect.rad.fold.NESW, incidrad) %>% 
  mutate_if(is.numeric, normalize) %>% 
  mutate(VertGrowth_Rel = df$VertGrowth_Rel)
LMdf <- droplevels(LMdf)
```

## See whether model with shrubarea3 or sqrt_shrubarea3 is better
```{r}
AIC(lme(VertGrowth_Rel ~  heatload +  Years + Aspect.rad.fold.NESW + incidrad + BasDia2016.cm + shrubarea3 + Year,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML"))

AIC(lme(VertGrowth_Rel ~ heatload +  Years + Aspect.rad.fold.NESW + incidrad + BasDia2016.cm + sqrt_shrubarea3 + Year,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML"))

AIC(lme(VertGrowth_Rel ~ heatload +  Years + Aspect.rad.fold.NESW + incidrad + BasDia2016.cm + log_shrubarea3 + Year,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
)
```

Use sqrt since that's what I used with pipo.

## See whether model with or without interaction is better
```{r}
without <- lme(VertGrowth_Rel ~ 
           heatload +  Years + Aspect.rad.fold.NESW + incidrad + BasDia2016.cm + sqrt_shrubarea3 + Year,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")

with <- lme(VertGrowth_Rel ~  
           heatload +  Years + Aspect.rad.fold.NESW + incidrad + BasDia2016.cm * sqrt_shrubarea3 + Year,
        data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
anova(with, without)
```

No difference, so I'll leave out the interaction


## Linear model without ELevation
```{r}
LM <-  lme(VertGrowth_Rel ~ heatload +  Years + Aspect.rad.fold.NESW + incidrad + BasDia2016.cm + sqrt_shrubarea3 + Year,
           data = LMdf, random = ~ 1| Fire/Sdlg, method = "ML")
summary(LM)
drop1(LM, test = "Chisq")
```

### Look at individual effects

Note: the plots look exactly the same but with different axes if you don't normalize the numeric predictors. So for including plots to visualize in the paper, I just use non-normalized data

```{r}
eff_years <- predictorEffect("Years", LM)
plot(eff_years)

eff_shrubarea <- predictorEffect("sqrt_shrubarea3", LM)
plot(eff_shrubarea)

plot(predictorEffect("heatload", LM))
```

# Re-create effects plots using predictorEffects() and ggplot

## Create df for effects 
```{r}
eff_shrubarea <- predictorEffect("sqrt_shrubarea3", LM)
effects_df <- as.data.frame(eff_shrubarea)
head(effects_df)
```

## Transform variables back to original units
```{r}
effects_df <- effects_df %>% 
  mutate(sqrt_shrubarea3 = sqrt_shrubarea3*sd(sqrt(df$shrubarea3))+mean(sqrt(df$shrubarea3)) )
```

### test
```{r}
hist(effects_df$sqrt_shrubarea3)
hist(sqrt(df$shrubarea3))
```

## Plot effects of shrubarea
```{r}
ggplot(effects_df)+
  geom_line(aes(x = sqrt_shrubarea3, y = exp(fit)))+
  geom_ribbon(aes(x = sqrt_shrubarea3, ymin = exp(lower), ymax = exp(upper)), alpha = .5, fill = "#fdbb84")+
  theme_bw()+
  xlab(bquote('Shrub competition ' (sqrt(`cover (cm)`%*%`height (cm)`))))+
  ylab("Relative growth rate")+
 # ggtitle("Fir growth in relation to shrub environment within 2 m")+
  geom_rug(data = df, aes(x = sqrt(shrubarea3), y = exp(VertGrowth_Rel)), alpha = .5, position = "jitter", sides = "b")+
  ylim(c(0.04,0.3))
ggsave(file = "../../results/figures/FireFootprints/FirVertRel.png", width = 6, height = 6, dpi = 400)
ggsave(file = "../../results/figures/FireFootprints/FirVertRel_int.png", width = 6, height = 6, dpi = 400)
```

# Look at relationship between years and shrubarea
```{r}
ggplot(df)+
  geom_boxplot(aes(x = as.factor(Years), y = shrubarea3))
ggplot(df)+
  geom_boxplot(aes(x = Fire, y = shrubarea3))
```

# Residuals
```{r}
E <- resid(LM, type = "normalized")
df$E <- E
pred <- predict(LM)
plot(LM)
plot(df$shrubarea3, E)
plot(df$Ht_cm1, E)
plot(df$Years, E)

ggplot(df, aes(x = shrubarea3, y = E))+
  geom_point()+
  geom_smooth()
```


## Save final data
```{r}
save(df, file ="~/../Documents/Shrubs-Seedlings/compiled_data/fire_footprints/fir_vert.Rdata")
```
