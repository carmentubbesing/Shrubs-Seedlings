---
title: "Clean growth ~ mortality data"
author: "Carmen"
date: "April 17, 2019"
output: html_document
---

```{r, include = F}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(effects)
```

# Load data
```{r}
df <- read_excel("~/../Dropbox (Stephens Lab)/SORTIE/Growth_mortality/data/details/compiled/Mort_details_compiled_June25_2018.xlsx", sheet = 2)
```

# Delete rows with no data
```{r}
df <- df %>% 
  filter(!is.na(SEEDLING))
```


# Fix typos
```{r}
df <- df %>% 
  mutate(DEAD_ALIVE = ifelse(DEAD_ALIVE == "alive", "ALIVE", DEAD_ALIVE)) %>% 
  mutate(DEAD_ALIVE = ifelse(DEAD_ALIVE == "dead", "DEAD", DEAD_ALIVE)) %>% 
  mutate(SPECIES = ifelse(SPECIES == "abco", "ABCO", SPECIES)) %>% 
  mutate(SPECIES = ifelse(SPECIES == "pipo", "PIPO", SPECIES))
```

# Make numeric
```{r}
df <- df %>% 
  mutate(LAST_YR_GR_cm = as.numeric(LAST_YR_GR_cm)) %>% 
  mutate(MINUS_1_GR_cm = as.numeric(MINUS_1_GR_cm)) %>% 
  mutate(MINUS_2_GR_cm = as.numeric(MINUS_2_GR_cm))
```

```{r}
df <- df %>% 
  mutate(DEAD = ifelse(DEAD_ALIVE == "DEAD", 1, 0))
```

# Fix duplicates
```{r}
df %>% 
  filter(duplicated(SEEDLING))
df %>% 
  filter(SEEDLING %in% c("183", "183B"))
```

## Fix duplicates
```{r}
df <- df %>% 
  mutate(SEEDLING = ifelse(SEEDLING == 183 & SPECIES == "ABCO", "183-A", SEEDLING)) %>% 
  mutate(SEEDLING = ifelse(SEEDLING == 183 & SPECIES == "PIPO", "183-P", SEEDLING)) %>% 
  mutate(SEEDLING = ifelse(SEEDLING == "183B" & SPECIES == "PIPO", "183B-P", SEEDLING)) %>% 
  mutate(SEEDLING = ifelse(SEEDLING == "183B" & SPECIES == "ABCO", "183B-A", SEEDLING)) 
```

# Look at missing growth data
```{r}
df %>% filter(is.na(as.numeric(df$LAST_YR_GR_cm)))
df %>% filter(is.na(as.numeric(df$MINUS_1_GR_cm)))
df %>% filter(is.na(as.numeric(df$MINUS_2_GR_cm)))
```

# Correct mis-recorded growth based on photos
```{r}
df <- df %>% 
  mutate(MINUS_2_GR_cm = ifelse(SEEDLING == 98, 7.1, MINUS_2_GR_cm)) %>% 
  mutate(MINUS_2_GR_cm = ifelse(SEEDLING == 77, 6.4, MINUS_2_GR_cm))
``` 

# Restructure so there's a column for each year of growth

## Height
```{r}
df <- df %>% 
  mutate(ht1 = HEIGHT) %>% 
  mutate(ht2 = HEIGHT - LAST_YR_GR_cm) %>% 
  mutate(ht3 = HEIGHT - LAST_YR_GR_cm - MINUS_1_GR_cm) %>% 
  mutate(ht4 = HEIGHT - LAST_YR_GR_cm - MINUS_1_GR_cm - MINUS_2_GR_cm)
```

## Growth
```{r}
df <- df %>% 
  mutate(gr1 = (ht1-ht2)/ht2) %>% 
  mutate(gr2 = (ht2-ht3)/ht3) %>% 
  mutate(gr3 = (ht3-ht4)/ht4)

```

# Calculate average relative growth rate per seedling
```{r}
df <- df %>% 
  mutate(gr_rel_ave = (gr1+gr2+gr3)/3)
hist(df$gr_rel_ave)
```

## Add column for log growth
```{r}
df <- df %>% 
  mutate(log_gr_rel_ave = log(gr_rel_ave))
hist(df$log_gr_rel_ave)
```

# Make live/dead status a factor
```{r}
df <- df %>% 
  mutate(DEAD = as.factor(DEAD))
```

# Calculate average diameter
```{r}
df <- df %>% 
  mutate(BAS_DIA_AVE = (BAS_DIA_1_mm+BAS_DIA_2_mm)/2)
```

# Create a column for PAIR, or dead #
```{r}
df <- df %>% 
  mutate(SEEDLING = toupper(SEEDLING))
df$PAIR <- NA
bs <- grep("B", df$SEEDLING, value = T)
bs <- substr(bs, 1, nchar(bs)-1)
df[grep("B", df$SEEDLING), "PAIR"] <- bs
head(bs)
df <- df %>% 
  mutate(PAIR = ifelse(is.na(PAIR), SEEDLING, PAIR))

tail(df %>% 
  dplyr::select(SEEDLING, PAIR))
```

## Fix the funky 183/184/185 ones - INCOMPLETE
```{r}
df$PAIR[222:235]
df <- df %>% 
  mutate(PAIR = ifelse(SEEDLING == "184B-P", "184-P",PAIR)) %>% 
  mutate(PAIR = ifelse(SEEDLING == "184B-A", "184-A",PAIR)) %>% 
  mutate(PAIR = ifelse(SEEDLING == "183B-P", "183-P",PAIR)) %>% 
  mutate(PAIR = ifelse(SEEDLING == "183B-A", "183-A",PAIR)) %>% 
  mutate(PAIR = ifelse(SEEDLING == "185B-P", "185-P",PAIR)) %>% 
  mutate(PAIR = ifelse(SEEDLING == "185B-A", "185-A",PAIR)) 
```

# Look at the ones missing pairs in df_bu

## Find mateless seedlings
```{r}
df %>% 
  group_by(PAIR) %>% 
  mutate(count = n()) %>% 
  select(SEEDLING, PAIR, count) %>% 
  arrange(PAIR) %>% 
  filter(count != 2) 
```

# Delete pairs needing to be thrown out by creating a df with all the bad pairs

## Missing data or pathogen damage
```{r}
summary(as.factor(df$Practice))
df_toss <- df %>% 
  filter(Practice == "1") %>% 
  filter(PATH_DAMAGE == "1")
nrow(df_toss)
```

## seedlings marked "thrown out"
```{r}
nrow(df_toss)
df_toss <- full_join(df_toss, df %>% 
  filter(thrown_out == "1"))
nrow(df_toss)
```

## trees that are missing any year of growth
```{r}
nrow(df_toss)
df_toss <- full_join(df_toss, df %>% 
  filter(is.na(LAST_YR_GR_cm) | is.na(MINUS_1_GR_cm) | is.na(MINUS_2_GR_cm)))
nrow(df_toss)
```

## delete pairs in df_toss from df
```{r}
length(unique(df_toss$PAIR))
length(unique(df$PAIR))

nrow(df)
df <- df %>% 
  filter(!PAIR %in% df_toss$PAIR)
nrow(df)
```


# Check for mateless seedlings again
```{r}
df %>% 
  group_by(PAIR) %>% 
  mutate(count = n()) %>% 
  filter(count != 2)
```

# Check out how many usable seedlings I have as of now of each species
```{r}
df %>% 
  filter(DEAD_ALIVE == "DEAD") %>% 
  group_by(SPECIES) %>% 
  summarise(n())
```


# Save 
```{r}
save(df, file = "../../compiled_data/growth_mortality/df_vert.Rdata")
```

# NEXT STEP: MAYBE TRY TO PAIR UP MATELESS SEEDLINGS WITH EACH OTHER SO I DON'T HAVE TO DELETE AS MANY PAIRS