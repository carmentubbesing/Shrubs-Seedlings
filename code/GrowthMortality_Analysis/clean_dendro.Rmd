---
title: "Read Dendro Data"
author: "Carmen"
date: "December 11, 2018"
output: 
  html_document:
    toc: TRUE
---

```{r, include = F}
require(tidyverse)
require(dplR)
require(readxl)
```

# Read in and compile dendro files
```{r}
files <- list.files("../../../../Dropbox (Stephens Lab)/SORTIE/Growth_mortality/data/Growth Mortality Dendro Data/", full.names = T, pattern = ".raw")
```

## Make a dendro rwl and a separate data frame, so that you can manipulate the data frame without it losing rwl status
```{r, message = F, warning = F}
df <- data.frame()
for(i in 1:length(files)){
  file <- files[i]
  rwli <- read.rwl(file)
  if(i >1){
    rwl <- combine.rwl(rwl, rwli)
  } else {
    rwl <- rwli
  }
  dfi <- as.data.frame(t(as.data.frame(rwli)))
  dfi$series <- paste(row.names(dfi))
  delim <- read.delim(file, header = F)
  delim$V1 <- as.character(delim$V1)
  board <- sapply(delim, substr, 74,79)
  board <- unique(board)
  print(board)
  dfi <- dfi %>% 
    mutate(board = board[1])
  if(i == 1){
    df <- dfi
    } else{
     df <- full_join(df, dfi) 
    }
}
```

## Rearrange
```{r}
df <- df %>% 
  select(series, board, everything())
df_bu <- df
```

# Look for repeat trees

## Make series all caps
```{r}
df <- df %>% 
  mutate(series = toupper(series))
```

# Separate out tree number and radius number

## Radius number
```{r}
df$radius <- substr(df$series, nchar(df$series), nchar(df$series)) 
```

## Tree
```{r}
df$tree <- substr(df$series, 1, nchar(df$series)-2) 
```

## Find trees where this technique didn't work and fix them
```{r}
df %>% 
  filter(!radius %in% c(1, 2, 3))
```

### Radius
```{r}
df <- df %>% 
  mutate(radius = ifelse(
    !radius %in% c(1, 2, 3),
    substr(series, nchar(series)-2, nchar(series)),
    radius
    )) 
df %>% 
  filter(!radius %in% c(1, 2, 3))
```

### Series
```{r}
df <- df %>% 
  mutate(tree = ifelse(
    !radius %in% c(1, 2, 3),
    substr(series, 1, nchar(series)-4),
    tree
    )) 
df %>% 
  filter(!radius %in% c(1, 2, 3))
head(df)
```

## Tidy up names
```{r}
df <- df %>% 
  dplyr::select(board, tree, series, radius, everything())
head(df)
```

# Throw out trees from sample board
```{r}
df <- df %>% 
  filter(board != "P1BdS ")
```

# Find duplicate trees
```{r}
df %>% 
  group_by(tree) %>% 
  mutate(count = n()) %>% 
  filter(count != 3) %>% 
  dplyr::select(board, tree, series, radius)
```

## Fix duplicates

### Tree 19

#### Take a look
```{r}
df %>% filter(tree %in% c(19, "19BU"))
```

#### Clearly only the 19BU belongs, so delete the other one and fix the mislabeled radius on the BU board
```{r}
df <- df %>% 
  filter(!(tree == 19 & board == "P1Bd62")) %>% 
  mutate(tree = ifelse(tree %in% c(19, "19BU"), 19, tree))
df %>% filter(tree %in% c(19, "19BU"))
```

# Take out trees that have both BU and non-BU records

## List the trees that are on backup boards
```{r}
dfBU <- df[grep("BU", df$series),] %>% 
  arrange(tree)
```

## Move BU data to a separate column
```{r}
df_bu <- df
df <- df %>% 
  mutate(BU = ifelse(tree %in% dfBU$tree, 1, 0)) %>% 
  ungroup() 
BUs <- grep("BU", df$tree, value = T)
df <- df %>% 
  mutate(tree = ifelse(tree %in% BUs, substr(tree, 1, nchar(tree)-2), tree)) %>% 
  arrange(desc(BU))
```

## View BU duplicates and delete non-BU ones
```{r}
dups <- df %>% 
  group_by(tree) %>% 
  mutate(count = n()) %>% 
  filter(count != 3) %>% 
  arrange(tree)
dups
```

```{r}
df <- df %>% 
  filter(!(tree %in% dups$tree & BU == 0))
```

# Check these changes against the excel Mort_details_compiled... sheet

## Read in excel data
```{r}
meta <- read_excel("../../../../Dropbox (Stephens Lab)/SORTIE/Growth_mortality/data/details/compiled/Mort_details_compiled_June25_2018.xlsx", sheet = "data")
```

## Make all caps
```{r}
meta <- meta %>% 
  mutate(SEEDLING = toupper(SEEDLING))
```


## Make a list of trees that were thrown out in excel data
```{r}
meta_thrown <- meta %>% 
  filter(thrown_out == 1) %>% 
  dplyr::select(COMP, DATE, SEEDLING, DEAD_ALIVE, thrown_out, NOTES, Notes, PATH_DAMAGE) %>% 
  arrange(desc(SEEDLING)) 
meta_thrown
```

## Find seedlings in df that are also in meta_thrown
```{r}
meta_thrown %>% 
  filter(SEEDLING %in% df$tree)
```

## Add reasons for exclusion in the notes section of meta 
```{r}
meta <- meta %>% 
  mutate(exclude_reason = NA)
```

### Create function for Add Exclusion Reason
```{r}
aer <- function(seedling, reason){
  meta <<- meta %>% 
    mutate(exclude_reason = ifelse(SEEDLING == seedling, reason, exclude_reason))
}
```

### Apply to seedlings one by one by looking at data
```{r}
aer("65B", "mate excluded")
aer("65", "beetles")
aer("94", "PATH_DAMAGE")
aer("92", "PATH_DAMAGE")
aer("92B", "mate excluded")
aer(76, "beetles")
aer(7, "PATH_DAMAGE")
aer(6, "PATH_DAMAGE")
aer("6B", "mate excluded")
aer("59", "beetles")
aer("59B", "mate excluded")
aer("58", "beetles")
aer(53, "PATH_DAMAGE")
aer(5, "PATH_DAMAGE")
aer(28, "PATH_DAMAGE")
aer("22", "MUNCHED")
aer("194", "TOO YOUNG")
aer("194B", "TOO YOUNG")
aer("189", "PATH_DAMAGE")
aer("188", "PATH_DAMAGE")
aer("187", "TOO YOUNG")
aer("187B", "TOO YOUNG")
aer("185-A", "beetles")
aer("17", "MUNCHED")
aer("162", "MUNCHED")
aer("155", "unkn")
aer("147", "MUNCHED")
aer("149", "beetles")
aer(146, "PATH_DAMAGE")
aer("146B", "mate excluded")
aer(145, "beetles")
aer(136, "beetles")
aer(116, "beetles")
aer("116B", "mate excluded")
aer(114, "pitching")
aer(104, "PATH_DAMAGE")
aer(104, "PATH_DAMAGE")
aer(103, "PATH_DAMAGE")
aer("103B", "PATH_DAMAGE")
```

The following are marked as being thrown out, but DO have data, so could potentially be used as a back-up mate if needed,

So make them thrown_out = ?
```{r}
meta <- meta %>% 
  mutate(thrown_out = ifelse(SEEDLING %in% c("58B", "53B", "7B", "28B", "22B", "189B", "188B", "185BA", "17B", "162B", "155B", "147B", "149B", "145B", "136B", "114B", "104B", "94B"), "?", thrown_out))
```

### Add column to df for mateless seedlings
```{r}
df <- df %>% 
  mutate(mateless = ifelse(tree %in% c("7B","76B", "58B", "53B", "5B", "28B", "22B", "189B", "188B", "185BA", "17B", "162B", "155B", "147B", "149B", "145B", "136B", "114B", "104B", "94B"), 1, 0)) %>% 
  arrange(desc(mateless))
```

## See what thrown out seedlings remain without a exclude_reason
```{r}
meta %>% 
  filter(thrown_out == 1 & is.na(exclude_reason)) %>% 
  dplyr::select(COMP, DATE, SEEDLING, DEAD_ALIVE, thrown_out, NOTES, Notes, PATH_DAMAGE) %>% 
  arrange(desc(SEEDLING)) 
```


## Correct 184A/184-A/185
```{r}
df <- df %>% 
  mutate(tree = ifelse(tree == "184A", "184-A", tree)) %>% 
  mutate(tree = ifelse(tree == "184BA", "184B-A", tree)) %>% 
  mutate(tree = ifelse(tree == "185BA", "185B-A", tree)) %>% 
  mutate(tree = ifelse(tree == "185B", "185B-P", tree))
```


# Check for mismatches between df and meta not created by thrown out seedlings
```{r}
join <- full_join(df, meta, by = c("tree" = "SEEDLING")) %>% filter(thrown_out != 1)
```

## clean up joined table
```{r}
join <- join %>% 
  mutate(DEAD_ALIVE = toupper(DEAD_ALIVE)) %>% 
  mutate(SPECIES = toupper(SPECIES)) 
```

## Look at seedlings without meta data - make notes below about which to look for the physical seedlings for
```{r}
join %>%
  filter(is.na(board) | tree %in% (join %>% filter(is.na(board)))$tree) %>% 
  dplyr::select(board, tree, NOTES, Notes, `Tops cut?`) 
```

The 185B-P correction is based on the "dendro" sheet of hte Mort_details... .xls file

## Correct seedlings with dendro data but not meta data
```{r}
join %>% 
  filter(is.na(DEAD_ALIVE))
```


# Check for mateless seedlings not marked as such

## Create a column for PAIR, or dead #
```{r}
join$PAIR <- NA
bs <- grep("B", join$tree, value = T)
bs <- substr(bs, 1, nchar(bs)-1)
join[grep("B", join$tree), "PAIR"] <- bs
head(bs)
join <- join %>% 
  mutate(PAIR = ifelse(is.na(PAIR), tree, PAIR))

head(join %>% 
  dplyr::select(tree, PAIR))
```

# Find mateless seedlings not marked as such and not already flagged for needing me to check them
```{r}
join %>% 
  group_by(PAIR) %>% 
  mutate(count = n()) %>% 
  filter(count != 6) %>% 
  arrange(PAIR) %>% 
  filter(mateless == 0) %>% 
  select(board, tree, series, radius, BU, PAIR, mateless, thrown_out, exclude_reason) %>% 
  filter(!PAIR %in% c(12, 155, 26, 98, 63, 163, 159, 195, 205))
```

## Fix the funky 183/184/185 ones - INCOMPLETE
```{r}
join <- join %>% 
  mutate(PAIR = ifelse(tree == "184B-P", "184-P",PAIR))
```

```{r}
join %>% 
  filter(PAIR == "183B-") %>% 
  select(board, tree, series, radius, BU, PAIR, mateless, thrown_out, exclude_reason) 
```

```{r}
join <- join %>% 
  mutate(PAIR = ifelse(tree == "185B-P", "185-P",PAIR)) %>% 
  mutate(PAIR = ifelse(tree == "185B-A", "185-A",PAIR)) %>% 
  mutate(PAIR = ifelse(tree == "184B-A", "184-A",PAIR)) %>% 
  mutate(PAIR = ifelse(tree == "183B-A", "183-A",PAIR)) %>% 
  mutate(PAIR = ifelse(tree == "183B-P", "183-P",PAIR)) 
  
```

# Check again
```{r}
join %>% 
  group_by(PAIR) %>% 
  mutate(count = n()) %>% 
  filter(count != 6) %>% 
  arrange(PAIR) %>% 
  filter(mateless == 0) %>% 
  select(board, tree, series, radius, BU, PAIR, mateless, thrown_out, exclude_reason) %>% 
  filter(!PAIR %in% c(12, 155, 26, 98, 63, 163, 159, 195, 205))
```

# See about pairing up mateless seedlings with each other if possible
```{r}
join %>% 
  group_by(PAIR) %>% 
  mutate(count = n()) %>% 
  filter(count != 6) %>% 
  filter(DEAD_ALIVE == "DEAD") %>% 
  dplyr::select(tree, PAIR, thrown_out, board, DEAD_ALIVE, mateless) %>% 
  distinct() %>% 
  arrange(tree) %>% 
  filter(!is.na(board))

```

What species are these missing seedlings?
```{r}
join %>% 
  filter(tree %in% c("12", "155", "26", "98", "63B", "163B", "159B", "195B", "205B")) %>% 
  dplyr::select(tree, SPECIES)
```

A lot of them are pines, which means I should really try to find them

# Check out how many usable seedlings I have as of now of each species
```{r}
join %>% 
  filter(!is.na(board)) %>% 
  filter(DEAD_ALIVE == "DEAD") %>% 
  group_by(SPECIES) %>% 
  summarise(n())
```

# Check for seedlings with <3 years worth of growth data
```{r}
nas <- join %>% 
    select(5:17) %>% 
    is.na %>% 
    `!` %>% 
    rowSums
```

```{r}
join[nas<3,] %>% 
   dplyr::select(tree, PAIR, 5:17, thrown_out, board, DEAD_ALIVE, mateless, exclude_reason) %>% 
  filter(thrown_out ==0)
```

## Take out 74 because even the backup only has 2 years of growth
```{r}
join %>% 
  filter(PAIR ==74) %>% 
   dplyr::select(5:17, tree, PAIR, thrown_out, board, DEAD_ALIVE, mateless, exclude_reason)
```

```{r}
join <- join %>% 
  mutate(thrown_out = ifelse(tree == 74, 1, thrown_out)) %>% 
  mutate(mateless = ifelse(tree == "74B", 1, mateless)) %>% 
  mutate(thrown_out = ifelse(tree == "74B", "?", thrown_out)) %>% 
  mutate(exclude_reason = ifelse(tree == 74, "<3 yrs growth", exclude_reason))
```

## Check that the live mates with <3 years growth have counterparts with 3+ yrs growth
```{r}
join %>% 
  filter(PAIR %in% c(222, 207, 91)) %>% 
  dplyr::select(5:17, tree, PAIR, thrown_out, board, DEAD_ALIVE, mateless, exclude_reason) %>% 
  arrange(tree)
```

```{r}
join <- join %>% 
  mutate(thrown_out = ifelse(tree %in% c("222B","207B", "91B"), "?", thrown_out)) %>% 
  mutate(exclude_reason = ifelse(tree %in% c("222B","207B", "91B"), "<3 yrs growth", exclude_reason)) %>% 
  mutate(mateless = ifelse(tree %in% c("222","207", "91"), "?", mateless))
```

# Just for funsies, compare growth in dead trees vs. live trees, roughly

## Tidy growth data
```{r}
join <- gather(join, key = "YEAR", value = "GROWTH_mm", 5:17)
```

## Compare
```{r}
prelim <- join %>% 
  filter(!is.na(GROWTH_mm)) %>% 
  filter(thrown_out == 0) %>% 
  filter(YEAR %in% c(2014, 2015, 2016)) %>% 
  mutate(rel_growth = GROWTH_mm/BAS_DIA_1_mm) %>% 
  group_by(tree, SPECIES, DEAD_ALIVE) %>% 
  summarize(rel_growth = mean(rel_growth), growth_mm = mean(GROWTH_mm), growth_vert = mean(na.omit(as.numeric(paste(LAST_YR_GR_cm))/HEIGHT)))

ggplot(prelim)+
  geom_boxplot(aes(x = interaction(SPECIES, DEAD_ALIVE), y= rel_growth))
anova(lm(rel_growth ~ DEAD_ALIVE, data = prelim %>% filter(SPECIES == "PIPO")))
ggplot(prelim)+
  geom_boxplot(aes(x = interaction(SPECIES, DEAD_ALIVE), y= growth_mm))
ggplot(prelim)+
  geom_boxplot(aes(x = interaction(SPECIES, DEAD_ALIVE), y= growth_vert))

```

# It looks preliminarily like dead seedlings have greater radial growth and lower vertical growth than live seedlings

# Take out thrown out seedlings from rwl

## Make colnames of rwl all caps
```{r}
rwl_bu <- rwl
colnames(rwl) <- toupper(colnames(rwl))
```


```{r}
thrown_out <- join %>% 
  filter(thrown_out != 0 | mateless == 1) %>% 
  dplyr::select(series) %>% 
  distinct()
nrow(thrown_out)
ncol_old <- ncol(rwl)
ncol_old
sum(colnames(rwl) %in% thrown_out$series)
rwl <- rwl[, !colnames(rwl) %in% thrown_out$series]
ncol_old - ncol(rwl) == nrow(thrown_out)
```

# save rwl
```{r}
save(rwl, file = "../../data/GrowthMortality/rwl.Rdata")
```


# MAJOR THINGS I NEED TO DO:

Seedlings needing checking: 12, 155, 26, 98, 63B, 163B, 159B, 195B, 205B

1. Which 12 is the real 12?
2. Check why Seedling 155 was thrown out - it's on board 32 but no data 
3. Look for seedling 26 on board 39 - it doesn't have measurements in the original board 39 data
2. seedlings 98, 63B, and 163B - they're not listed as having a board, so look for it in the thrown out pile
3. Seedling 159B - not listed as having a board
4. Look for seedling 195B - on board 28 but not in data
5. 205B - missing
4. See which trees do and don't have mates
3. APPLY THESE CHANGES TO THE rwl DATA FRAME
6. ASK JODI WHETHER DIAMETER CHANGES AS TREES AGE AFTER DEATH

