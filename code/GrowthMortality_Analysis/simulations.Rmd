---
title: "simulations"
author: "Carmen"
date: "May 16, 2019"
output: 
    html_document:
        toc: TRUE
---

```{r, include = F}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(effects)
require(MASS)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/code/GrowthMortality_Analysis/")
load(file = "../../compiled_data/growth_mortality/df_vert.Rdata")
```

#  Make dead a factor
```{r}
df <- df %>% 
  mutate(DEAD_ALIVE = as.factor(DEAD_ALIVE))
```

# Make separate df for each species
```{r}
dfa <- df %>% filter(SPECIES == "ABCO")
dfp <- df %>% filter(SPECIES == "PIPO")
```

# Define ymax to be used throughout both abco and pipo graphs

## Set y limits for graphs later
```{r}
ymax_set <- 10
```

#  _
# ABCO SIMULATIONS

## Visually compare distributions
```{r}
means <- dfa %>% 
  group_by(DEAD_ALIVE) %>% 
  summarize(mean = mean(log_gr_rel_ave))
sd <- dfa %>% 
  group_by(DEAD_ALIVE) %>% 
  summarize(sd = sd(log_gr_rel_ave))
means
sd
```

```{r}
x <- seq(-4, 0, length=1000)
y <- dnorm(x, mean=means[[2,2]], sd=sd[[2,2]])
pdf_dead <- as.data.frame(cbind(x, y))
```

```{r}
x <- seq(-4, 0, length=1000)
y <- dnorm(x, mean=means[[1,2]], sd=sd[[1,2]])
pdf_live <- as.data.frame(cbind(x, y))
```

```{r}
ggplot()+
  geom_histogram(data = dfa %>% filter(DEAD_ALIVE=="DEAD"), aes(log_gr_rel_ave, stat(density)), bins = 20, alpha = .2, col = "red", fill = "red")+
  theme_bw()+
  geom_histogram(data = dfa %>% filter(DEAD_ALIVE=="ALIVE"), aes(log_gr_rel_ave, stat(density)), bins = 20, alpha = .2, col = "dark green", fill = "dark green")+
  geom_vline(data = means, aes(xintercept = mean, col = DEAD_ALIVE))+
  scale_color_manual(values = c("dark green", "red"))+
  geom_line(data = pdf_dead, aes(x = x, y = y), col = "red")+
  geom_line(data = pdf_live, aes(x = x, y = y), col = "dark green")
  
ggsave("../../results/figures/GrowthMortality/histogram_dead_alive_pipo.png")
```

# Actual simulations for ABCO

## Count abco n in the POPULATION for live and dead
```{r}
n_dead_pop <- unlist(dfa %>% 
                   filter(DEAD_ALIVE=="DEAD") %>% 
                   summarize(n()))
n_dead_pop
```

```{r}
n_alive_pop <- n_dead_pop*(1103/25)
```

## Count abco n in MEASURED TREES for live and dead
```{r}
n_alive <- nrow(dfa %>% filter(DEAD_ALIVE == "ALIVE"))
n_dead <- nrow(dfa %>% filter(DEAD_ALIVE == "DEAD"))
```

## Find the sets of live and dead growth rates to draw from
```{r}
gr_set_dead <- dfa %>% 
    filter(DEAD_ALIVE=="DEAD") %>% 
    dplyr::select(log_gr_rel_ave)
gr_set_dead <- gr_set_dead[[1]]

gr_set_alive <- dfa %>% 
  filter(DEAD_ALIVE=="ALIVE") %>%
  dplyr::select(log_gr_rel_ave)
gr_set_alive <- gr_set_alive[[1]]
```

## Loop it 
```{r}
coefficient_gr <- c()
coefficient_int <- c()
for(i in 1:1000){
  dead_sample <- sample(gr_set_dead, size = n_dead_pop, replace = TRUE) 
  alive_sample <- sample(gr_set_alive, size = n_alive_pop, replace = TRUE)
  live_df <- data.frame(gr = c(alive_sample))
  live_df$dead <- 0
  dead_df <- data.frame(gr = c(dead_sample))
  dead_df$dead <- 1
  df <- bind_rows(dead_df, live_df)
  glm <- glm(dead ~ gr, family = binomial(link = "logit"), data = df)
  coefficient_gr <- c(coefficient_gr, glm$coefficient[2])
  coefficient_int <- c(coefficient_int, glm$coefficient[1])
}
mean_coef_gr <- mean(coefficient_gr)
mean_coef_int <- mean(coefficient_int)
```

## Plot the mean coefficient and CI

### Calculate probabilities
```{r}
log_gr_rel <- seq(log(.03), log(.3), length=1000)
dfgraph <- as.data.frame(log_gr_rel)
dfgraph$prob <- exp(mean_coef_int + mean_coef_gr*log_gr_rel)/(1+exp(mean_coef_int + mean_coef_gr*log_gr_rel))
summary(dfgraph$prob)
```

### Calculate confidence intervals to plot
```{r}
CI_low_int <- sort(coefficient_int)[25]
CI_high_int <- sort(coefficient_int)[975]
CI_low_gr <- sort(coefficient_gr)[25]
CI_high_gr <- sort(coefficient_gr)[975]
```

#### lower
```{r}
log_gr_rel <- seq(log(.03), log(.3), length=1000)
head(log_gr_rel)
dfgraph_lower <- as.data.frame(log_gr_rel)
dfgraph_lower$prob <- exp(mean_coef_int + CI_low_gr*log_gr_rel)/(1+exp(mean_coef_int + CI_low_gr*log_gr_rel))
summary(dfgraph_lower$prob)
```

#### upper
```{r}
log_gr_rel <- seq(log(.03), log(.3), length=1000)
head(log_gr_rel)
dfgraph_upper <- as.data.frame(log_gr_rel)
dfgraph_upper$prob <- exp(mean_coef_int + CI_high_gr*log_gr_rel)/(1+exp(mean_coef_int + CI_high_gr*log_gr_rel))
summary(dfgraph_upper$prob)
```

### Adjust probabilities to be yearly, since I found dead trees from 3 years 
```{r}
head(dfgraph)
dfgraph <- dfgraph %>% 
  mutate(prob = prob/3)
head(dfgraph_lower)
dfgraph_lower <- dfgraph_lower %>% 
  mutate(prob = prob/3)
dfgraph_upper <- dfgraph_upper %>% 
  mutate(prob = prob/3)
```


# Plot it

## Load growth results from fire footprings
```{r}
load(file = "../../results/data/FireFootprints/gr_minshrub_abco.Rdata")
load(file = "../../results/data/FireFootprints/gr_maxshrub_abco.Rdata")
load(file = "../../results/data/FireFootprints/gr_medshrub_abco.Rdata")
```

```{r}
ggplot()+
  geom_line(data = dfgraph, aes(x = exp(log_gr_rel), y = prob*100))+
  geom_line(data = dfgraph_lower, aes(x = exp(log_gr_rel), y = prob*100), linetype = "dashed")+
  geom_line(data = dfgraph_upper, aes(x = exp(log_gr_rel), y = prob*100), linetype = "dashed")+
  theme_bw()+
  geom_vline(aes(xintercept = gr_minshrub_abco), col = "dark orange")+
  geom_text(aes(x= gr_minshrub_abco, label="\ngrowth at minimum shrub competition", y = ymax_set*.6), colour="dark orange", angle=90, size = 3) +
  
  geom_vline(aes(xintercept = gr_maxshrub_abco), col = "dark red")+
  geom_text(aes(x= gr_maxshrub_abco, label="\ngrowth at maximum shrub competition", y = ymax_set*.6), colour="dark red", angle=90, size = 3) +
  
  geom_vline(aes(xintercept = gr_medshrub_abco), col = "red")+
  geom_text(aes(x= gr_medshrub_abco, label="\ngrowth at median shrub competition", y = ymax_set*.6), colour="red", angle=90, size = 3) +
  
  xlim(0.03, .27)+
  ylim(0, ymax_set)+
   theme(text = element_text(size = 11),
        panel.grid.minor = element_blank())+
  #ggtitle("Fir mortality probability in relation to growth\nbased on simulation results, with 95% confidence intervals")+    ylab("Annual % mortality probability")+
  xlab(bquote('Annual relative growth defined as '  ~ frac((height[2] - height[1]),height[1])))+
  ylab("Annual % mortality probability")
ggsave("../../results/figures/GrowthMortality/predict_mortality_abco.png", height = 4, width = 5)
```


# Calculate the min and max and median mortality probability captured by the fire footprint growth data


## Create a function for calculating mort probability
```{r}
calc_prob_mort <- function(log_growth){
  prob_3_yrs <- (exp(mean_coef_int + mean_coef_gr*log_growth)/(1+exp(mean_coef_int + mean_coef_gr* log_growth)))
  return(prob_3_yrs/3)
}
```

## Check it
```{r}
test_log_growth <- head(dfgraph)[1,1]
test_log_growth
calc_prob_mort(test_log_growth) == head(dfgraph)[1,2]
calc_prob_mort(log(.05))
```


```{r}
prob_median <-calc_prob_mort(log(gr_medshrub_abco))
prob_median
```

## Use it
```{r}
prob_min <- calc_prob_mort(log(gr_minshrub_abco))
prob_max <- calc_prob_mort(log(gr_maxshrub_abco))

prob_min
prob_max

(prob_max-prob_min)/prob_min
```

## Compile the results
```{r}
abco_growth_pred <- cbind(prob_min, prob_max, prob_median)

abco_growth_pred <- as.data.frame(t(abco_growth_pred)) %>% 
  rename(ABCO_perc_mort = V1) %>% 
  mutate(metric = names(as.data.frame(abco_growth_pred))) %>% 
  mutate(ABCO_perc_mort = ABCO_perc_mort*100) %>% 
  dplyr::select(metric, ABCO_perc_mort)
abco_growth_pred
```


## Compile the results
```{r}
abco_growth_pred <- cbind(prob_min, prob_max, prob_median)
abco_growth_pred <- as.data.frame(t(abco_growth_pred)) 
row.names(abco_growth_pred) <- c("min", "max", "median")
abco_growth_pred
abco_growth_pred <- abco_growth_pred %>% 
  mutate(shrubs = row.names(abco_growth_pred)) %>%  
  rename(Mort = "V1") %>% 
  mutate(Species = "ABCO") %>% 
  mutate(Perc_mort = Mort*100) 
abco_growth_pred
```


# _
# PIPO SIMULATIONS

## Visually compare distributions
```{r}
means <- dfp %>% 
  group_by(DEAD_ALIVE) %>% 
  summarize(mean = mean(log_gr_rel_ave))
sd <- dfp %>% 
  group_by(DEAD_ALIVE) %>% 
  summarize(sd = sd(log_gr_rel_ave))
means
sd
```

```{r}
x <- seq(-4, 0, length=1000)
y <- dnorm(x, mean=means[[2,2]], sd=sd[[2,2]])
pdf_dead <- as.data.frame(cbind(x, y))
```

```{r}
x <- seq(-4, 0, length=1000)
y <- dnorm(x, mean=means[[1,2]], sd=sd[[1,2]])
pdf_live <- as.data.frame(cbind(x, y))
```

```{r}
ggplot()+
  geom_histogram(data = dfp %>% filter(DEAD_ALIVE=="DEAD"), aes(log_gr_rel_ave, stat(density)), bins = 20, alpha = .2, col = "red", fill = "red")+
  theme_bw()+
  geom_histogram(data = dfp %>% filter(DEAD_ALIVE=="ALIVE"), aes(log_gr_rel_ave, stat(density)), bins = 20, alpha = .2, col = "dark green", fill = "dark green")+
  geom_vline(data = means, aes(xintercept = mean, col = DEAD_ALIVE))+
  scale_color_manual(values = c("dark green", "red"))+
  geom_line(data = pdf_dead, aes(x = x, y = y), col = "red")+
  geom_line(data = pdf_live, aes(x = x, y = y), col = "dark green")
  
ggsave("../../results/figures/GrowthMortality/histogram_dead_alive_pipo.png")
```

# Actual simulations for PIPO

## Count pipo n for live and dead
```{r}
n_dead_pop <- unlist(dfp %>% 
                   filter(DEAD_ALIVE=="DEAD") %>% 
                   summarize(n()))
```

```{r}
n_alive_pop <- n_dead_pop*(524/6)
```
    
## Count pipo n in MEASURED TREES for live and dead
```{r}
n_alive <- nrow(dfp %>% filter(DEAD_ALIVE == "ALIVE"))
n_dead <- nrow(dfp %>% filter(DEAD_ALIVE == "DEAD"))
```

## Find the sets of live and dead growth rates to draw from
```{r}
gr_set_dead <- dfp %>% 
    filter(DEAD_ALIVE=="DEAD") %>% 
    dplyr::select(log_gr_rel_ave)
gr_set_dead <- gr_set_dead[[1]]

gr_set_alive <- dfp %>% 
  filter(DEAD_ALIVE=="ALIVE") %>%
  dplyr::select(log_gr_rel_ave)
gr_set_alive <- gr_set_alive[[1]]
```

## Loop it 
```{r}
coefficient_gr <- c()
coefficient_int <- c()
for(i in 1:1000){
  dead_sample <- sample(gr_set_dead, size = n_dead_pop, replace = TRUE) 
  alive_sample <- sample(gr_set_alive, size = n_alive_pop, replace = TRUE)
  live_df <- data.frame(gr = c(alive_sample))
  live_df$dead <- 0
  dead_df <- data.frame(gr = c(dead_sample))
  dead_df$dead <- 1
  df <- bind_rows(dead_df, live_df)
  glm <- glm(dead ~ gr, family = binomial(link = "logit"), data = df)
  coefficient_gr <- c(coefficient_gr, glm$coefficient[2])
  coefficient_int <- c(coefficient_int, glm$coefficient[1])
}
mean_coef_gr <- mean(coefficient_gr)
mean_coef_int <- mean(coefficient_int)
```

## Plot the mean coefficient and CI

### Calculate probabilities
```{r}
log_gr_rel <- seq(log(.03), log(.3), length=1000)
dfgraph <- as.data.frame(log_gr_rel)
dfgraph$prob <- exp(mean_coef_int + mean_coef_gr*log_gr_rel)/(1+exp(mean_coef_int + mean_coef_gr*log_gr_rel))
```

### CI
```{r}
CI_low_int <- sort(coefficient_int)[25]
CI_high_int <- sort(coefficient_int)[975]
CI_low_gr <- sort(coefficient_gr)[25]
CI_high_gr <- sort(coefficient_gr)[975]
```

```{r}
log_gr_rel <- seq(log(.03), log(.3), length=1000)
head(log_gr_rel)
dfgraph_lower <- as.data.frame(log_gr_rel)
dfgraph_lower$prob <- exp(mean_coef_int + CI_low_gr*log_gr_rel)/(1+exp(mean_coef_int + CI_low_gr*log_gr_rel))
summary(dfgraph_lower$prob)
```

```{r}
log_gr_rel <- seq(log(.03), log(.3), length=1000)
head(log_gr_rel)
dfgraph_upper <- as.data.frame(log_gr_rel)
dfgraph_upper$prob <- exp(mean_coef_int + CI_high_gr*log_gr_rel)/(1+exp(mean_coef_int + CI_high_gr*log_gr_rel))
summary(dfgraph_upper$prob)
```

### Adjust probabilities to be yearly, since I found dead trees from 3 years 
```{r}
head(dfgraph)
dfgraph <- dfgraph %>%
  mutate(prob = prob/3)
head(dfgraph_lower)
dfgraph_lower <- dfgraph_lower %>%
  mutate(prob = prob/3)
dfgraph_upper <- dfgraph_upper %>%
  mutate(prob = prob/3)
```

# Plot it

## Load growth results from fire footprings
```{r}
load(file = "../../results/data/FireFootprints/gr_minshrub_pipo.Rdata")
load(file = "../../results/data/FireFootprints/gr_maxshrub_pipo.Rdata")
load(file = "../../results/data/FireFootprints/gr_medshrub_pipo.Rdata")
```


```{r}
ggplot()+
  geom_line(data = dfgraph, aes(x = exp(log_gr_rel), y = prob*100))+
  geom_line(data = dfgraph_lower, aes(x = exp(log_gr_rel), y = prob*100), linetype = "dashed")+
  geom_line(data = dfgraph_upper, aes(x = exp(log_gr_rel), y = prob*100), linetype = "dashed")+
  theme_bw()+
  ylim(0, ymax_set)+
  xlim(0.03, .27)+
  ylab("Annual % mortality probability")+
  xlab(bquote('Annual relative growth defined as '  ~ frac((height[2] - height[1]),height[1])))+
  theme(panel.grid.minor = element_blank(),
        text = element_text(size = 11))+
  
  geom_vline(aes(xintercept = gr_minshrub_pipo), col = "dark orange")+
  geom_text(aes(x= gr_minshrub_pipo, label="\ngrowth at minimum shrub competition", y = ymax_set*.6), colour="dark orange", angle=90, size = 3) +
  
  geom_vline(aes(xintercept = gr_maxshrub_pipo), col = "dark red")+
  geom_text(aes(x= gr_maxshrub_pipo, label="\ngrowth at maximum shrub competition", y = ymax_set*.6), colour="dark red", angle=90, size = 3) +
  
  geom_vline(aes(xintercept = gr_medshrub_pipo), col = "red")+
  geom_text(aes(x= gr_medshrub_pipo, label="\ngrowth at median shrub competition", y = ymax_set*.6), colour="red", angle=90, size = 3) 
 
ggsave("../../results/figures/GrowthMortality/predict_mortality_pipo.png", height = 4, width = 5)
```

# Calculate the range of mortality probabilities captured by the fire footprint growth data

## Create a function for calculating mort probability
```{r}
calc_prob_mort <- function(log_growth){
  prob_3_yrs <- (exp(mean_coef_int + mean_coef_gr*log_growth)/(1+exp(mean_coef_int + mean_coef_gr* log_growth)))
  return(prob_3_yrs/3)
}
```

## Check it
```{r}
test_log_growth <- head(dfgraph)[1,1]
test_log_growth
calc_prob_mort(test_log_growth) == head(dfgraph)[1,2]
```

## Use it
```{r}
prob_min <- calc_prob_mort(log(gr_minshrub_pipo))
prob_max <- calc_prob_mort(log(gr_maxshrub_pipo))  

prob_min
prob_max
prob_min-prob_max
(prob_max-prob_min)/prob_min
```

```{r}
prob_median <-calc_prob_mort(log(gr_medshrub_pipo))
prob_median
```

## Compile the results
```{r}
pipo_growth_pred <- cbind(prob_min, prob_max, prob_median)
pipo_growth_pred <- as.data.frame(t(pipo_growth_pred)) 
row.names(pipo_growth_pred) <- c("min", "max", "median")
pipo_growth_pred
pipo_growth_pred <- pipo_growth_pred %>% 
  mutate(shrubs = row.names(pipo_growth_pred)) %>%  
  rename(Mort = "V1") %>% 
  mutate(Species = "PIPO") %>% 
  mutate(Perc_mort = Mort*100) 
pipo_growth_pred
```

# Compile results for both species

```{r}
results <- full_join(abco_growth_pred, pipo_growth_pred)
results
```

```{r}
abco_growth <- cbind(gr_minshrub_abco, gr_maxshrub_abco, gr_medshrub_abco)
abco_growth <- as.data.frame(t(abco_growth))
row.names(abco_growth) <- c("min", "max", "median")
abco_growth <- abco_growth %>%
  mutate(shrubs = row.names(abco_growth)) %>% 
  rename(Growth = "V1") %>% 
  mutate(Species = "ABCO")
abco_growth
```

```{r}
pipo_growth <- cbind(gr_minshrub_pipo, gr_maxshrub_pipo, gr_medshrub_pipo)
pipo_growth <- as.data.frame(t(pipo_growth))
row.names(pipo_growth) <- c("min", "max", "median")
pipo_growth <- pipo_growth %>%
  mutate(shrubs = row.names(pipo_growth)) %>% 
  rename(Growth = "V1") %>% 
  mutate(Species = "PIPO")
pipo_growth
```

```{r}
growth <- rbind(abco_growth, pipo_growth)
growth
```

```{r}
results_final <- full_join(results, growth) %>% 
  dplyr::select(shrubs, Species, Growth, Perc_mort) %>% 
  arrange(desc(shrubs), desc(Species))
results_final
results_nomedian <- results_final %>% 
  filter(shrubs != "median")
results_nomedian
```


```{r}
save(results, file = "../../results/tables/mort_rates.Rdata")
write.csv(results_nomedian, file = "../../results/tables/mort_rates.csv")
```


