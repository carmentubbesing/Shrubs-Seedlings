---
title: "Vertical growth analysis"
author: "Carmen"
date: "November 18, 2017"
output: 
    html_document:
        toc: TRUE
---

```{r, include = F}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(effects)
```

# Load data
```{r}
setwd("~/Shrubs-Seedlings/code/GrowthMortality_Analysis/")
load(file = "../../compiled_data/growth_mortality/df_vert.Rdata")
```

#  Make dead a factor
```{r}
df <- df %>% 
  mutate(DEAD_ALIVE = as.factor(DEAD_ALIVE))
```

# Plot growth by year
```{r}
df2 <- gather(df, key = "year", value = "gr_rel", c(gr1, gr2, gr3)) %>% 
  mutate(year = ifelse(year == "gr1", "top growth", year)) %>% 
  mutate(year = ifelse(year == "gr2", "top growth - 1", year)) %>% 
  mutate(year = ifelse(year == "gr3", "top growth - 2", year)) %>% 
  mutate(year = as.factor(year))

df2$year <-  factor(df2$year, levels = rev(levels(df2$year)))

df2 %>% dplyr::select(year, gr_rel, SEEDLING)
ggplot(df2)+
  geom_boxplot(aes(x = year, y = log(gr_rel), fill = DEAD_ALIVE))+
  facet_wrap(~SPECIES)
```

# Nice graphs for publication


# Plot seedling growth rate against whether it's dead
```{r}
dfa <- df %>% 
  filter(SPECIES == "ABCO") %>% 
  group_by(DEAD_ALIVE) %>% 
  mutate(mean_log_gr = mean(log_gr_rel_ave))
ggplot(dfa)+
  geom_boxplot(aes(x = DEAD_ALIVE, y = log_gr_rel_ave, fill = DEAD), alpha = .5)+
  geom_point(aes(x = DEAD_ALIVE, y = mean_log_gr, col = DEAD), size = 2)+
  scale_fill_manual(values = c("#c7e9c0", "#fdd0a2"))+
  scale_color_manual(values = c("#31a354", "#e6550d"))+
  xlab("")+
  ylim(-5, 0)+
  scale_x_discrete(labels = c("Alive", "Dead"))+
  ylab("Relative growth rate, log transformed")+
  theme_bw()+
  theme(legend.position = "none", axis.text=element_text(size=12))+
  ggtitle("ABCO average relative vertical growth,\nlog transformed")
  
ggsave(file = "../../results/figures/GrowthMortality/Fir_vert_boxplot.png", width = 4, height = 6, dpi = 400)
```


# Nice graphs for publication
```{r}
dfp <- df %>% 
  filter(SPECIES == "PIPO") %>% 
  group_by(DEAD_ALIVE) %>% 
  mutate(mean_log_gr = mean(log_gr_rel_ave))
ggplot(dfp)+
  geom_boxplot(aes(x = DEAD_ALIVE, y = log_gr_rel_ave, fill = DEAD), alpha = .5)+
  geom_point(aes(x = DEAD_ALIVE, y = mean_log_gr, col = DEAD), size = 2)+
  scale_fill_manual(values = c("#c7e9c0", "#fdd0a2"))+
  scale_color_manual(values = c("#31a354", "#e6550d"))+
  xlab("")+
  ylim(-5, 0)+
  scale_x_discrete(labels = c("Alive", "Dead"))+
  ylab("Relative growth rate, log transformed")+
  theme_bw()+
  theme(legend.position = "none", axis.text=element_text(size=12))+
  ggtitle("PIPO average relative vertical growth,\nlog transformed")
  
ggsave(file = "../../results/figures/GrowthMortality/Pine_vert_boxplot.png", width = 4, height = 6, dpi = 400)
```


# Make separate df for each species
```{r}
dfa <- df %>% filter(SPECIES == "ABCO")
dfp <- df %>% filter(SPECIES == "PIPO")
```

# GLM for abco

## Test whether to include height, diameter, or the interaction with height or diameter

### Height
```{r}
AIC(glm(DEAD ~ log_gr_rel_ave*HEIGHT, family = binomial(link = "logit"), data = dfa))
AIC(glm(DEAD ~ log_gr_rel_ave+HEIGHT, family = binomial(link = "logit"), data = dfa))
AIC(glm(DEAD ~ log_gr_rel_ave, family = binomial(link = "logit"), data = dfa))
```

Best is no height

### Diameter
```{r}
AIC(glm(DEAD ~ log_gr_rel_ave*BAS_DIA_AVE, family = binomial(link = "logit"), data = dfa))
AIC(glm(DEAD ~ log_gr_rel_ave+BAS_DIA_AVE, family = binomial(link = "logit"), data = dfa))
AIC(glm(DEAD ~ log_gr_rel_ave, family = binomial(link = "logit"), data = dfa))
```

Best model has no height and no diameter

## Run the model
```{r}
GLM_abco <- glm(DEAD ~ log_gr_rel_ave, family = binomial(link = "logit"), data = dfa)
anova(GLM_abco, test = "Chi")
```

No significant difference.

# GLM for pipo

## Test whether to include height or the interaction with height and diameter

### Height
```{r}
AIC(glm(DEAD ~ log_gr_rel_ave*HEIGHT, family = binomial(link = "logit"), data = dfp))
AIC(glm(DEAD ~ log_gr_rel_ave+HEIGHT, family = binomial(link = "logit"), data = dfp))
AIC(glm(DEAD ~ log_gr_rel_ave, family = binomial(link = "logit"), data = dfp))

```

No height

### Diameter
```{r}
AIC(glm(DEAD ~ log_gr_rel_ave*BAS_DIA_AVE, family = binomial(link = "logit"), data = dfp %>% filter(!is.na(BAS_DIA_AVE))))
AIC(glm(DEAD ~ log_gr_rel_ave + BAS_DIA_AVE, family = binomial(link = "logit"), data = dfp %>% filter(!is.na(BAS_DIA_AVE))))
AIC(glm(DEAD ~ log_gr_rel_ave, family = binomial(link = "logit"), data = dfp %>% filter(!is.na(BAS_DIA_AVE))))
```

No diameter.

## Look at drop1
```{r}
GLM_pipo <- glm(DEAD ~ log_gr_rel_ave, family = binomial(link = "logit"), data = dfp)
summary(GLM_pipo)
anova(GLM_pipo, test = "Chi")
```

