---
title: "Analysis 4 - Seedling Growth by Species: ABCO"
author: "Carmen Tubbesing"
date: "3/1/2017"
output: html_document
---
- This is a based on some of what I learned in Analysis 2
    - for example, in terms of using VarPower
- Note: delete seedlings from PLKN and FRDS because there are not many ABCO in them
```{r, include=F}
setwd("~/Shrubs-Seedlings/Rdata")
load(file="master_data.Rdata")
library(nlme)
```

- Define function for calculating pseudo R^2
```{r}
pseudoR2_ABCO <- function(model){
  meanGrth <- mean(dfPinus$LastYearGrth.cm)
  sse <- (dfPinus$LastYearGrth.cm - predict(model))^2
  sst <- (dfPinus$LastYearGrth.cm - meanGrth)^2
  R2 <- 1 - (sum(sse)/sum(sst))
  return(R2)
}

```


```{r}
dfABCO <- df[df$Species=="ABCO" & !df$Fire %in% c("PLKN","FRDS"),]
```

- Whittling it down to the top 4 fires for ABCO leaves out only three ABCO:
```{r}
nrow(df[df$Species=="ABCO",])
nrow(dfABCO)
```

## Use GLS function varPower
```{r}
varPower <- varPower(form=~Ht.cm)
```

## Start out with the best model for PIPO and test similar models

```{r}

dfABCO$shrubarea <- dfABCO$Ht1.2*(dfABCO$Cov1.2)
ABCO.M1 <- gls(LastYearGrth.cm ~ Ht.cm + Ht.cm*Fire + shrubarea*Ht.cm+shrubarea+Fire,
                  weights = varPower,
                  data= dfABCO, method = "ML")
AIC(ABCO.M1)
summary(ABCO.M1)
anova(ABCO.M1, update(ABCO.M1, . ~ . - shrubarea-shrubarea*Ht))
summary(ABCO.M1)




table <- data.frame(model=character(), AIC=numeric(), stringsAsFactors=FALSE)

M1F.abco <- gls(LastYearGrth.cm ~ Ht.cm + Cov1.2 + BasDia.cm + Ht1.3 
                , weights = varPower,
                 data= dfABCO, method = "ML")

table[1,] <- c("M1F.abco", AIC(M1F.abco))

M2F.abco = update(M1F.abco, . ~ . - BasDia.cm)
anova(M1F.abco, M2F.abco)
table <- rbind(table, c("M2F.abco", AIC(M2F.abco)))

M3F.abco = update(M1F.abco, . ~ . + Fire*Ht.cm + Ht.cm*Ht1.3)
anova(M1F.abco, M3F.abco)
table <- rbind(table, c("M3F.abco", AIC(M3F.abco)))

M4F.abco = update(M3F.abco, . ~ . - Ht1.3*Ht.cm - Ht1.3 + Ht.cm)
anova(M3F.abco, M4F.abco)
table <- rbind(table, c("M4F.abco", AIC(M4F.abco)))

M5F.abco = update(M4F.abco, . ~ . - Cov1.2)
anova(M4F.abco, M5F.abco)
table <- rbind(table, c("M5F.abco", AIC(M5F.abco)))

M6F.abco = update(M3F.abco, . ~ . - Cov1.2 - Ht1.3*Ht.cm + Ht.cm)
anova(M3F.abco, M6F.abco)
table <- rbind(table, c("M6F.abco", AIC(M6F.abco)))

M7F.abco = update(M6F.abco, . ~ . - BasDia.cm)
anova(M6F.abco, M7F.abco)
table <- rbind(table, c("M7F.abco", AIC(M7F.abco)))

table

```

- The above shows that for ABCO, including shrub cover and shrub height appears to not help the model

## How do the residuals looks?
```{r}
E <- resid(M7F.abco, type="normalized")
coplot(E ~ Ht.cm | Fire, data=dfABCO, ylab="Normalized residuals", col=dfABCO$Fire)
```


## Try using shrubarea with ABCO

- The models with and without shrubarea are almost identical in AIC and logLik

## Plot with predict(fakedata)

```{r}
library(ggplot2)
Ht.cm <- c(rep(seq(0,150,length.out=61),4))
fakedata <- as.data.frame(Ht.cm)
fakedata$shrubarea <- c(rep(c( 44375,88750,133125,177500 ),61))
fakedata$Fire <- as.factor(rep("AMCR",244))
predicted <- predict(ABCO.M1, fakedata)

pred <- as.data.frame(predicted)
pred$shrubarea <- fakedata$shrubarea
pred$Ht.cm <- fakedata$Ht.cm
pred$Fire <- fakedata$Fire

dfAMCR <- subset(dfABCO, dfABCO$Fire=="AMCR")
dfCLVD <- subset(dfABCO, dfABCO$Fire=="CLVD")
dfSTAR <- subset(dfABCO, dfABCO$Fire=="STAR")
dfFRDS <- subset(dfABCO, dfABCO$Fire=="WRTS")

plotAMCR <- ggplot(pred[pred$Ht.cm<max(dfAMCR$Ht.cm) & pred$shrubarea<=max(dfAMCR$shrubarea) & pred$shrubarea>=min(dfAMCR$shrubarea),])+
  geom_line(aes(y= predicted ,group=shrubarea,x=Ht.cm,col=shrubarea))+
  scale_color_gradient(low="blue",high="red",limits=c(0,max(dfABCO$shrubarea)))+
  labs(title = "ABCO seedling growth ~ \nHt, shrub area, Am. Riv. Complex fire")+
  ylim(0,25)+
  xlim(0,125)+
  xlab("Seedling height (cm)")+
  ylab("Seedling growth (cm)")+
  geom_point(data=dfAMCR, aes(x=Ht.cm,y=LastYearGrth.cm,col=shrubarea))

plotAMCR

fakedata$Fire <- as.factor(rep("WRTS",244))
predicted <- predict(ABCO.M1, fakedata)

pred <- as.data.frame(predicted)
pred$shrubarea <- fakedata$shrubarea
pred$Ht.cm <- fakedata$Ht.cm
pred$Fire <- fakedata$Fire

plotWRTS <- ggplot(pred[pred$Ht.cm<max(dfFRDS$Ht.cm) & pred$shrubarea<=max(dfFRDS$shrubarea) & pred$shrubarea>=min(dfFRDS$shrubarea),])+
  geom_line(aes(y= predicted ,group=shrubarea,x=Ht.cm,col=shrubarea))+
  scale_color_gradient(low="blue",high="red",limits=c(0,max(dfABCO$shrubarea)))+
  labs(title = "ABCO seedling growth ~ \nHt, shrub area, Wrights Fire")+
  ylim(0,25)+
  xlim(0,225)+
  xlab("Seedling height (cm)") +
  ylab("Seedling growth (cm)")+
  geom_point(data=dfFRDS, aes(x=Ht.cm,y=LastYearGrth.cm,col=shrubarea))

plotWRTS

fakedata$Fire <- as.factor(rep("STAR",244))
predicted <- predict(ABCO.M1, fakedata)
pred <- as.data.frame(predicted)
pred$shrubarea <- fakedata$shrubarea
pred$Ht.cm <- fakedata$Ht.cm
pred$Fire <- fakedata$Fire

plotSTAR <- ggplot(pred[pred$Ht.cm<max(dfSTAR$Ht.cm) & pred$shrubarea<=max(dfSTAR$shrubarea) & pred$shrubarea>=min(dfSTAR$shrubarea),])+
  geom_line(aes(y= predicted ,group=shrubarea,x=Ht.cm,col=shrubarea))+
  scale_color_gradient(low="blue",high="red", limits=c(0,max(dfABCO$shrubarea)))+
  labs(title = "ABCO seedling growth ~ \nHt, shrub area, Star Fire")+
  ylim(0,25)+
  xlim(0,150)+
  xlab("Seedling height (cm)") +
  ylab("Seedling growth (cm)")+
  geom_point(data=dfSTAR, aes(x=Ht.cm,y=LastYearGrth.cm,col=shrubarea))
plotSTAR

fakedata$Fire <- as.factor(rep("CLVD",244))
predicted <- predict(ABCO.M1, fakedata)
pred <- as.data.frame(predicted)
pred$shrubarea <- fakedata$shrubarea
pred$Ht.cm <- fakedata$Ht.cm
pred$Fire <- fakedata$Fire

plotCLVD <- ggplot(pred[pred$Ht.cm<max(dfCLVD$Ht.cm) & pred$shrubarea<=max(dfCLVD$shrubarea) & pred$shrubarea>=min(dfCLVD$shrubarea),])+
  geom_line(aes(y= predicted ,group=shrubarea,x=Ht.cm,col=shrubarea))+
  scale_color_gradient(low="blue",high="red",limits=c(0,max(dfABCO$shrubarea)))+
  labs(title = "ABCO seedling growth ~ \nHt, shrub area, Cleveland Fire")+
  ylim(0,25)+
  xlim(0,150)+
  xlab("Seedling height (cm)") +
  ylab("Seedling growth (cm)")+
  geom_point(data=dfCLVD, aes(x=Ht.cm,y=LastYearGrth.cm,col=shrubarea))

plotCLVD
require(gridExtra)
all.fires <- grid.arrange(plotAMCR, plotWRTS,plotSTAR,plotCLVD,nrow=2,ncol=2 )
all.fires
```

## What happens if you analyze AMCR data alone and remove fire effect?

- Note: I removed an outlier from the AMCR data

```{r}
ABCO.M1 <- gls(LastYearGrth.cm ~ Ht.cm + Ht.cm*Fire + shrubarea*Ht.cm + shrubarea + Fire,
                  weights = varPower,
                  data= dfABCO, method = "ML")
AIC(ABCO.M1)
AIC(update(ABCO.M1, . ~ . - Fire - Fire*Ht.cm))

ABCO.AMCR <- gls(LastYearGrth.cm ~ Ht.cm + shrubarea*Ht.cm + shrubarea,
                  weights = varPower,
                  data= dfAMCR[dfAMCR$Ht.cm<100,], method = "ML")

predicted <- predict(ABCO.AMCR, fakedata)

pred <- as.data.frame(predicted)
pred$shrubarea <- fakedata$shrubarea
pred$Ht.cm <- fakedata$Ht.cm
pred$Fire <- fakedata$Fire

plotAMCR.2 <-ggplot(pred[pred$Ht.cm<max(dfAMCR$Ht.cm) & pred$shrubarea<=max(dfAMCR$shrubarea) & pred$shrubarea>=min(dfAMCR$shrubarea),])+
  geom_line(aes(y= predicted ,group=shrubarea,x=Ht.cm,col=shrubarea))+
  scale_color_gradient(low="blue",high="red",limits=c(0,max(dfABCO$shrubarea)))+
  labs(title = "ABCO seedling growth ~ \nHt, shrub area, Am. Riv. Complex only model")+
  ylim(0,25)+
  xlim(0,125)+
  xlab("Seedling height (cm)")+
  ylab("Seedling growth (cm)")+
  geom_point(data=dfAMCR, aes(x=Ht.cm,y=LastYearGrth.cm,col=shrubarea))
plotAMCR.2

AMCR.compare <- grid.arrange(plotAMCR,plotAMCR.2,nrow=2,ncol=2)

```

- Answer: It's important.