---
title: "Shrub_growth_analysis"
author: "Carmen"
date: "January 16, 2020"
output: 
  html_document:
    toc: TRUE
---

# Load data
```{r, include = F}
require(tidyverse)
require(effects)
require(mgcv)
require(gridExtra)
load(file = "~/Shrubs-Seedlings/compiled_data/shrub_growth/all_combined.Rdata")
```

# Model for each shrub species

## CECO
```{r}
dfCECO <- df %>% filter(Shrub_species == "CECO")
```

```{r}
ggplot(dfCECO, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source))+
  geom_smooth(method = "lm", formula = y ~ x + poly(x, 3))+
  theme_bw()
```

```{r}
lmCECO <- lm(modal_ht_cm ~ poly(years_since_fire, 2), data = dfCECO)
summary(lmCECO)
dfCECO$pred <- predict(lmCECO)
```

```{r}
gamCECO <- gam(modal_ht_cm ~ s(years_since_fire, k = 4, bs = "cr"), data = dfCECO)
summary(gamCECO)
predCECO <- predict.gam(gamCECO, se =T, type = "response")
dfCECO <- dfCECO %>% 
  mutate(predGAM = predCECO$fit) %>% 
  mutate(predGAMseL = predGAM - predCECO$se.fit) %>% 
  mutate(predGAMseU = predGAM + predCECO$se.fit)
```

```{r}
ggplot(dfCECO)+
  geom_point(aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(x = years_since_fire, y = predGAM), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseL), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseU), col = "purple")
```

### Make fake data to make the plot lines smoother
```{r}
x <- seq(0.5, 45, .5)
fake <- data.frame(years_since_fire = x)
preddf = predict.gam(gamCECO, newdata = fake, se =T)
fake <- fake %>% 
  mutate(pred = preddf$fit) %>% 
  mutate(predseL = pred - preddf$se.fit) %>% 
  mutate(predseU = pred + preddf$se.fit)
```

### Pretty plot
```{r}
ceco_plot <- ggplot()+
  geom_point(data = dfCECO, aes(x = years_since_fire, y = modal_ht_cm), alpha = .3)+
  geom_line(data = fake, aes(x = years_since_fire, y = pred))+
  geom_ribbon(data = fake, aes(x = years_since_fire, ymin = predseL, ymax = predseU), fill = "royal blue",   alpha = .2)+
  theme_minimal()+
  ggtitle("CECO")
ceco_plot
```

## ARPA/ARVI (Manzanita)
```{r}
dfARPA <- df %>% filter(Shrub_species == "ARPA6_ARVI")
```

```{r}
ggplot(dfARPA, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source))+
  geom_smooth(method = "lm", formula = y ~ x + poly(x, 3))+
  theme_bw()
```

```{r}
lmARPA <- lm(modal_ht_cm ~ poly(years_since_fire, 2), data = dfARPA)
summary(lmARPA)
dfARPA$pred <- predict(lmARPA)
```

```{r}
gamARPA <- gam(modal_ht_cm ~ s(years_since_fire, k = 4, bs = "cr"), data = dfARPA)
summary(gamARPA)
predARPA <- predict.gam(gamARPA, se =T, type = "response")
dfARPA <- dfARPA %>% 
  mutate(predGAM = predARPA$fit) %>% 
  mutate(predGAMseL = predGAM - predARPA$se.fit) %>% 
  mutate(predGAMseU = predGAM + predARPA$se.fit)
```

```{r}
ggplot(dfARPA)+
  geom_point(aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(x = years_since_fire, y = predGAM), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseL), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseU), col = "purple")
```

### Make fake data to make the plot lines smoother
```{r}
x <- seq(0.5, 45, .5)
fake <- data.frame(years_since_fire = x)
preddf = predict.gam(gamARPA, newdata = fake, se =T)
fake <- fake %>% 
  mutate(pred = preddf$fit) %>% 
  mutate(predseL = pred - preddf$se.fit) %>% 
  mutate(predseU = pred + preddf$se.fit)
```

### Pretty plot
```{r}
arpa_plot <- ggplot()+
  geom_point(data = dfARPA, aes(x = years_since_fire, y = modal_ht_cm), alpha = .2)+
  geom_line(data = fake, aes(x = years_since_fire, y = pred))+
  geom_ribbon(data = fake, aes(x = years_since_fire, ymin = predseL, ymax = predseU), fill = "purple",   alpha = .3)+
  theme_minimal()+
  ggtitle("ARPA and ARVI")
arpa_plot
```


## CEIN
```{r}
dfCEIN <- df %>% filter(Shrub_species == "CEIN3")
```

### Plot using polynomial formula in ggplot

```{r}
ggplot(dfCEIN, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source))+
  geom_smooth(method = "lm", formula = y ~ x + poly(x, 3))+
  theme_bw()
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_spp.png", width = 10)
```

```{r}
lmCEIN <- lm(modal_ht_cm ~ poly(years_since_fire, 2), data = dfCEIN)
summary(lmCEIN)
dfCEIN$pred <- predict(lmCEIN)
```

```{r}
gamCEIN <- gam(modal_ht_cm ~ s(years_since_fire, k = 4, bs = "cr"), data = dfCEIN)
summary(gamCEIN)
predCEIN <- predict.gam(gamCEIN, se =T, type = "response")
dfCEIN <- dfCEIN %>% 
  mutate(predGAM = predCEIN$fit) %>% 
  mutate(predGAMseL = predGAM - predCEIN$se.fit) %>% 
  mutate(predGAMseU = predGAM + predCEIN$se.fit)
```

```{r}
ggplot(dfCEIN)+
  geom_point(aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(x = years_since_fire, y = predGAM), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseL), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseU), col = "purple")
```

### Make fake data to make the plot lines smoother
```{r}
x <- seq(0.5, 45, .5)
fake <- data.frame(years_since_fire = x)
preddf = predict.gam(gamCEIN, newdata = fake, se =T)
fake <- fake %>% 
  mutate(pred = preddf$fit) %>% 
  mutate(predseL = pred - preddf$se.fit) %>% 
  mutate(predseU = pred + preddf$se.fit)
```

### Pretty plot
```{r}
cein_plot <- ggplot()+
  geom_point(data = dfCEIN, aes(x = years_since_fire, y = modal_ht_cm), alpha = .2)+
  geom_line(data = fake, aes(x = years_since_fire, y = pred))+
  geom_ribbon(data = fake, aes(x = years_since_fire, ymin = predseL, ymax = predseU), fill = 2,   alpha = .3)+
  theme_minimal()+
  ggtitle("CEIN")
cein_plot  
```

## CHSE

```{r}
dfCHSE <- df %>% filter(Shrub_species == "CHSE11")
```

```{r}
ggplot(dfCHSE, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source))+
  geom_smooth(method = "lm", formula = y ~ x + poly(x, 3))+
  theme_bw()
```

### Take out the wacky outlier
```{r}
dfCHSE <- dfCHSE %>% 
  filter(modal_ht_cm<300)
```

```{r}
lmCHSE <- lm(modal_ht_cm ~ poly(years_since_fire, 2), data = dfCHSE)
summary(lmCHSE)
dfCHSE$pred <- predict(lmCHSE)
```

```{r}
gamCHSE <- gam(modal_ht_cm ~ s(years_since_fire, k = 4, bs = "cr"), data = dfCHSE)
summary(gamCHSE)
predCHSE <- predict.gam(gamCHSE, se =T, type = "response")
dfCHSE <- dfCHSE %>% 
  mutate(predGAM = predCHSE$fit) %>% 
  mutate(predGAMseL = predGAM - predCHSE$se.fit) %>% 
  mutate(predGAMseU = predGAM + predCHSE$se.fit)
```

```{r}
ggplot(dfCHSE)+
  geom_point(aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(x = years_since_fire, y = predGAM), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseL), col = "purple")+
  geom_line(aes(x = years_since_fire, y = predGAMseU), col = "purple")
```

### Make fake data to make the plot lines smoother
```{r}
x <- seq(0.5, 45, .5)
fake <- data.frame(years_since_fire = x)
preddf = predict.gam(gamCHSE, newdata = fake, se =T)
fake <- fake %>% 
  mutate(pred = preddf$fit) %>% 
  mutate(predseL = pred - preddf$se.fit) %>% 
  mutate(predseU = pred + preddf$se.fit)
```

### Pretty plot
```{r}
chse_plot <- ggplot()+
  geom_point(data = dfCHSE, aes(x = years_since_fire, y = modal_ht_cm), alpha = .2)+
  geom_line(data = fake, aes(x = years_since_fire, y = pred))+
  geom_ribbon(data = fake, aes(x = years_since_fire, ymin = predseL, ymax = predseU), fill =11,   alpha = .3)+
  theme_minimal()+
  ggtitle("CHSE")
chse_plot
```

# Plot the 4 species together
```{r}
grid.arrange(ceco_plot, arpa_plot, chse_plot, cein_plot)
final_plot <- arrangeGrob(ceco_plot, arpa_plot, chse_plot, cein_plot, nrow = 2, ncol = 2)
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/gam_4_spp.png", final_plot, width = 10)
```

# Save the models to use in the simulation
```{r}
save(gamCECO, file = "~/Shrubs-Seedlings/results/coefficients/gamCECO.Rdata")
save(gamARPA, file = "~/Shrubs-Seedlings/results/coefficients/gamARPA.Rdata")
save(gamCEIN, file = "~/Shrubs-Seedlings/results/coefficients/gamCEIN.Rdata")
save(gamCHSE, file = "~/Shrubs-Seedlings/results/coefficients/gamCHSE.Rdata")
```

