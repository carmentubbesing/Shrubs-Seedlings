---
title: "Combine_shrub_data"
author: "Carmen"
date: "January 3, 2020"
output: 
  html_document:
    toc: TRUE
---

```{r, include=FALSE}
require(tidyverse)
```

# Load data

## Data from others
```{r}
load("~/Shrubs-Seedlings/compiled_data/shrub_growth/Latimer_df.Rdata")
latimer <- df
remove(df)
load("~/Shrubs-Seedlings/compiled_data/shrub_growth/Young_df.Rdata")
young <- df
remove(df)
load("~/Shrubs-Seedlings/compiled_data/shrub_growth/Welch_df.Rdata")
welch <- df
remove(df)
```

## Data from my fire footprints
```{r}
load("~/Shrubs-Seedlings/compiled_data/shrub_growth/My_FireFootprint_data.Rdata")
me <- ht_by_spp
```

# Sync column names

## Latimer
```{r}
latimer <- latimer %>% 
  mutate(Year_meas = 2018) %>% 
  rename(Year.of.Fire = fire_year, Date = SurveyDate) %>% 
  dplyr::select(Fire, FireSev, years_since_fire, Year_meas, Year.of.Fire, Shrub_species, shrub_ht) %>% 
  rename(ShrubHt = shrub_ht)
```

## Young
```{r}
young <- young %>% 
  rename(Shrub_species = dominant_shrub_1) %>% 
  rename(ShrubHt = dominant_shrub_ht_cm, FireSev = FIRE_SEV) %>% 
  dplyr::select(-Date)
```

## Welch
```{r}
welch <- welch %>% 
  rename(fire_year = `Year of Fire`, FireSev = FIRE_SEV) %>% 
  dplyr::select(-seed_tree_dist_m)
```

# Add column for df_source
```{r}
young$df_source = "young"
latimer$df_source = "latimer"
welch$df_source = "welch"
me$df_source = "me"
```

# Remove rows in young that are already in welch
```{r}
young <- anti_join(young, welch, by = c("Year_meas", "Regen_Plot"))
```

# Join
```{r}
df <- full_join(young, latimer)
```

```{r}
df <- df %>% 
  rename(modal_ht_cm = ShrubHt, fire_year = Year.of.Fire)
```

```{r}
sort(names(df))
sort(names(welch))
```

```{r}
df <- full_join(df, welch)
```

## Check
```{r}
nrow(latimer) + nrow(welch) + nrow(young) == nrow(df)
```

```{r}
summary(as.factor(df$df_source))
```

# Clean

## Sync shrub species names
```{r}
df <- df %>% 
  mutate(Shrub_species = 
           case_when(Shrub_species == "ARCPAT" ~ "ARPA6",
                     Shrub_species == "ARCVIS" ~ "ARVI",
                     Shrub_species == "CEACOR" ~ "CECO",
                     Shrub_species == "CEAPRO" ~ "CEPR",
                     Shrub_species == "CEAINT" ~ "CEIN3",
                     Shrub_species == "CEINT" ~ "CEIN3",
                     Shrub_species == "CHAFOL" ~ "CHFO",
                     Shrub_species == "CHRSEM" ~ "CHSE11",
                     Shrub_species == "QUEVAC" ~ "QUVA",
                     Shrub_species == "SYMMOL" ~ "SYMO",
                     Shrub_species == "RIBCER" ~ "RIBES",
                     Shrub_species == "RIRO" ~ "RIBES",
                     TRUE ~ Shrub_species))
```

```{r}
summary(as.factor(df$Shrub_species))
```

## Check for same plot, same year
```{r}
summary(as.factor(latimer$years_since_fire))
summary(as.factor(young$years_since_fire))
```

```{r}
summary(as.factor(latimer$Fire))
summary(as.factor(young$Fire))
```

```{r}
young %>% 
  filter(years_since_fire %in% latimer$years_since_fire & Fire %in% c("AMERICAN RIVER", "MOONLIGHT", "POWER"))
```

All good!

# Plot for all species together
```{r}
ggplot(df, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point()+
  geom_smooth(method = "loess", span = 1)
```

## Sooo I should take out the oldest fire, Cottonwood, which Derek mentioned is at the sagebrush ecotone so not a good comparison
```{r}
df <- df %>% 
  filter(years_since_fire<24)
```

# Plot for all species together again
```{r}
ggplot(df, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point()+
  geom_smooth(method = "loess", span = 1)
```

# Add data from fire footprints
```{r}
me <- me %>% 
  dplyr::select(Fire, years_since_fire, Year_meas, Shrub_species, modal_ht_cm, df_source)
```

```{r}
nrow_pre <- nrow(df) 
df <- full_join(df, me)
nrow(df) == nrow_pre + nrow(me)
```

# Sync species names
```{r}
summary(as.factor(df$Shrub_species))

df <- df %>% 
  mutate(Shrub_species = 
           case_when(Shrub_species == "ARPA" ~ "ARPA6",
                     Shrub_species == "CEIN" ~ "CEIN3",
                     Shrub_species == "CHSE" ~ "CHSE11",
                     TRUE ~ Shrub_species))
```


# Plot for all species together again
```{r}
ggplot(df, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point()+
  geom_smooth(method = "loess", span = 1)
```

# Plot just for ARVI and ARPA
```{r}
ggplot(df %>% filter(Shrub_species %in% c("ARVI", "ARPA6")), aes(x = years_since_fire, y = modal_ht_cm, col = Shrub_species))+
  geom_point()+
    geom_smooth(method = "loess")
```

# Lump ARVI and ARPA
```{r}
df <- df %>% 
  mutate(Shrub_species = 
           case_when(Shrub_species == "ARPA6" ~ "ARPA6_ARVI",
                     Shrub_species == "ARVI" ~ "ARPA6_ARVI",
                     TRUE ~ Shrub_species))
```

# Plot for manzanita, whitethorn, and deerbrush
```{r}
ggplot(df %>% 
         filter(Shrub_species %in% c("ARPA6_ARVI", "CEIN3", "CECO")),
       aes(x = years_since_fire, y = modal_ht_cm, col = Shrub_species))+
  geom_point(aes(shape = df_source))+
  geom_smooth(method = "loess", span = 1)+
  theme_bw()
```


# Plot for manzanita, whitethorn, and deerbrush
```{r}
ggplot(df %>% 
         filter(Shrub_species %in% c("ARPA6_ARVI", "CEIN3", "CECO")),
       aes(x = years_since_fire, y = modal_ht_cm, col = Shrub_species))+
  geom_point(aes(shape = df_source))+
  geom_smooth(method = "loess", span = 1)+
  theme_bw()
```

# Plot for all species that are in my data and have at least 5 years of data
```{r}
over7years <- df %>% 
  select(Shrub_species, years_since_fire) %>% 
  distinct() %>% 
  group_by(Shrub_species) %>% 
  summarize(count = n()) %>% 
  filter(count > 7) %>% 
  filter(Shrub_species != "none")
over7years
```

```{r}
focal_spp <- df %>% 
  filter(df_source == "me") %>% 
  dplyr::select(Shrub_species) %>% 
  distinct()
focal_spp
```

```{r}
df_plot <- df %>% 
  filter(Shrub_species %in% over7years$Shrub_species & Shrub_species %in% focal_spp$Shrub_species)
unique(df_plot$Shrub_species)
df_plot <- droplevels(df_plot)
```

```{r}
ggplot(df_plot, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source, col = Fire))+
  geom_smooth(method = "loess", span = 1)+
  facet_wrap(~Shrub_species, ncol = 2)+
  theme_bw()+
  guides(guide_legend(ncol = 3))
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_spp.png", width = 10)
```


# SUPPLEMENT FIG: Plot for all species that are in my data 

```{r}
focal_spp <- df %>% 
  filter(df_source == "me") %>% 
  dplyr::select(Shrub_species) %>% 
  distinct()
focal_spp
```

```{r}
df_plot <- df %>% 
  filter(Shrub_species %in% focal_spp$Shrub_species) %>% 
  mutate(Shrub_species = ifelse(Shrub_species %in% c("CECO", "CEIN3", "ARPA6_ARVI", "CHFO"), Shrub_species, "Other"))
unique(df_plot$Shrub_species)
df_plot <- droplevels(df_plot)
```

```{r}
ggplot(df_plot, aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source, col = Fire))+
  theme_minimal()+
  ylab("Shrub height (cm)")+
  xlab("Years since fire")+
  guides(color = guide_legend(ncol = 3))

ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_spp_paper_Feb27.png", width = 10, height = 6)
```


# Plot for each of those 4 shrubs separately

## CECO
```{r}
ggplot(df_plot %>% filter(Shrub_species == "CECO"), aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source, col = Fire))+
  geom_smooth(method = "loess", span = 1)+
  facet_wrap(~Shrub_species, ncol = 2)+
  theme_bw()
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_ceco.png", width = 10)
```

## ARPA
```{r}
ggplot(df_plot %>% filter(Shrub_species == "ARPA6_ARVI"), aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source, col = Fire))+
  geom_smooth(method = "loess", span = 1)+
  facet_wrap(~Shrub_species, ncol = 2)+
  theme_bw()
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_arpa.png", width = 10)
```

## CEIN
```{r}
ggplot(df_plot %>% filter(Shrub_species == "CEIN3"), aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source, col = Fire))+
  geom_smooth(method = "loess", span = 1)+
  facet_wrap(~Shrub_species, ncol = 2)+
  theme_bw()
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_cein.png", width = 10)
```

## CHSE
```{r}
ggplot(df_plot %>% filter(Shrub_species == "CHSE11"), aes(x = years_since_fire, y = modal_ht_cm))+
  geom_point(aes(shape = df_source, col = Fire))+
  geom_smooth(method = "loess", span = 1)+
  facet_wrap(~Shrub_species, ncol = 2)+
  theme_bw()
ggsave("~/Shrubs-Seedlings/results/figures/Shrub_growth_time/shrub_ht_chse.png", width = 10)
```


# Save combined data
```{r}
save(df, file = "~/Shrubs-Seedlings/compiled_data/shrub_growth/all_combined_HEIGHT.Rdata")
```

# Find rows with NA shrub ht
```{r}
df %>% filter(is.na(modal_ht_cm)) %>% count(df_source)
```

# Find rows with NA years since fire
```{r}
df %>% filter(is.na(years_since_fire)) %>% count(df_source)
```
